<script type="text/x-red" data-template-name="FileOut">
    <!-- File Path -->
    
    <div id="node-input-file-path-wrp" class="editor-form-row">
        <label for="node-input-file-path"><span
                data-i18n="common.label.filepath"></span></label>
        <input type="text" id="node-input-file-path" class="node-input-property" style="width: 100%" />
    </div>
    <!-- resultMapping -->
    <div id="node-input-result-mapping-wrp" class="editor-form-row">
        <label for="node-input-result-mapping"><span
                data-i18n="common.label.filemapping"></span></label>
        <input type="text" id="node-input-result-mapping" class="node-input-property" style="width: 100%" />
    </div>
    <div class="form-row padding-bottom-1">
        <input id="node-input-createDir" type="checkbox">
    </div>
    <div class="form-row padding-bottom-1">
        <input id="node-input-overwriteFile" type="checkbox">
    </div>
    <div class="form-row padding-bottom-1">
        <input id="node-input-isStreaming" type="checkbox">
    </div>
    <div class="form-row padding-bottom-1 append-eol-selector">
        <input id="node-input-appendNewline" type="checkbox">
    </div>   
    <!-- Encoding -->
    <div class="editor-form-row">
        <label for="node-select-filein-encoding"><span data-i18n="filein.label.encoding"></span></label>
        <select id="node-select-filein-encoding" style="width: 100%; margin-bottom: 1em">
        </select>
    </div>
</script>

<script type="text/javascript">
    registerNode({
        nodeType: 'FileOut',
        serviceType: 'server',
        nodeDef: {
            color: "#a0855b",
            category: 'File Operation',
            defaults: {
                name: {
                    value: ''
                },
                encoding: {
                    value: 'utf8'
                },
                outputs: {
                    value: 1
                },
                appendNewline: { value: false},
                createDir: { value: false},
                overwriteFile: { value: false},
                isStreaming: {value: false},
                filepath: { value: '' , required: true },
                resultMapping: { value: { type: 'bh.input', value: '' } , required: true }
            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-file/file-out-node.svg",
            paletteLabel: function (def) {
                return 'File Out';
            },
            label: function () {
                return this.name || 'File Out'
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function (SRD) {
                const node = this;
                const doneBtn = $('#node-dialog-ok');
                const commonTypes = ['bh', 'bh.input', 'bh.local']
                const kvSpecificTypes = [{ value: 'str', label: 'string', validate: /[^\s]+/ }];

                /* Select the type of encoding. */
                var data = SRD._('common.encoding');
                const encoding = $('#node-select-filein-encoding').selectField({
                    optionsgroupData:  JSON.parse(data.replace(/'/g,'"')),
                    value: node.encoding,
                });
                const filepath = $('#node-input-file-path').typedInput({
					types: [...commonTypes, ...kvSpecificTypes],
                    noformvalidation: false
                });

                /* Result Mapping field */
                const resultMapping = $('#node-input-result-mapping').typedInput({
					types: commonTypes,
                    noformvalidation: false
                });

                $('#node-input-isStreaming').toggleButton({
                    label: 'Streaming',
                    inputId: 'isStreaming',
                    afterToggle: value => {
                        if (value) {
                            $('.append-eol-selector').hide();
                        } else {
                            $('.append-eol-selector').show();
                        }
                    }
                });

                $('#node-input-appendNewline').toggleButton({
                    label: 'Append EOL',
                    inputId: 'appendNewline'
                });
                $('#node-input-createDir').toggleButton({
                    label: 'Create Directory',
                    inputId: 'createDir'
                });
                $('#node-input-overwriteFile').toggleButton({
                    label: 'Overwrite',
                    inputId: 'overwriteFile'
                });
                /* Set values for key and value fields if already exists */
                if (node.resultMapping.value) {
                    resultMapping.typedInput('type', node.resultMapping.type);
                    resultMapping.typedInput('value', node.resultMapping.value);
                }
                if (node.filepath) {
                    filepath.typedInput('type', node.filepath.type);
                    filepath.typedInput('value', node.filepath.value);
                }
            },
            oneditsave: function () {
                const node = this;
                const filepath = $('#node-input-file-path');
                const resMap = $('#node-input-result-mapping');
                node.name = $('#node-input-name').val();
                
                
                node.filepath = { type: filepath.typedInput('type'), value: filepath.typedInput('value') };
                node.encoding = $('#node-select-filein-encoding').val();
                node.resultMapping = { type: resMap.typedInput('type'), value: resMap.typedInput('value') };
            },
            docsLink: 'file-out-node'
        }
    });
</script>