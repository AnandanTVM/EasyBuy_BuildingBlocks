// TODO: @sankarshanaj - set "docsLink" property
<script type="text/x-red" data-template-name="ad-config">
    
    <!-- name -->
    <div class="editor-form-row">
        <input type="text" id="node-input-name">
    </div>

    <!-- url -->
    <div class="editor-form-row">
        <label for="node-input-url"><span data-i18n="adconfig.label.url"></span></label>
        <input type="text" id="node-input-url" class="node-input-property" style="width: 100%">
    </div>

    <!-- Base DN -->
    <div class="editor-form-row">
        <label for="node-input-baseDN"><span data-i18n="adconfig.label.basedn"></span></label>
        <input type="text" id="node-input-baseDN" class="node-input-property" style="width: 100%">
    </div>

    <!-- Username Postfix -->
    <div class="editor-form-row">
        <label for="node-input-usrpostfix"><span data-i18n="adconfig.label.usrpostfix"></span></label>
        <input type="text" id="node-input-usrpostfix" class="node-input-property" style="width: 100%">
    </div>

    <!-- Username Prefix -->
    <div class="editor-form-row">
        <label for="node-input-usrprefix"><span data-i18n="adconfig.label.usrprefix"></span></label>
        <input type="text" id="node-input-usrprefix" class="node-input-property" style="width: 100%">
    </div>

    <!-- Admin Username -->
    <div class="editor-form-row">
        <label for="node-input-username"><span
            data-i18n="adconfig.label.adminuser"></span></label>
        <input type="text" id="node-input-username" class="node-input-property" style="width: 100%">
    </div>

    <!-- Admin Password -->
    <div class="editor-form-row">
        <label for="node-input-password"><span
            data-i18n="adconfig.label.adminpwd"></span></label>
        <input type="password" id="node-input-password" class="node-input-property" style="width: 100%">
    </div>
</script>

<script type="text/javascript">

    registerNode({
        nodeType: 'ad-config',
        serviceType: 'server',
        nodeDef: {
            category: 'config',
            color: '#009978',
            defaults: {
                name: { value: "" },
                url: { value: "", required: true },
                urlMappingObj: { value: {} },
                baseDN: { value: "", required: true },
                baseDNMappingObj: { value: {} },
                usrpostfix: { value: "" },
                usrpostfixMappingObj: { value: {} },
                usrprefix: { value: "" },
                usrprefixMappingObj: { value: {} },
                username: { value: "", required: true },
                usernameMappingObj: { value: {} },
                password: { value: "", required: true },
                passwordMappingObj: { value: {} },
            },
            inputs: 1,
            outputs: 1,
            icon: "",
            paletteLabel: 'Active Directory',
            label: function () {
                return this.name || "ad-config";
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function (SRD) {
                const node = this;
                const doneBtn = $('#node-config-dialog-ok');
                const requiredTypes = [
                    {
                        value: 'str',
                        label: 'string',
                        validate: SRD.validators.typedInput('str', true)
                    },
                    {
                        value: 'process.env',
                        label: 'env',
                        validate: SRD.validators.typedInput('env', true)
                    }
				];
				const optionalTypes = ['str', { value: 'process.env', label: 'env', validate: SRD.validators.typedInput('env') }];
                let nodeName = $(`#node-input-name`).inputField({
                    placeholder: SRD._('common.label.name')
                });

                let nodeurl = $(`#node-input-url`).typedInput({ types: requiredTypes, noformvalidation: false });
                updateTypedInputValue(nodeurl, 'urlMappingObj');

                let nodebasedn = $(`#node-input-baseDN`).typedInput({ types: requiredTypes, noformvalidation: false });
                updateTypedInputValue(nodebasedn, 'baseDNMappingObj');

                let nodeusrpostfix = $(`#node-input-usrpostfix`).typedInput({ types: optionalTypes});
                updateTypedInputValue(nodeusrpostfix, 'usrpostfixMappingObj');

                let nodeusrprefix = $(`#node-input-usrprefix`).typedInput({ types: optionalTypes});
                updateTypedInputValue(nodeusrprefix, 'usrprefixMappingObj');

                function updateTypedInputValue(typedInputEle, mappingObj) {
                    if (node[mappingObj] && node[mappingObj].hasOwnProperty('mapVarType')) {
                        typedInputEle.typedInput('type', node[mappingObj].mapVarType);
                        typedInputEle.typedInput('value', node[mappingObj].mapVarValue)
                    }
                }
                const usernameMapping = $('#node-input-username').typedInput({ types: requiredTypes, noformvalidation: false });
                updateTypedInputValue(usernameMapping, 'usernameMappingObj')

                const passwordMapping = $('#node-input-password').typedInput({ types: requiredTypes, noformvalidation: false });
                updateTypedInputValue(passwordMapping, 'passwordMappingObj');
            },
            oneditsave: function () {

                const node = this;
                function updateMappingValue(id, mapVarObj) {
                    const mapVarType = $(`#${id}`).typedInput('type');
                    const mapVarValue = $(`#${id}`).typedInput('value');
                    node[mapVarObj] = node[mapVarObj] ? node[mapVarObj] : {}
                    node[mapVarObj]['mapVarType'] = mapVarType;
                    node[mapVarObj]['mapVarValue'] = mapVarValue;
                }

                updateMappingValue('node-input-username', 'usernameMappingObj');
                updateMappingValue('node-input-password', 'passwordMappingObj');
                updateMappingValue('node-input-url', 'urlMappingObj');
                updateMappingValue('node-input-baseDN', 'baseDNMappingObj');
                updateMappingValue('node-input-usrpostfix', 'usrpostfixMappingObj');
                updateMappingValue('node-input-usrprefix', 'usrprefixMappingObj');
            }
        }
    })
    
</script>