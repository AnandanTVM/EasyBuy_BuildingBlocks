<script type="text/x-red" data-template-name="ActiveDirectory">
<div class="editor-form-row">
    <label for="node-input-adconfig" style="width: auto" data-i18n="activedirectory.label.adConfigId"></label>
    <div id="node-row-ad">
        <input type="text" style="width: auto" id="node-input-adconfig">
    </div>
</div>

<!-- Type of operation -->
<div class="editor-form-row">
    <label for="node-select-activeDirectory-operation"><span data-i18n="common.label.operation-type"></span></label>
    <select id="node-select-activeDirectory-operation" style="width: 100%;"></select>
</div>

<!-- username -->
<div id="node-input-activeDirectory-username-wrp" class="editor-form-row">
    <label for="node-input-activeDirectory-username"><span data-i18n="common.label.username"></span></label>
    <input type="text" id="node-input-activeDirectory-username" class="node-input-property" style="width: 100%">
</div>
<!-- password-->
<div id="node-input-activeDirectory-password-wrp" class="editor-form-row">
    <label for="node-input-activeDirectory-password"><span data-i18n="common.label.password"></span></label>
    <input type="text" id="node-input-activeDirectory-password" class="node-input-property" style="width: 100%">
</div>
<!-- accname-->
<div id="node-input-activeDirectory-accname-wrp" class="editor-form-row">
    <label for="node-input-activeDirectory-accname"><span data-i18n="activedirectory.label.accname"></span></label>
    <input type="text" id="node-input-activeDirectory-accname" class="node-input-property" style="width: 100%">
</div>
<!-- groupName -->
<div id="node-input-activeDirectory-groupName-wrp" class="editor-form-row">
    <label for="node-input-activeDirectory-groupName"><span data-i18n="activedirectory.label.groupName"></span></label>
    <input type="text" id="node-input-activeDirectory-groupName" class="node-input-property" style="width: 100%" />
</div>
<!-- query -->
<div id="node-input-activeDirectory-query-wrp" class="editor-form-row">
    <label for="node-input-activeDirectory-query"><span data-i18n="activedirectory.label.query"></span></label>
    <input type="text" id="node-input-activeDirectory-query" class="node-input-property" style="width: 100%" />
</div>
<!-- options -->
<div id="node-input-activeDirectory-options-wrp" class="editor-form-row">
    <label for="node-input-activeDirectory-options"><span data-i18n="activedirectory.label.options"></span></label>
    <input type="text" id="node-input-activeDirectory-options" class="node-input-property" style="width: 100%" />
</div>
<!-- resultMapping -->
<div id="node-input-result-mapping-wrp" class="editor-form-row">
    <label for="node-input-result-mapping"><span data-i18n="common.label.result-mapping"></span></label>
    <input type="text" id="node-input-result-mapping" class="node-input-property" style="width: 100%" />
</div>
</script>



<script type="text/javascript">
    registerNode({
        nodeType: 'ActiveDirectory',
        serviceType: 'server',
        nodeDef: {
            color: "#ab7e87",
            category: 'Auth',
            defaults: {
                name: {
                    value: ''
                },
                operationType: {
                    value: 'authenticate'
                },
                outputs: {
                    value: 1
                },
                username: {
                    value: {
                        type: '',
                        value: ''
                    }
                },
                password: {
                    value: {
                        type: '',
                        value: ''
                    }
                },
                sAMAAccountName: {
                    value: {
                        type: '',
                        value: ''
                    }
                },
                groupName: {
                    value: {
                        type: '',
                        value: ''
                    }
                },
                query: {
                    value: {
                        type: '',
                        value: ''
                    }
                },
                options: {
                    value: {
                        type: '',
                        value: ''
                    }
                },
                resultMapping: { value: { type: 'bh.local', value: '' } },
                adconfig: { type: "ad-config", required: true }

            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-active-directory/ndefault-active-directory.svg",
            paletteLabel: function (def) {
                return 'Active Directory';
            },
            label: function () {
                return this.name || 'Active Directory';
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function (SRD) {
                const node = this;
                const doneBtn = $('#node-dialog-ok');
                const commonTypes = ['bh', 'bh.input', 'bh.local'];
                const kvSpecificTypes = [{
                    value: 'str',
                    label: 'string',
                    validate: /[^\s]+/
                }]

                /* Select the type of operation. */
                const operationType = $('#node-select-activeDirectory-operation').selectField({
                    optionsData: [{
                        value: 'authenticate',
                        displayValue: 'Authenticate'
                    },
                    {
                        value: 'isUserMemberOf',
                        displayValue: 'isUserMemberOf'
                    },
                    {
                        value: 'findUser',
                        displayValue: 'findUser'
                    },
                    {
                        value: 'getGroupMembershipForUser',
                        displayValue: 'getGroupMembershipForUser'
                    },
                    {
                        value: 'findGroup',
                        displayValue: 'findGroup'
                    },
                    {
                        value: 'groupExists',
                        displayValue: 'groupExists'
                    },
                    {
                        value: 'getGroupMembershipForGroup',
                        displayValue: 'getGroupMembershipForGroup'
                    },
                    {
                        value: 'getUsersForGroup',
                        displayValue: 'getUsersForGroup'
                    },
                    {
                        value: 'findUsers',
                        displayValue: 'findUsers'
                    },
                    {
                        value: 'findGroups',
                        displayValue: 'findGroups'
                    },
                    {
                        value: 'userExists',
                        displayValue: 'userExists'
                    },
                    {
                        value: 'findDeletedObjects',
                        displayValue: 'findDeletedObjects'
                    }
                    ],
                    value: node.operationType,
                    change: (val) => {
                        $('#node-input-activeDirectory-username-wrp').hide();
                        $('#node-input-activeDirectory-password-wrp').hide();
                        $('#node-input-activeDirectory-accname-wrp').hide();
                        $('#node-input-activeDirectory-groupName-wrp').hide();
                        $('#node-input-activeDirectory-query-wrp').hide();
                        $('#node-input-activeDirectory-options-wrp').hide();
                        if (val === 'authenticate') {
                            $('#node-input-activeDirectory-username-wrp').show();
                            $('#node-input-activeDirectory-password-wrp').show();
                            $('#node-input-activeDirectory-accname-wrp').show();
                        } else {
                            if (val === 'isUserMemberOf') {
                                $('#node-input-activeDirectory-username-wrp').show();
                                $('#node-input-activeDirectory-groupName-wrp').show();
                            }
                            if (val === 'findUser' || val === 'getGroupMembershipForUser') {
                                $('#node-input-activeDirectory-accname-wrp').show();
                            }
                            if (val === 'findGroup' || val === 'groupExists' || val ===
                                'getGroupMembershipForGroup' || val === 'getUsersForGroup') {
                                $('#node-input-activeDirectory-groupName-wrp').show();
                            }
                            if (val === 'findUsers' || val === 'findGroups') {
                                $('#node-input-activeDirectory-query-wrp').show();
                            }
                            if (val === 'userExists') {
                                $('#node-input-activeDirectory-username-wrp').show();
                            } else if (val === 'findDeletedObjects') {
                                $('#node-input-activeDirectory-options-wrp').show();
                            }
						}
						SRD.defaults.validateForm(true);
                    }
                });
                /* Result Mapping field */
                const resultMapping = $('#node-input-result-mapping').typedInput({
                    types: commonTypes,
					noformvalidation: false,
                });
                /* username of the store object (can be value or map). */
                const username = $('#node-input-activeDirectory-username').typedInput({
                    types: [...commonTypes, ...kvSpecificTypes],
					noformvalidation: false,
                });
                /* password field */
                const password = $('#node-input-activeDirectory-password').typedInput({
                    types: [...commonTypes, ...kvSpecificTypes],
					noformvalidation: false,
                });
                /* accname field */
                const accname = $('#node-input-activeDirectory-accname').typedInput({
                    types: [...commonTypes, ...kvSpecificTypes],
					noformvalidation: false,
                });
                const groupname = $('#node-input-activeDirectory-groupName').typedInput({
                    types: [...commonTypes, ...kvSpecificTypes],
					noformvalidation: false,
                });
                const query = $('#node-input-activeDirectory-query').typedInput({
                    types: [...commonTypes, ...kvSpecificTypes],
					noformvalidation: false,
                });
                const options = $('#node-input-activeDirectory-options').typedInput({
                    types: [...commonTypes, ...kvSpecificTypes],
					noformvalidation: false,
                });

                operationType.selectField('change', node.operationType);

                /* Set values for key and value fields if already exists */
                if (node.resultMapping.value) {
                    resultMapping.typedInput('type', node.resultMapping.type);
                    resultMapping.typedInput('value', node.resultMapping.value);
                }
                if (node.username.value) {
                    username.typedInput('type', node.username.type);
                    username.typedInput('value', node.username.value);
                }
                if (node.password.value) {
                    password.typedInput('type', node.password.type);
                    password.typedInput('value', node.password.value);
                }
                if (node.sAMAAccountName.value) {
                    accname.typedInput('type', node.sAMAAccountName.type);
                    accname.typedInput('value', node.sAMAAccountName.value);
                }
                if (node.groupName.value) {
                    groupname.typedInput('type', node.groupName.type);
                    groupname.typedInput('value', node.groupName.value);
                }
                if (node.query.value) {
                    query.typedInput('type', node.query.type);
                    query.typedInput('value', node.query.value);
                }
                if (node.options.value) {
                    options.typedInput('type', node.options.type);
                    options.typedInput('value', node.options.value);
                }
            },
            oneditsave: function () {
                const node = this;
                const resMap = $('#node-input-result-mapping');
                const username = $('#node-input-activeDirectory-username');
                const password = $('#node-input-activeDirectory-password');
                const accname = $('#node-input-activeDirectory-accname');
                const groupname = $('#node-input-activeDirectory-groupName');
                const query = $('#node-input-activeDirectory-query');
                const options = $('#node-input-activeDirectory-options');
                /* node property assignments */
                node.adConfigId = $('#node-input-adconfig').val();
                node.name = $('#node-input-name').val();
                node.operationType = $('#node-select-activeDirectory-operation').val();
                node.resultMapping = { type: resMap.typedInput('type'), value: resMap.typedInput('value') };
                node.username = {};
                node.password = {};
                node.sAMAAccountName = {};
                node.groupName = {};
                node.query = {};
                node.options = {};

                if (node.operationType === 'authenticate') {
                    node.username = {
                        type: username.typedInput('type'),
                        value: username.typedInput('value')
                    };
                    node.password = {
                        type: password.typedInput('type'),
                        value: password.typedInput('value')
                    };
                    node.sAMAAccountName = {
                        type: accname.typedInput('type'),
                        value: accname.typedInput('value')
                    };
                } else if (node.operationType === 'isUserMemberOf') {
                    node.username = {
                        type: username.typedInput('type'),
                        value: username.typedInput('value')
                    };
                    node.groupName = {
                        type: groupname.typedInput('type'),
                        value: groupname.typedInput('value')
                    };
                } else if (node.operationType === 'findUser' || node.operationType ===
                    'getGroupMembershipForUser') {
                    node.sAMAAccountName = {
                        type: accname.typedInput('type'),
                        value: accname.typedInput('value')
                    };
                } else if (node.operationType === 'findGroup' || node.operationType === 'groupExists' ||
                    node.operationType === 'getGroupMembershipForGroup' || node.operationType ===
                    'getUsersForGroup'
                ) {
                    node.groupName = {
                        type: groupname.typedInput('type'),
                        value: groupname.typedInput('value')
                    };
                } else if (node.operationType === 'findUsers' || node.operationType === 'findGroups') {
                    node.query = {
                        type: query.typedInput('type'),
                        value: query.typedInput('value')
                    };
                } else if (node.operationType === 'userExists') {
                    node.username = {
                        type: username.typedInput('type'),
                        value: username.typedInput('value')
                    };
                } else if (node.operationType === 'findDeletedObjects') {
                    node.options = {
                        type: options.typedInput('type'),
                        value: options.typedInput('value')
                    };
                }
            },
            docsLink: 'active-directory-node'
        }
    });
</script>