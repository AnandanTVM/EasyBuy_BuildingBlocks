<script type="text/x-red" data-template-name="Soap">

    <!-- name -->
<!-- <div class="editor-form-row">
    <input type="text" id="node-input-name" placeholder="[n-sd]common.label.name">
</div> -->

<!-- Soap config -->
<div id="node-row-soapConfigId-container" class="editor-form-row"
    style="display:flex; flex-direction:column; height: 2.6rem">
    <label style="width: auto;" for="node-input-soapConfigId" class="editor-form-row-label">
        <span> SOAP Config</span>
    </label>
    <input type="text" style="width: 100%" id="node-input-soapConfigId">
</div>

<!-- Services -->
<div id="services-container" class="editor-form-row">
    <label><span>Services</span></label>
    <select id="node-input-services" style="width: 100%;"></select>
    <div class="error-msg-container"><span id="select-service-error" class="invalid-select">Select a Service</div>
</div>

<!-- Service Versions -->
<div id="serviceVersions-container" class="editor-form-row">
    <label><span>Service Versions</span></label>
    <select id="node-input-serviceVersions" style="width: 100%;"></select>
    <div class="error-msg-container"><span id="select-serviceVersion-error" class="invalid-select">Select a Service Version</div>
</div>

<!-- Operation -->
<div id="operations-container" class="editor-form-row">
    <label><span>Operations</span></label>
    <select id="node-input-operations" style="width: 100%;"></select>
    <div class="error-msg-container"><span id="select-operation-error" class="invalid-select">Select an Operation</div>
</div>
<div id="options-section" class="cookie-section props-section accordion ">
    <div class="pallete-category-title cursor-pointer">
        <div pallete-category-title-text>
            <label ><span>Options</span></label>
        </div>
        <img src="assets/pallete_icons/arrow_down.svg">
    </div>
    <div >
        <div id="security-container" class="editor-form-row">
            <label><span>Authentication type</span></label>
            <select id="node-input-authType" style="width: 100%;"></select>
        </div> 
        <div id="node-row-basicauthconfig-container" class="editor-form-row"
            style="display:flex; flex-direction:column; height: 2.6rem">
            <label style="width: auto;" for="node-input-basicAuthId" class="editor-form-row-label">
                <span> Auth Config</span>
            </label>
            <input type="text" style="width: 100%" id="node-input-basicAuthId">
        </div> 
        <div id="node-row-token-container" class="editor-form-row">
            <label><span>Token</span></label>
            <input type="text" id="node-input-typed-token" ui-element-type="typedInput" style="width:100%">
        </div>
        <div id="node-row-othoptions-container" class="editor-form-row">
            <label><span>Other Options</span></label>
            <input type="text" id="node-input-typed-othoptions" ui-element-type="typedInput" style="width:100%">
        </div>
        <div id="node-row-extraheaders-container" class="editor-form-row">
            <label><span>Extra Headers</span></label>
            <input type="text" id="node-input-typed-extraheaders" ui-element-type="typedInput" style="width:100%">
        </div>
    </div>
</div>

<!-- Result -->
<div class="editor-form-row">
    <label><span>Result Mapping</span></label>
    <input type="text" id="node-input-typed-resultMapping" ui-element-type="typedInput" style="width:100%">
</div>
</script>
<script type="text/javascript">
    registerNode({
        nodeType: 'Soap',
        serviceType: 'server',
        nodeDef: {
            color: "#596157",
            category: 'SOAP',
            inputs: 1,
            outputs: 1,
            icon: 'ndefault-call-soap/ndefault-call-soap-node.svg',
            label: function () {
                return this.name || 'SOAP';
            },
            paletteLabel: function () {
                return 'SOAP';
            },
            initdefaults: function (node, SRD, completeNodeObj) {
                numType = [{ value: 'num', label: 'number', validate: SRD.validators.typedInput('num', true) }];
                strType = [{ value: 'str', label: 'string', validate: SRD.validators.patterns.noblank }];
                bhTypes = [
                    { value: 'bh', label: 'bh.', validate: SRD.validators.typedInput('bh', true), nullable: true, nullableValue: 'undefined' },
                    { value: 'bh.input', label: 'bh.input.', validate: SRD.validators.typedInput('bh.input', true), nullable: true, nullableValue: 'undefined' },
                    { value: 'bh.local', label: 'bh.local.', validate: SRD.validators.typedInput('bh.local', true), nullable: true, nullableValue: 'undefined' },
                ];
                bhTypes_1 = [
                    { value: 'bh', label: 'bh.', nullable: true, nullableValue: 'undefined' },
                    { value: 'bh.input', label: 'bh.input.', nullable: true, nullableValue: 'undefined' },
                    { value: 'bh.local', label: 'bh.local.', nullable: true, nullableValue: 'undefined' },
                ];
                bhTypes_opt = [
                    { value: 'bh', label: 'bh.', nullable: true, nullableValue: '{}' },
                    { value: 'bh.input', label: 'bh.input.', nullable: true, nullableValue: '{}' },
                    { value: 'bh.local', label: 'bh.local.', nullable: true, nullableValue: '{}' },
                ];
                const env = 'server_env';
                const assertNullable = { nullable: true, nullableValue: JSON.stringify({ durable: true }) };
                const publishNullable = { nullable: true, nullableValue: JSON.stringify({ persistent: true }) };
                const common = ['bh', { value: 'str', label: 'string', validate: SRD.validators.patterns.noblank }];
                const defaults = {
                    name: {
                        value: ''
                    },
                    soapConfigId: {
                        type: 'soap-config'
                    },
                    services: {
                        value: '',
                        required: true

                    },
                    serviceVersions: {
                        value: '',
                        required: true

                    },
                    operations: {
                        value: '',
                        required: true
                    },
                    parametersList: {
                        value: []
                    },
                    selectedParams: {
                        value: []
                    },
                    resultMapping: {
                        value: '',
                        required: true
                    },
                    webServiceName: {
                        value: ''
                    },
                    methodParameters: {
                        value: ''
                    },
                    wsdlFile: {
                        value: ''
                    },
                    authType: {
                        value: ''
                    },
                    basicAuthId: {
                        type: 'basicauth-config', required: false
                    },
                    token: {
                        value: ''
                    },
                    othoptions: {
                        value: ''
                    },
                    extraheaders: {
                        value: ''
                    }
                };
                if (completeNodeObj && completeNodeObj.hasOwnProperty('parametersList') && completeNodeObj.parametersList.length) {
                    for (let i = 0; i < completeNodeObj.parametersList.length; i++) {
                        defaults[completeNodeObj.parametersList[i].name] = { value: '', dynamic: true };
                    }
                }
                return defaults;
            },
            resolver: async function (SRD) {
                const node = this;
                const path = require('path');


                node.getWsdlPath = () => {
                    const wsdlPath = SRD.utils.getStudioWorkspace() + path.sep + SRD.appName + path.sep + 'server' + path.sep + 'configFiles' + path.sep + 'soap-config' +
                        path.sep + node.configNode.id + path.sep + 'wsdlFiles' + path.sep + node.configNode.wsdlFile;
                    node.wsdlFile = node.configNode.wsdlFile;
                    return wsdlPath;
                };

                /*Get List of Services, service versions and Operations supported by provider wsdl file*/
                node.getOperations = async (wsdlPath) => {
                    const self = node;
                    try {
                        const { operationsInfo, parametersList, webServiceName } = await SRD.utils.getWSDLOperations(wsdlPath, {});
                        self.operationsInfo = operationsInfo;
                        self.parametersList = parametersList;
                        if (webServiceName !== self.webServiceName) {
                            removePreviousVal(webServiceName);
                        }
                        node.addDynamicDefaults();
                    } catch (error) {
                        self.operationsInfo = {};
                        // TODO: show error to user
                        SRD.dialogService.openSnackBar('No operations found')
                    }
                }

                node.init = async (soapConfigId) => {
                    node.configNode = SRD.nodes.node(soapConfigId ? soapConfigId: node.soapConfigId);
                    if (node.configNode && node.configNode.wsdlFile) {
                        await node.getOperations(node.getWsdlPath());
                    } else {
                        SRD.dialogService.openSnackBar('no config attached to this node');
                    }
                }

                node.addDynamicDefaults = () => {
                    if (node && node.hasOwnProperty('parametersList') && node.parametersList.length) {
                        for (let i = 0; i < node.parametersList.length; i++) {
                            /*Add the deault object if not already, since it could have been added during resolver*/
                            if (!node._def.defaults.hasOwnProperty(node.parametersList[i].name)) {
                                node._def.defaults[node.parametersList[i].name] = { value: '' };
                            }
                        }
                    }
                }


                function removePreviousVal(newWebServiceName) {
                    delete node.services;
                    delete node.serviceVersions;
                    delete node.operations;
                    node.webServiceName = newWebServiceName;
                    removePreviousDefaults();
                }

                // TODO: delete previous properties from __SSDType__ object
                function removePreviousDefaults() {
                    for (const key in node._def.defaults) {
                        if (node._def.defaults.hasOwnProperty(key) && node._def.defaults[key].hasOwnProperty('dynamic') && node._def.defaults[key].dynamic === true) {
                            delete node._def.defaults[key];
                        }
                    }
                }

                await node.init();

            },
            oneditasync: async function (SRD) {
                // TODO: document this lifecycle
            },
            oneditinit: async function (SRD) {
                const node = this;
                $('#operations-container').after(`<div id="operationparams-section" class="cookie-section props-section accordion ">
                    <div class="pallete-category-title cursor-pointer">
                        <div pallete-category-title-text>
                            <label ><span >Operation Parameters</span></label>
                        </div>
                        <img src="assets/pallete_icons/arrow_down.svg">
                    </div>
                    <div>
						<div id="parameters-container" class=""> </div>
					</div>
                </div>`);
                const basicSection = $('#operationparams-section').accordion({
						animate: 100,
						heightStyle: "content",
						collapsible: true,
						header: '.pallete-category-title'
				})
                $(`#operationparams-section`).hide();

                const optionsSection = $('#options-section').accordion({
						animate: 100,
						heightStyle: "content",
						collapsible: true,
						header: '.pallete-category-title'
                })

                $('#node-input-authType').selectField({
                    optionsData: [
                        {
                        value: 'basic',
                        displayValue: 'Basic Auth'
                        },
                        {
                        value: 'token',
                        displayValue: 'Token'
                        }
                    ],
                    placeholder: 'Select an Auth protocol',
                    value: node.authType,
                    change: function (val) {
                        authChange(val);
                        // TODO: validate form
                        validateForm ();
                    }
                });
                $('#node-row-basicauthconfig-container').hide();
                $('#node-row-token-container').hide();
                function authChange (val) {
                    if (val === 'basic') {
                        //show basic
                        $('#node-row-basicauthconfig-container').show();
                        $('#node-row-token-container').hide();
                    } else if (val === 'token') {
                        //show token
                        $('#node-row-basicauthconfig-container').hide();
                        $('#node-row-token-container').show();
                    }
                }

                node.addOperations = (isChangeConfig) => {
                    if (node && node.operationsInfo) {
                        const servicesList = _getServiceList();
                        updateServiceList(servicesList, isChangeConfig);
                        const serviceVersionsList = _getServiceVersionsList();
                        updateServiceVersionsList(serviceVersionsList, isChangeConfig);
                        updateOperationsList(serviceVersionsList, isChangeConfig);
                        validateForm ();
                    }
                };

                initFields();
                node.addOperations();

                function initFields() {
                    $('#node-input-name').inputField();
                    $('#node-input-typed-resultMapping').typedInput({
                        types: bhTypes,
                        onvalchanged: validateForm
                    });
                    $('#node-input-typed-token').typedInput({
                        types: bhTypes,
                        change: validateForm
                    });
                    $('#node-input-typed-othoptions').typedInput({
                        types: bhTypes_opt,
                        change: validateForm
                    });
                    $('#node-input-typed-extraheaders').typedInput({
                        types: bhTypes_opt,
                        change: validateForm
                    });
                }



                /* Get list of Services */
                function _getServiceList() {
                    if (Object.keys(node.operationsInfo).length > 0) {
                        return Object.keys(node.operationsInfo).map(s => {
                        return { value: s, displayValue: s };
                    });
                    } else {
                        return [];
                    }
                    
                }

                /*Get all versions for a selected service*/
                function _getServiceVersionsList() {
                    if (Object.keys(node.operationsInfo).length > 0) {
                        return node.operationsInfo[$('#node-input-services').val()];
                    } else {
                        return [];
                    }
                }
                function handleFormValidity() {
                    let validService = $(`#node-input-services`).val() && ($(`#node-input-services`).val() !== $('#node-input-services').selectField('option', 'placeholder'))
                    let validServiceVersion = $(`#node-input-serviceVersions`).val() && ($(`#node-input-serviceVersions`).val() !== $('#node-input-serviceVersions').selectField('option', 'placeholder'))
                    let validOperation = $(`#node-input-operations`).val() && ($(`#node-input-operations`).val() !== $('#node-input-operations1node-input-services').selectField('option', 'placeholder'))
                    if (validService) {
                        $('#select-service-error').hide();
                    } else {
                        $('#select-service-error').show();
                    }
                    if (validServiceVersion) {
                        $('#select-serviceVersion-error').hide();
                    } else {
                        $('#select-serviceVersion-error').show();
                    }
                    if (validOperation) {
                        $('#select-operation-error').hide();
                    } else {
                        $('#select-operation-error').show();
                    }
                    if (validService && validServiceVersion && validOperation ) {
                        return true;
                    } else {
                        return false;
                    }
                }
                function validateForm () {
                    let validForm = handleFormValidity();
                    if (([...$('#dialog-form .red-ui-typedInput-input.input-error')].some(e => !$(e).is(':hidden'))) || !validForm) {
                        $('#node-dialog-ok').addClass('disabled');
                    } else if (!([...$('#dialog-form .red-ui-typedInput-input.input-error')].some(e => !$(e).is(':hidden'))) && validForm) {
                        $('#node-dialog-ok').removeClass('disabled');
                    }
                }

                /* Init service list or update if already created */
                function updateServiceList(servicesList, isChangeConfig) {
                    if (isChangeConfig && isWidgetinitialized('#node-input-services')) {
                        $('#node-input-services').selectField('updateOptions', servicesList, true, false);
                        if (Object.keys(servicesList).length > 0) {
							$('#node-input-services').val(servicesList[0].value)
                        }
                        validateForm ();
                    } else {
                        $('#node-input-services').selectField({
                            optionsData: servicesList,
                            props: {
                                required: true
                            },
                            value: (node.services ? node.services : null),
                            change: function (val, t) {
                                if (!t) {
                                    serviceChanged(val, true);
                                }
                                // TODO: validate form
                                validateForm ();
                            }
                        });
                    }
                }

                /* Init Service version list or update */
                function updateServiceVersionsList(serviceVersionsList, isChangeConfig) {
                    if (isChangeConfig && isWidgetinitialized('#node-input-serviceVersions')) {
                        $('#node-input-serviceVersions').selectField('updateOptions', serviceVersionsList, true, false);
                        if (Object.keys(serviceVersionsList).length > 0) {
							$('#node-input-serviceVersions').val(serviceVersionsList[0].value)
                        }
                        validateForm ();
                    } else {
                        $('#node-input-serviceVersions').selectField({
                            optionsData: serviceVersionsList,
                            props: {
                                required: true
                            },
                            value: (node.serviceVersions ? node.serviceVersions : null),
                            change: function (val, t) {
                            if (!t){
								serviceVersionChanged(val, true);
							} 
                                // TODO: validate form
                                validateForm ();
                            }
                        });
                    }
                }

                function isWidgetinitialized(id) {
                    return $(id).selectField('instance');
                }

                function updateOperationsList(serviceVersionsList, isChangeConfig) {
                    const serviceVersionIndex = getServiceVersionIndex(serviceVersionsList);
                    if (serviceVersionIndex > -1) {
                        const operationsList = serviceVersionsList[serviceVersionIndex].operations;
                        if (isChangeConfig && isWidgetinitialized('#node-input-operations')) {
                            $('#node-input-operations').selectField('updateOptions', operationsList, true, false);
                            if (Object.keys(operationsList).length > 0) {
								$('#node-input-operations').val(operationsList[0].value)
							}
                            validateForm ();
                        } else {
                            $('#node-input-operations').selectField({
                                optionsData: operationsList,
                                props: {
                                    required: true
                                },
                                value: (node.operations ? node.operations : null),
                                change: function (val) {
                                    const serviceVersionsList = _getServiceVersionsList();
                                    const serviceVersionIndex = getServiceVersionIndex(serviceVersionsList);
                                    if (serviceVersionIndex > -1) {
                                        createParametersDOM(getOperationParams(serviceVersionsList[serviceVersionIndex].operations));
                                    }
                                    validateForm ();
                                }
                            });
                        }
                        createParametersDOM(getOperationParams(serviceVersionsList[serviceVersionIndex].operations));
                    } else {
                        if (isWidgetinitialized('#node-input-operations')) {
                            $('#node-input-operations').selectField('updateOptions', [], true, false);
                            $('div[canHide="true"]').each(function (i) {
                                $(this).hide();
                            });
                            $(`#operationparams-section`).hide();
                            validateForm ();
                        } else {
                            $('#node-input-operations').selectField({
                                optionsData: [],
                                props: {
                                    required: true
                                },
                                value: (node.operations ? node.operations : null),
                                change: function (val) {
                                    const serviceVersionsList = _getServiceVersionsList();
                                    const serviceVersionIndex = getServiceVersionIndex(serviceVersionsList);
                                    if (serviceVersionIndex > -1) {
                                        createParametersDOM(getOperationParams(serviceVersionsList[serviceVersionIndex].operations));
                                    }
                                    validateForm ();
                                }
                            });
                        }
                        
                    }
                }

                function getServiceVersionIndex(serviceVersionsList = []) {
                    return serviceVersionsList.findIndex(a => a.value === $('#node-input-serviceVersions').val());
                }

                function getOperationParams(operationsList) {
                    const selectedOperation = $('#node-input-operations').val();
                    const operationIndex = _getOperationIndex(operationsList, selectedOperation);
                    if (operationIndex > -1) {
                        return operationsList[operationIndex].paramters;
                    } else {
                        return [];
                    }
                };

                function _getOperationIndex(operationList = [], selectedOperation) {
                    return operationList.findIndex(a => a.value === selectedOperation);
                }

                function serviceChanged(selectedService, isChangeConfig) {
                    const serviceVersionsList = _getServiceVersionsList();
                    updateServiceVersionsList(serviceVersionsList, isChangeConfig);
                    updateOperationsList(serviceVersionsList, isChangeConfig);
                }

                function serviceVersionChanged(selectedServiceVersion, isChangeConfig) {
                    updateOperationsList(_getServiceVersionsList(), isChangeConfig);
                }

                /* Creates input fields based on selected Operation field */
                function createParametersDOM(parametersList) {
                    node.selectedParams = parametersList;
                    $('div[canHide="true"]').each(function (i) {
                        $(this).hide();
                    });
                    $(`#operationparams-section`).hide();
                    for (let i = 0; i < parametersList.length; i++) {
                        const containerId = `node-typedInput-${parametersList[i].name}-container`;
                        if (!$(`#node-typedInput-${SRD.utils.cssQueryFilter(parametersList[i].name)}-container`).length) {
                            const inputId = `node-input-typed-${parametersList[i].name}`;
                            const el = $(`<div class="editor-form-row" id="${containerId}" canHide="true">
                                                    <label><span>${parametersList[i].label}</span></label>
                                                    <input type="text" id="${inputId}" ui-element-type="typedInput" style="width:100%">
                                                    </div>`);
                            $('#parameters-container').after(el);
                            $(el).find(`#node-input-typed-${SRD.utils.cssQueryFilter(parametersList[i].name)}`).typedInput({
                                types: [...bhTypes, ...numType, ...strType],
                                change: validateForm
                            })
                        }
                        $(`#operationparams-section`).show();

                        $(`#node-typedInput-${SRD.utils.cssQueryFilter(parametersList[i].name)}-container`).show();
                    }
                }
                // TODO: confirm if operationsInfo has to be added to node object
                handleFormValidity();
                validateForm ();

            },
            oneditprepare: function () {
                const node = this;
                $('#node-input-soapConfigId').selectField({
                    change: (val, t) => {
                        node.init(val).then(() => {
                            if (val !== node.soapConfigId) {
                                node.soapConfigId = '';
                                if (val === '_ADD_') {
                                    node.operationsInfo = [];
                                }
                                node.addOperations(true);
                            }
                        });
                    }
                });
            },
            docsLink: 'soap-node'


        }


    });
</script>