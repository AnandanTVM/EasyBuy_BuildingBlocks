<script type="text/x-red" data-template-name="soap-config">
    <!-- name -->
    <div class="editor-form-row">
        <input type="text" id="node-input-name">
    </div>
    <!-- WSDL file -->
<div class="editor-form-row">
    <div style="display:flex">
        <input type="text" id="node-input-wsdlFile" readonly>
        <button class="map-button-wrp">
            <image id="node-config-uplaodfile" class="map-button" src="assets/serviceDesigner/upload.svg"
                title="Click to upload the file" style="width:16px"></image>
        </button>
        <button class="map-button-wrp">
            <image id="node-config-wsdlFile-clear" class="map-button" title="Delete" src="assets/clear.svg"></image>
        </button>

        <input type="text" id="node-input-wsdlFilePath" hidden>
        <input type="file" id="node-input-select-file" hidden>
    </div>
</div>

<!-- XSD files -->
<div id="key-props-section" class="editor-form-row">
    <div style="display:flex">
        <input type="text" id="node-input-xsdFiles" readonly>
        <button class="map-button-wrp">
            <image id="node-config-uplaodXsdFiles" class="map-button" src="assets/serviceDesigner/upload.svg"
                title="Click to upload the file" style="width:16px"></image>
        </button>

        <input type="text" id="node-input-xsdFilePaths" hidden>
        <input type="file" id="node-input-select-xsdfile" multiple hidden>
    </div>
    <div class="properties-container">
        <ol id="key-properties-content"></ol>
    </div>
    <span class="list-keys-invalid">{{Editable List Invalid Message}}</span>
</div>
<div class="output-toggle-group">
    <div class="parser-switch-toggle-label">Use URL</div>
    <div class="toggle-button">
        <label class="switch">
            <input id="node-input-switch" type="checkbox">
            <span class="slider round"></span>
        </label>
    </div>
</div>
<!-- Url -->
<div id="node-input-wsdlUrl-wrp" class="editor-form-row">
    <label for="node-input-typed-wsdlUrl"><span >WSDL URL</span></label>
    <input type="text" id="node-input-typed-wsdlUrl" placeholder="" class="node-input-property" style="width: 100%" />
</div>
</script>
<script type="text/javascript">

    registerNode({
        nodeType: 'soap-config',
        serviceType: 'server',
        nodeDef: {
            category: 'config',
            defaults: {
                name: {
                    value: '',
                },
                wsdlFile: {
                    value: '', required: true
                },
                wsdlFilePath: {
                    value: ''
                },
                xsdFiles: {
                    value: ''
                },
                xsdFilePaths: {
                    value: ''
                },
                wsdlUrl: {
                    value: '',
                },
                operationsInfo: {
                    value: []
                },
                wsdlFiles: {
                    value: {
                        configFiles: []
                    }
                },
                keyVariables: {},
                filestodelete: { value: [] },
                useurl: { value: ''}
            },
            label: function () {
                return this.name || "SOAP Config";
            },
            oneditinit: function (SRD) {
                const node = this;
                const fileName = $('#node-input-wsdlFile').inputField({
                    value: node.wsdlFile,
                    placeholder: 'WSDL File',
                    validateOnCreate: true,
                    required: true
                });
                

                $('#node-input-xsdFiles').inputField({
                    value: node.xsdFiles || 'Upload XSD Files',
                    placeholder: 'XSD File(s)'
                });

                $("#node-config-uplaodfile").on('click', () => {
                    $('#node-input-select-file').trigger('click');
                });

                $('#node-config-uplaodXsdFiles').on('click', () => {
                    $('#node-input-select-xsdfile').trigger('click');
                });
                const strTypes = [{ value: 'str', label: 'string', validate: fieldvalidation}];
                const envTypes = [{ value: 'process.env', label: 'env', validate: fieldvalidation}];

                // URL
                $('#node-input-typed-wsdlUrl').typedInput({
                    types: [...strTypes, ...envTypes],
                    onvalchanged: () => {
                        if ([...$('.red-ui-typedInput-input.input-error')].some(e => !$(e).is(
                            ':hidden'))) {
                            $('#node-config-dialog-ok').addClass('disabled');
                        } else {
                            $('#node-config-dialog-ok').removeClass('disabled');
                        }
                    }
                });
                function fieldvalidation (v) {
                    if (document.querySelector('input[id="node-input-switch"]').checked) {
                            return /[^\s]+/.test(v);
                        } else {
                            return true;
                        }
                }
            },
            oneditprepare: function (SRD, nodeOptions) {
                let node = this;
                const doneBtn = $('#node-config-dialog-ok');
                node.tempVarStore = { keyVariables: [] };

                let nodeName = $(`#node-input-name`).inputField({
                    placeholder: SRD._('common.label.name')
                });
                if (node.useurl) {
                    document.getElementById('node-input-switch').checked = true;
                }
                function wsdlFileCheck () {
                    if ($('#node-input-wsdlFile').val() === '') {
                        return false;
                    } else {
                        return true;
                    }
                }


                function uploadFiles(files, fileType) {
                    for (let j = 0; j < files.length; j++) {
                        const filePaths = node.wsdlFiles.configFiles.map(f => f.name);
                        if (filePaths.includes(files[j].name)) {
                            console.log('files already exist')
                            SRD.dialogService.openSnackBar(`File already exists`)
                            $('#node-input-xsdFiles').val('')
                        } else {
                            node.wsdlFiles.configFiles.push({ name: files[j].name, path: files[j].path })
                            if (fileType) {
                                $(`#key-properties-content`).editableList('addItem', { rowData: {key: files[j].name}, validator: false });
                            }
                        }
                    }
                }

                $('#node-config-wsdlFile-clear').on('click', () => {
                    clearFilePaths('wsdlFile', 'wsdlFilePath');
                    validateForm();
                })
                function clearFilePaths(fileNameVar, filePathVar) {
                    if ($(`#node-input-${fileNameVar}`).val().length > 0) {
                        deleteFile($(`#node-input-${fileNameVar}`).val());
                        $(`#node-input-${fileNameVar}`).inputField('reset');
                        $(`#node-input-${fileNameVar}`).inputField('valid', false);
                        $(`#node-input-${filePathVar}`).val('');
                        $('#node-input-select-file').val('');
                    }
                }
                function deleteFile(filename) {
                    node.filestodelete.push(filename);
                    let configFiles = node.wsdlFiles.configFiles;
                    if (configFiles.length > 0) {
                        for (let i = 0; i < configFiles.length; i++) {
                            if (configFiles[i].name === filename) {
                                configFiles.splice(i, 1);
                            }
                        }
                        node.wsdlFiles.configFiles = configFiles;
                    }
                    
                }
                

                $('#node-input-select-file').change((changes) => {
                    /*When wsdl file is uploaded. store the file name and push to configFiles array*/
                    uploadFiles([...changes.target.files]);
                    $('#node-input-wsdlFile').inputField('value', changes.target.files[0].name);
                    validateForm ();
                });

                $('#node-input-select-xsdfile').change((changes) => {
                    uploadFiles([...changes.target.files], true);
                    
                })

                function preparePropsSection(sectionName) {

                    let keyField = $(`#node-input-xsdFiles`).inputField({
                        wrapperAttr: { style: 'width: 95%;' },
                        validatorRegexp: /^[a-zA-Z][a-zA-Z_0-9]*$/
                    });

                    /* Properties List */
                    let propertiesContainer = $(`#${sectionName}-props-section .properties-container`);
                    let invalidListMsg = $(`#${sectionName}-props-section .list-keys-invalid`).css({ 'visibility': 'hidden'
                    });

                    let propertiesHeaderContainer = $(`<div class="properties-header-container"></div>
                    `).prependTo(propertiesContainer);
                    let headers;
                        headers = $(`
                        <div class="editableList-header start-elHeader" style="left: 2%;">No.</div>
                        <div class="editableList-header start-elHeader" style="left: 7%;">Files</div>
                        `).appendTo(propertiesHeaderContainer);  

                    let varArrType = sectionName === 'column' ? 'columnVariables' : 'keyVariables';
                    function updateTempVarStore(prop, val, currentRowIdArr, setRest) {
                    for (let i in node.tempVarStore[varArrType]) {
                        if (currentRowIdArr.includes(node.tempVarStore[varArrType][i]['rowId'])) {
                            node.tempVarStore[varArrType][i][prop] = val;
                            if (setRest === undefined) {
                            return i;
                            }
                        } else if (setRest !== undefined) {
                            node.tempVarStore[varArrType][i][prop] = setRest;
                        }
                    }
                    }

                    function ultimateValidator() {
                        SRD.validators.editableList(propertiesContainer, propsContent, {
                            checkUniquenessOn: node.tempVarStore[varArrType].map(x => x.key),
                            checkValidityOn: node.tempVarStore[varArrType],
                            errorMsgContainer: invalidListMsg
                        });
                        validateForm();
                    }
                    let propsContent = $(`#${sectionName}-properties-content`).data({ valid: true, isUnique: true, isValid:
                    true });
                        propsContent.editableList({
                            addItem: function (container, i, data) {
                                let rowData = data.rowData || {};
                                let dataObj = {
                                key: rowData.key || keyField.val(),
                                rowId: rowData.rowId || SRD.nodes.id(),
                                valid: true
                                };
                                node.tempVarStore[varArrType].push(dataObj);
                                container.attr('id', dataObj.rowId).css('align-items', 'center').data('data', { rowData: dataObj });
                                if (node.filestodelete.length > 0) {
                                    for (let i = 0; i< node.filestodelete.length; i++) {
                                        if (node.filestodelete[i] === dataObj.key) {
                                            node.filestodelete.splice(i, 1);
                                        }
                                    }
                                }

                                /* property list's "content-type" field */
                                let listKey = $(`<input type="text" />`).appendTo(container).inputField({
                                    wrapperAttr: { style: 'width: 90%;' },
                                    validatorRegexp: /^[a-zA-Z][a-zA-Z_0-9]*$/,
                                    disableDoneIfInvalid: true,
                                    inputClassList: "property-key",
                                    props: {
                                        readonly: true
                                    },
                                    value: dataObj.key || keyField.val(),
                                    updations: function (elemData, inputVal) {
                                    let index = updateTempVarStore('key', inputVal, container.data().data.rowData.rowId);
                                    node.tempVarStore[varArrType][index].valid = elemData.valid;
                                    container.data('data', { rowData: node.tempVarStore[varArrType][index] });
                                    ultimateValidator();
                                    }
                                });
                                
                                
                                propertiesContainer.show();
                                $('.property-row .field-floating-placeholder').remove();

                                /* Clear the "Add" Section input fields */
                                keyField.inputField('reset');

                            },
                            removable: true,
                            scrollOnAdd: true,
                            removeItem: function (data) {
                                deleteFile(data.rowData.key);
                                node.tempVarStore[varArrType] = node.tempVarStore[varArrType].filter(vObj => vObj['rowId'] !==
                                data.rowData.rowId);
                                ultimateValidator();
                                if (node.tempVarStore[varArrType].length === 0) {
                                    $(`#${sectionName}-props-section .properties-container`).hide();
                                }
                            },
                            showAddBtnLabel: false,
                            validator: function () {
                                let keyToValidate = keyField.val();
                                if (!keyToValidate.match(keyField.inputField('option', 'validatorRegexp'))) {
                                    SRD.dialogService.openSnackBar('Content-type Invalid! Key Should Start with an Alphabet and Can Contain Alphabets, Numbers, Underscore.');
                                    return false;
                                }
                                if (node.tempVarStore[varArrType].find(vObj => vObj['key'] === keyToValidate)) {
                                    SRD.dialogService.openSnackBar('Duplicate Key! This Key Already Exists.');
                                    return false
                                }
                                return true;
                            }
                        });
                }

                function populateExistingVariables(sectionName, variablesObjectArr) {
                    if (variablesObjectArr && variablesObjectArr instanceof Array) {
                        for (let row of variablesObjectArr) {
                            $(`#${sectionName}-properties-content`).editableList('addItem', { rowData: row, validator: false });
                            $('#key-props-section .properties-container').show()
                        }
                    }
                }
                function validateForm() {
                    let wsdl = wsdlFileCheck();
                    if ([...$('.red-ui-typedInput-input.input-error')].some(e => !$(e).is(
                            ':hidden')) || !wsdl) {
                        doneBtn.addClass('disabled');
                    } else {
                        doneBtn.removeClass('disabled');
                    }
                }

                $('#node-input-switch').on('change', function () {
                    $('#node-input-typed-wsdlUrl').typedInput('validate');
                    validateForm();
                });
                
                preparePropsSection('key');
                $('#key-props-section .properties-container').hide();
                populateExistingVariables('key', node.keyVariables);
                $('.add-prop-btn-wrp').remove()
                validateForm()
            },
            oneditsave: function (SRD, changes) {
                this.keyVariables = this.tempVarStore.keyVariables.map(x => ({ key: x.key }));
                this.useurl = document.querySelector('input[id="node-input-switch"]').checked
                if (this.filestodelete.length > 0) {
                    SRD.configNodesService.deleteConfigFile(SRD.appName, 'soap-config', this.id, this.filestodelete, 'wsdlFiles')
                    console.log(`File deleted`)
                    this.filestodelete = [];
                }
            }
        }
    });
</script>