// TODO: @sankarshanaj - set "docsLink" property
<script type="text/x-red" data-template-name="emailout-config">
    
    <!-- name -->
    <div class="editor-form-row">
        <input type="text" id="node-input-name">
    </div>

    <label ><span data-i18n="emailout.label.serveroptions"></span></label>

    <!-- Server -->
    <div id="node-input-server-wrp" class="editor-form-row">
        <label for="node-input-typed-server"><span data-i18n="emailout.label.server"></span></label>
        <input type="text" id="node-input-typed-server" placeholder="server" class="node-input-property" style="width: 100%" />
    </div>

    <!-- Port -->
    <div id="node-input-port-wrp" class="editor-form-row">
        <label for="node-input-typed-port"><span data-i18n="emailout.label.port"></span></label>
        <input type="text" id="node-input-typed-port" placeholder="port" class="node-input-property" style="width: 100%" />
    </div>

    <div class="output-toggle-group padding-top-0">
        <div class="fileout-toggle-label">Secure</div>
        <div class="toggle-button">
            <label class="switch">
                <input id="secure-check" type="checkbox">
                <span class="slider round"></span>
            </label>
        </div>
    </div>
    <div class="output-toggle-group padding-top-0">
        <div class="fileout-toggle-label">TLS</div>
        <div class="toggle-button">
            <label class="switch">
                <input id="tls-check" type="checkbox">
                <span class="slider round"></span>
            </label>
        </div>
    </div>

    <label ><span data-i18n="emailout.label.emailoptions"></span></label>

    <!-- UserId -->
    <div id="node-input-userid-wrp" class="editor-form-row">
        <label for="node-input-typed-userid"><span data-i18n="emailout.label.userid"></span></label>
        <input type="text" id="node-input-typed-userid" placeholder="" class="node-input-property" style="width: 100%" />
    </div>

    <!-- Password -->
    <div id="node-input-password-wrp" class="editor-form-row">
        <label for="node-input-typed-password"><span data-i18n="emailout.label.password"></span></label>
        <input type="text" id="node-input-typed-password" placeholder="" class="node-input-property" style="width: 100%" />
    </div>
</script>

<script type="text/javascript">

    registerNode({
        nodeType: 'emailout-config',
        serviceType: 'server',
        nodeDef: {
            category: 'config',
            color: '#009978',
            defaults: {
                name: { value: "" },
                server: { value: { type: 'bh.', value: '' }, required: true },
                port: { value: { type: 'bh.', value: '' }, required: true },
                tls: { value: false },
                secure: { value: false },
                userid: { value: { type: 'bh.', value: '' }, required: true },
                password: { value: { type: 'bh.', value: '' }, required: true }
            },
            inputs: 1,
            outputs: 1,
            icon: "",
            paletteLabel: 'Email',
            label: function () {
                return this.name || "Email Configuration";
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            onpropertiesvalidated: function (SRD) {
                let node = this;
                node.validateForm($('#dialog-form'));
            },
            oneditprepare: function (SRD) {
                const node = this;
                
                let nodeName = $(`#node-input-name`).inputField({
                    placeholder: SRD._('common.label.name')
                });

                if (node.secure) {
                    document.getElementById('secure-check').checked = true;
                }
                if (node.tls) {
                    document.getElementById('tls-check').checked = true;
                }
            },
            oneditinit: function(SRD) {
                const node = this;
                const doneBtn = $('#node-config-dialog-ok');
                const $editDialogForm = $('#dialog-form');
                
                const numType = [ { value: 'num', label: 'number', validate: SRD.validators.typedInput('num', true) } ];
                const commonTypes = [
                    { value: 'bh', label: 'bh.', validate: SRD.validators.patterns.noblank},
                    { value: 'bh.input', label: 'bh.input.', validate: SRD.validators.patterns.noblank},
                    { value: 'bh.local', label: 'bh.local.', validate: SRD.validators.patterns.noblank},
                ]
                const kvSpecificTypes = [{ value: 'str', label: 'string', validate: SRD.validators.patterns.noblank}];
                const envTypes = [{ value: 'process.env', label: 'env', validate: SRD.validators.patterns.noblank}];
                $editDialogForm.find.bind($editDialogForm);
                node.validateForm = function validateForm(dialogForm) {
                    if ([...$('.red-ui-typedInput-input.input-error')].some(e => !$(e).is(
                            ':hidden'))) {
                        doneBtn.addClass('disabled');
                    } else {
                        doneBtn.removeClass('disabled');
                    }
                }
                
                const serverMapping = $('#node-input-typed-server').typedInput(
                { types: [...kvSpecificTypes, ...envTypes], onvalchanged: (type, value, validity) => {
                    node.validateForm($editDialogForm);
                },
                change: (type, value, validity) => {
                    node.validateForm($editDialogForm);
                } });
                
                const portMapping = $('#node-input-typed-port').typedInput(
                { types: [...numType, ...envTypes], onvalchanged: (type, value, validity) => {
                    node.validateForm($editDialogForm);
                },
                change: (type, value, validity) => {
                    node.validateForm($editDialogForm);
                } });

                const uidMapping = $('#node-input-typed-userid').typedInput(
                { types: [...kvSpecificTypes, ...envTypes], onvalchanged: (type, value, validity) => {
                    node.validateForm($editDialogForm);
                },
                change: (type, value, validity) => {
                    node.validateForm($editDialogForm);
                } });

                const pwdMapping = $('#node-input-typed-password').typedInput(
                { types: [...kvSpecificTypes, ...envTypes], onvalchanged: (type, value, validity) => {
                    node.validateForm($editDialogForm);
                },
                change: (type, value, validity) => {
                    node.validateForm($editDialogForm);
                } });

            },
            oneditsave: function () {

                const node = this;
                node.secure = document.querySelector('input[id="secure-check"]').checked;
                node.tls = document.querySelector('input[id="tls-check"]').checked;
            }
        }
    })
    
</script>