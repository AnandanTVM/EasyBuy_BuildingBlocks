<script type="text/x-red" data-template-name="EmailOut">
    <div class="editor-form-row">
        <label for="node-input-emailoutconfig" style="width: auto" data-i18n="emailout.label.mailconfig"></label>
        <div id="node-row-ad">
            <input type="text" style="width: auto" id="node-input-emailoutconfig">
        </div>
    </div>
    <div id="basic-section" class="cookie-section props-section accordion ">
        <div class="pallete-category-title cursor-pointer">
            <!-- Common fields -->
            <div pallete-category-title-text>
                <label ><span data-i18n="emailout.label.common"></span></label>
            </div>
            <img src="assets/pallete_icons/arrow_down.svg">
        </div>
        <div >
            <!-- From -->
            <div id="node-input-from-wrp" class="editor-form-row">
                <label for="node-input-typed-from"><span data-i18n="emailout.label.from"></span></label>
                <input type="text" id="node-input-typed-from" placeholder="" class="node-input-property" style="width: 100%" />
            </div>
        
            <!-- To -->
            <div id="node-input-to-wrp" class="editor-form-row">
                <label for="node-input-typed-to"><span data-i18n="emailout.label.to"></span></label>
                <input type="text" id="node-input-typed-to" placeholder="" class="node-input-property" style="width: 100%" />
            </div>
        
            <!-- Cc -->
            <div id="node-input-cc-wrp" class="editor-form-row">
                <label for="node-input-typed-cc"><span data-i18n="emailout.label.cc"></span></label>
                <input type="text" id="node-input-typed-cc" placeholder="" class="node-input-property" style="width: 100%" />
            </div>
        
            <!-- Bcc -->
            <div id="node-input-bcc-wrp" class="editor-form-row">
                <label for="node-input-typed-bcc"><span data-i18n="emailout.label.bcc"></span></label>
                <input type="text" id="node-input-typed-bcc" placeholder="" class="node-input-property" style="width: 100%" />
            </div>
        
            <!-- Subject -->
            <div id="node-input-subject-wrp" class="editor-form-row">
                <label for="node-input-typed-subject"><span data-i18n="emailout.label.subject"></span></label>
                <input type="text" id="node-input-typed-subject" placeholder="" class="node-input-property" style="width: 100%" />
            </div>
            
            <!-- Body -->
            <div id="node-input-body-wrp" class="editor-form-row">
                <label for="node-input-typed-body"><span data-i18n="emailout.label.body"></span></label>
                <input type="text" id="node-input-typed-body" placeholder="" class="node-input-property" style="width: 100%" />
            </div>
        
            <!-- Html -->
            <div id="node-input-body-wrp" class="editor-form-row">
                <label for="node-input-typed-html"><span data-i18n="emailout.label.html"></span></label>
                <input type="text" id="node-input-typed-html" placeholder="" class="node-input-property" style="width: 100%" />
            </div>
        
            <!-- Attachments(List(editableList) <=> typedInput) -->
            <div id="cookies-container" class="http-container">
                <div style="display:flex"><span style="display:flex; flex: 1" data-i18n="emailout.label.attachment"></span>
                    <button class="map-button-wrp" id="attachment-add" title="Add Attachment">
                        <image class="map-button" src="assets/serviceDesigner/add-node-kv.svg"></image>
                    </button>
                    <button id="attachment-switch"></button>
                </div>
                <div id="editableList-attachment" class="props-section" style="margin-top: 1em;"></div>
                <div class="form-row  editor-form-row" id="typedInput-attachment">
                    <input type="text" id="node-typedInput-attachment" class="node-input-property typed-input-width"
                        style="width: 100% !important" />
                    <input type="hidden" id="node-input-outputs" />
                </div>
            </div>
        </div>
    </div>
    <div id="advanced-section" class="cookie-section props-section accordion ">
        <div class="pallete-category-title cursor-pointer">
            <!--Advanced fields  -->
            <div pallete-category-title-text>
                <label ><span data-i18n="emailout.label.advance"></span></label>
            </div>
            <img src="assets/pallete_icons/arrow_down.svg">
        </div>
        <div id="advanced-accordion-content">
            <!-- iCal option -->
            <div id="node-input-iCal-wrp" class="editor-form-row">
                <label for="node-input-typed-iCal"><span data-i18n="emailout.label.iCal"></span></label>
                <input type="text" id="node-input-typed-iCal" placeholder="" class="node-input-property" style="width: 100%" />
            </div>
            
            <!-- Routing options -->
            <div id="node-input-routingoptions-wrp" class="editor-form-row">
                <label for="node-input-typed-routingoptions"><span data-i18n="emailout.label.routingoptions"></span></label>
                <input type="text" id="node-input-typed-routingoptions" placeholder="" class="node-input-property" style="width: 100%" />
            </div>
        
            <!-- Content options -->
            <div id="node-input-contentoptions-wrp" class="editor-form-row">
                <label for="node-input-typed-contentoptions"><span data-i18n="emailout.label.contentoptions"></span></label>
                <input type="text" id="node-input-typed-contentoptions" placeholder="" class="node-input-property" style="width: 100%" />
            </div>
        
            <!-- Header Options -->
            <div id="node-input-headeroptions-wrp" class="editor-form-row">
                <label for="node-input-typed-headeroptions"><span data-i18n="emailout.label.headeroptions"></span></label>
                <input type="text" id="node-input-typed-headeroptions" placeholder="" class="node-input-property" style="width: 100%" />
            </div>
        
            <!-- Security Options -->
            <div id="node-input-securityoptions-wrp" class="editor-form-row">
                <label for="node-input-typed-securityoptions"><span data-i18n="emailout.label.securityoptions"></span></label>
                <input type="text" id="node-input-typed-securityoptions" placeholder="" class="node-input-property" style="width: 100%" />
            </div>
        </div>
    </div>
    
    <!-- resultMapping -->
    <div id="node-input-result-mapping-wrp" class="editor-form-row">
        <label for="node-input-typed-resultMapping"><span
                data-i18n="common.label.result-mapping"></span></label>
        <input type="text" id="node-input-typed-resultMapping" class="node-input-property" style="width: 100%" />
    </div>
</script>

<script type="text/javascript">
    registerNode({
        nodeType: 'EmailOut',
        serviceType: 'server',
        nodeDef: {
            color: "#fd9125",
            category: 'Messaging',
            defaults: {
                name: { value: "" },
                emailoutconfig: { type: "emailout-config"},
                from: { },
                to: {  required: true },
                cc: {  },
                bcc: {  },
                subject: { required: true },
                body: { required: true },
                html: {  },
                attachment: { value: [] },
                attachmentList: {
                    value: {}
                },
                switchStates: {
                    value: {
                        attachment: 'Map'
                    }
                },
                editableListData: { value: {} },

                routingoptions: {  },
                iCal: {  },
                contentoptions: {  },
                headeroptions: {  },
                securityoptions: {  },

                outputs: { value: 1 },
                resultMapping: { value: { type: 'bh', value: '' } , required: true },
            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-email/email-out-node.svg",
            paletteLabel: function (def) {
                return 'Email Out';
            },
            label: function () {
                return this.name || 'Email Out'
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function (SRD) {
                const node = this;
                const form = $('#dialog-form');
                let __$ = form.find.bind(form);
                node._editableListData = {};

                const basicSection = $('#basic-section').accordion({
                        animate: 100,
                        heightStyle: "content",
                        collapsible: true,
                        header: '.pallete-category-title'
                })
                const advancedSection = $('#advanced-section').accordion({
                        animate: 100,
                        heightStyle: "content",
                        collapsible: true,
                        header: '.pallete-category-title',
                        active:false
                })

                function validateForm() {
					SRD.defaults.validateForm(true);
                }

                const types = [
                    { value: 'bh', label: 'bh.', nullable: true, nullableValue: 'undefined', validate: SRD.validators.typedInput('bh') },
                    { value: 'bh.input', label: 'bh.input.', nullable: true, nullableValue: 'undefined', validate: SRD.validators.typedInput('bh.input') },
                    { value: 'bh.local', label: 'bh.local.', nullable: true, nullableValue: 'undefined', validate: SRD.validators.typedInput('bh.local') }
                ];
                const kvSpecificTypes = [{ value: 'str', label: 'string', nullable: true, nullableValue: 'undefined'}];

                const stateToFieldMapObj = function (section) {
                    return {
                        Map: {
                            selector: '#editableList-' + section,
                            src: 'assets/serviceDesigner/refresh.svg'
                        },
                        Value: {
                            selector: '#typedInput-' + section,
                            src: 'assets/serviceDesigner/edit.svg'
                        }
                    }
                };

                $('#node-typedInput-attachment').typedInput({
					noformvalidation: false,
                    types: types,
                })
                if (node.attachment && node.attachment.hasOwnProperty('type')) {
                    $("#node-typedInput-attachment").typedInput('type', node.attachment.type);
                    $("#node-typedInput-attachment").typedInput('value', node.attachment.value);
                }

                const attachmentTemplate = `
                <div id="%section%-section" class="cookie-section props-section accordion">
                    <div class="pallete-category-title cursor-pointer">
                        <div pallete-category-title-text>Attachment</div>
                        <img src="assets/pallete_icons/arrow_down.svg">
                        <button class="remove-cookie-button" id="%section%-remove" title="Remove this attachment"></button>
                    </div>
                    <div id="%section%-accordion-content">
                        <label class="editor-form-row-label">File Name</label>
                        <input type="text" id="attachment-filename">
                        <label class="editor-form-row-label">Content</label>
                        <input type="text" id="attachment-content">
                        <label class="editor-form-row-label">File Path</label>
                        <input type="text" id="attachment-filepath">
                        <label class="editor-form-row-label">Encoding</label>
                        <select id="attachment-encoding" style="width: 100%;"> </select>
                       
                    </div>
                </div>
                `
                function attachWidgetsForAttachmentFields(sectionId, attachmentObject = { name: '', content: {}, filename: {}, filepath: {}, encodingVal: '' }) {
                    const { name, content, filename, filepath,encodingVal } = attachmentObject;
                    const section = __$(sectionId);

                    const attachmentFileName = section.find('#attachment-filename').css({ width: '100%' }).typedInput({
                        types: [...types, ...kvSpecificTypes],
                        default: filename.type,
						noformvalidation: false,
                        onvalchanged: function (type, value, valid) {
                            if (node._attachmentList[sectionId]) {
                                node._attachmentList[sectionId]['filename'] = { type: type, value: value };
                                node._attachmentList[sectionId]['valid'] = valid ;
                            }
                        },
                        change: function(type, value) {
                            const catTitle = value.length > 45 ? value.slice(0, 45) + '...' : value;
                            section.find('[pallete-category-title-text]').text('Attachment-' + catTitle);
						},
                    }).typedInput('value', filename.value);

                    const attachmentcontent = section.find('#attachment-content').css({ width: '100%' }).typedInput({
                        types: types,
						default: content.type,
						noformvalidation: false,
                        onvalchanged: function (type, value, valid) {
                            if (node._attachmentList[sectionId]) {
                                node._attachmentList[sectionId]['content'] = { type: type, value: value };
                                node._attachmentList[sectionId]['valid'] = valid ;
                            }
                        }
                    }).typedInput('value', content.value);

                    const attachmentfilepath = section.find('#attachment-filepath').css({ width: '100%' }).typedInput({
                        types: [...types, ...kvSpecificTypes],
						default: filepath.type,
						noformvalidation: false,
                        onvalchanged: function (type, value, valid) {
                            if (node._attachmentList[sectionId]) {
                                node._attachmentList[sectionId]['filepath'] = { type: type, value: value };
                                node._attachmentList[sectionId]['valid'] = valid ;
                            }
                        }
                    }).typedInput('value', filepath.value);

                    var data = SRD._('common.encoding-attachments');
                    
                    
                    const encoding = section.find('#attachment-encoding').css({width: '100%'}).selectField({
                    optionsData:  JSON.parse(data.replace(/'/g,'"')),
                    value: attachmentObject.encoding,
                    change: (val) => {
                        if (node._attachmentList[sectionId]) {
                            node._attachmentList[sectionId]['encoding'] = val;
                        }
                        validateForm();
                    }
                });

                }

                node._attachmentList = {};

                function getAttachmentId(sectionId) {
                    return sectionId ? sectionId.slice(1, sectionId.length + 1).replace('-section', '')
                        : 'attachment-' + SRD.nodes.id()
                }

                function attchRemoveAttachmentListener(removeAttachmentBtn, sectionId) {
                    removeAttachmentBtn.click(function () {
                        __$(sectionId).accordion('destroy');
                        __$(sectionId).remove();
                        delete node._attachmentList[sectionId];
                        delete node._editableListData[getAttachmentId(sectionId)];
                        validateForm();
                    })
                }

                function addAttachment(id, attachmentObject, activeState) {
                    const attachmentId = getAttachmentId(id);
                    const sectionId = '#' + attachmentId + '-section';
                    const attachmentSectionString = attachmentTemplate.replace(/%section%/g, attachmentId);
                    const attachmentSection = $(attachmentSectionString).accordion({
                        animate: 100,
                        heightStyle: "content",
                        collapsible: true,
                        header: '.pallete-category-title',
                        active: activeState
                    }).prependTo('#editableList-attachment');
                    attchRemoveAttachmentListener(attachmentSection.find('#' + attachmentId + '-remove'), sectionId);
                    attachWidgetsForAttachmentFields(sectionId, attachmentObject);
                    node._attachmentList[sectionId] = attachmentObject || { name: null, valid: undefined, valid: false };
                }


                __$('#attachment-add').click(function () {
                    addAttachment();
                })

                var attachmentSwitchState = SRD.utils.switchFields({
                    scope: '#dialog-form',
                    stateToFieldMap: stateToFieldMapObj('attachment'),
                    switcher: '#attachment-switch',
                    initialState: node.switchStates['attachment'],
                    imageContainer: '#attachment-switch',
                    afterSwitch: function (title) {
                        if (title === 'Value') {
                            __$('button#attachment-add').hide()
                        } else {
                            __$('button#attachment-add').show()
                        }
                        validateForm();
                    }
                });

                editorPrepared = true;
                validateForm();

                Object.keys(node.attachmentList).forEach((key) => {
                    addAttachment(key, node.attachmentList[key], false)
                });

            },
            oneditinit: function(SRD) {
                const node = this;
                const numType = [ { value: 'num', label: 'number' } ];
                const commonTypes = [
                    { value: 'bh', label: 'bh.', nullable: true, nullableValue: 'undefined', validate: SRD.validators.typedInput('bh')},
                    { value: 'bh.input', label: 'bh.input.', nullable: true, nullableValue: 'undefined', validate: SRD.validators.typedInput('bh.input')},
                    { value: 'bh.local', label: 'bh.local.', nullable: true, nullableValue: 'undefined', validate: SRD.validators.typedInput('bh.local')},
                ]
                const kvSpecificTypes = [{ value: 'str', label: 'string', nullable: true, nullableValue: 'undefined'}];
				const envTypes = [{ value: 'process.env', label: 'env', nullable: true, nullableValue: 'undefined', validate: SRD.validators.typedInput('env')}];

                const commonTypesMandatory = [
                    { value: 'bh', label: 'bh.', nullable: true, nullableValue: 'undefined', validate: SRD.validators.typedInput('bh', true)},
                    { value: 'bh.input', label: 'bh.input.', nullable: true, nullableValue: 'undefined', validate: SRD.validators.typedInput('bh.input', true)},
                    { value: 'bh.local', label: 'bh.local.', nullable: true, nullableValue: 'undefined', validate: SRD.validators.typedInput('bh.local', true)},
                ]
                const kvSpecificTypesMandatory = [{ value: 'str', label: 'string', nullable: true, nullableValue: undefined, validate: SRD.validators.typedInput('str', true)}];
				
				const fromMapping = $('#node-input-typed-from').typedInput({
					types: [...commonTypes, ...kvSpecificTypes],
					noformvalidation: false
				});
				const toMapping = $('#node-input-typed-to').typedInput({
					types: [...commonTypesMandatory, ...kvSpecificTypesMandatory],
					noformvalidation: false
				});
                const ccMapping = $('#node-input-typed-cc').typedInput({ 
					types: [...commonTypes, ...kvSpecificTypes],
					noformvalidation: false
				});
                const bccMapping = $('#node-input-typed-bcc').typedInput({ 
					types: [...commonTypes, ...kvSpecificTypes],
					noformvalidation: false
				});
                const subMapping = $('#node-input-typed-subject').typedInput({ 
					types: [...commonTypesMandatory, ...kvSpecificTypesMandatory],
					noformvalidation: false
				});
                const bodyMapping = $('#node-input-typed-body').typedInput({ 
					types: [...commonTypes, ...kvSpecificTypes],
					noformvalidation: false
				});
                const htmlMapping = $('#node-input-typed-html').typedInput({ 
					types: [...commonTypes, ...kvSpecificTypes],
					noformvalidation: false
				});
                const attachmentMapping = $('#node-input-typed-attachment').typedInput({ types: commonTypes, noformvalidation: false });
                const routingoptionsMapping = $('#node-input-typed-routingoptions').typedInput({ types: [...commonTypes],  noformvalidation: false});
                const iCalMapping = $('#node-input-typed-iCal').typedInput({ types: [...commonTypes],  noformvalidation: false });
                const contentoptionsMapping = $('#node-input-typed-contentoptions').typedInput({ types: [...commonTypes],  noformvalidation: false});
                const headeroptionsMapping = $('#node-input-typed-headeroptions').typedInput({ types: [...commonTypes],  noformvalidation: false });
                const securityoptionsMapping = $('#node-input-typed-securityoptions').typedInput({ types: [...commonTypes],  noformvalidation: false });
                const resultMapping = $('#node-input-typed-resultMapping').typedInput({ types: commonTypesMandatory,  noformvalidation: false });
            },
            oneditsave: function () {
                const node = this;
                const form = $('#dialog-form');
                let __$ = form.find.bind(form);
                node.switchStates = {
                    attachment: __$('#attachment-switch').attr('title')
                }

                if (node.switchStates.attachment === 'Value') {
                    node.attachment = {};
                    node.attachment.type = $("#node-typedInput-attachment").typedInput('type');
                    node.attachment.value = $("#node-typedInput-attachment").typedInput('value');

                    // delete attachment name,value data
                    delete node._attachmentList;
                } else {
                    const attachmentArray = Object.keys(node._attachmentList).filter(k => k.startsWith('#attachment'))
                    .map(k => {
                        const section = k;
                        node._attachmentList[k].encoding = node._attachmentList[k].encoding ? node._attachmentList[k].encoding : 'utf8';
                        node._attachmentList[k].filename = node._attachmentList[k].filename ? node._attachmentList[k].filename : { type: 'str', value: '' };
                        node._attachmentList[k].filepath = node._attachmentList[k].filepath ? node._attachmentList[k].filepath : { type: 'bh', value: '' };
                        node._attachmentList[k].content = node._attachmentList[k].content ? node._attachmentList[k].content : { type: 'bh', value: '' };
                        return {
                            filename: node._attachmentList[k].filename,
                            filepath: node._attachmentList[k].filepath,
                            content: node._attachmentList[k].content,
                            encoding: node._attachmentList[k].encoding
                        }
                    });
                    if (attachmentArray.length) {
                        delete node.attachment;
                        node.attachment = attachmentArray;
                    } else {
                        delete node.attachment;
                    }
                }



                node.editableListData = node._editableListData ? JSON.parse(JSON.stringify(this._editableListData)) : [];
                node.attachmentList = node._attachmentList ? JSON.parse(JSON.stringify(node._attachmentList)) : {};
                delete node._editableListData;
                delete node._attachmentList;
                
            },
            docsLink: 'email-out-node'
        }
    });
</script>