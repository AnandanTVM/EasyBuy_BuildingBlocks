<script type="text/x-red" data-template-name="Mongodb">
    <!-- database config -->
    <div id="node-row-databaseConfig-container" class="editor-form-row"  style="display:flex; flex-direction:column; height: 2.6rem">
        <label style="width: auto;" for="node-input-databaseConfig" class="editor-form-row-label">
            <span data-i18n="executeSql.label.connection-name"></span>
        </label>
        <input static type="text" style="width: 100%" id="node-input-databaseConfig">
    </div>

    <!-- Collection -->
    <div class="http-container" >
        <label for="node-typedInput-collection" class="editor-form-row-label"><span data-i18n="mongodb.label.collection"></span></label>
        <div class="form-row  field-wrapper-typedInput http-element-container" id="node-input-collection-container">
            <input static type="text" id="node-input-typed-collection" ui-element-type="typedInput" class="node-input-property typed-input-width"
                style="width: 100% !important" />
        </div>
        <div class="error-msg-container"><span id="invalid-resultmapping-mapping-error" class="invalid-select display-none">Invalid Collection</span></div>
    </div>

    <!-- Operation -->
    <div id="operation-container" class="editor-form-row">
        <label><span>Operation</span></label>
        <select static id="node-input-operation" style="width: 100%;"></select>
    </div>

    <!-- Result -->
    <div class="editor-form-row">
        <label><span>Result Mapping</span></label>
        <input static type="text" id="node-input-typed-resultMapping" ui-element-type="typedInput" style="width:100%">
    </div>

    <!-- Options -->
    <div class="editor-form-row">
        <label><span>Options</span></label>
        <input static type="text" id="node-input-typed-options" ui-element-type="typedInput" style="width:100%">
    </div>

</script>

<script type="text/javascript">
    registerNode({
        nodeType: 'Mongodb',
        serviceType: 'server',
        nodeDef: {
            category: 'Storage',
            color: "#757575",
            defaults: {
                // input text fields
                name: { value: '', required: false },
                databaseConfig: { type: 'db-config', value: {}, required: true, options: { type: 'mongodb' , dbCategory: 'no-sql'} },
                collection: {
                    value: {
                        type: 'bh',
                        value: ''
                    },
                    required: true
                },
                options: {
                    value: '',
                    required: false
                },
                collection: {
                    value: {
                        type: 'bh',
                        value: ''
                    },
                    required: true
                },
                resultMapping: {
                    value: {
                        type: 'bh',
                        value: ''
                    },
                    required: true
                },
                operation: {
                    value: 'find'
                },
                argumentArray: {
                    value: []
                }
            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-mongodb/mongodb-node.svg",
            label: function (SRD) {
                return this.name || 'Mongodb'
            },
            paletteLabel: function (SRD) {
                return this.name || 'Mongodb'
            },
            initdefaults: function (SRD) {
                let defaults = this;
                operationsList = [
                        {
                            "value": "aggregate",
                            "displayValue": "aggregate",
                            "_args": [{ name: 'aggregate', displayName: 'Pipeline' }]
                        },
                        {
                            "value": "bulkWrite",
                            "displayValue": "bulkWrite",
                            "_args": [{ name: 'operations', displayName: 'Bulk operations' }]
                        },
                        {
                            "value": "countDocuments",
                            "displayValue": "countDocuments",
                            "_args": [{ name: 'query', displayName: 'Query' }]
                        },
                        {
                            "value": "createIndex",
                            "displayValue": "createIndex",
                            "_args": [{ name: 'fieldOrSpec', displayName: 'Keys' }]
                        },
                        {
                            "value": "deleteMany",
                            "displayValue": "deleteMany",
                            "_args": [{ name: 'filter', displayName: 'Filter' }]
                        },
                        {
                            "value": "deleteOne",
                            "displayValue": "deleteOne",
                            "_args": [{ name: 'filter', displayName: 'Filter' }]
                        },
                        {
                            "value": "distinct",
                            "displayValue": "distinct",
                            "_args": [{ name: 'key', displayName: 'Field' }, { name: 'query', displayName: 'Query' }]
                        },
                        {
                            "value": "deleteFile",
                            "displayValue": "deleteFile",
                            "_args": [{ name: 'docId', displayName: 'Document Id' }]
                        },
                        {
                            "value": "downloadFile",
                            "displayValue": "downloadFile",
                            "_args": [{ name: 'filter', displayName: 'Filter' }]
                        },
                        {
                            "value": "drop",
                            "displayValue": "drop",
                            "_args": []
                        },
                        {
                            "value": "dropIndex",
                            "displayValue": "dropIndex",
                            "_args": [{ name: 'indexName', displayName: 'Index name' }]
                        },
                        {
                            "value": "dropIndexes",
                            "displayValue": "dropIndexes",
                            "_args": []
                        },
                        {
                            "value": "estimatedDocumentCount",
                            "displayValue": "estimatedDocumentCount",
                            "_args": []
                        },
                        {
                            "value": "find",
                            "displayValue": "find",
                            "_args": [{ name: 'query', displayName: 'Query' }]
                        },
                        {
                            "value": "findOneAndDelete",
                            "displayValue": "findOneAndDelete",
                            "_args": [{ name: 'filter', displayName: 'Filter' }]
                        },
                        {
                            "value": "findOneAndReplace",
                            "displayValue": "findOneAndReplace",
                            "_args": [{ name: 'filter', displayName: 'Filter' }, { name: 'replacement', displayName: 'Replacement document' }]
                        },
                        {
                            "value": "findOneAndUpdate",
                            "displayValue": "findOneAndUpdate",
                            "_args": [{ name: 'filter', displayName: 'Filter' }, { name: 'update', displayName: 'Update document' }]
                        },
                        {
                            "value": "geoHaystackSearch",
                            "displayValue": "geoHaystackSearch",
                            "_args": [{ name: 'xAxis', displayName: 'X axis' }, { name: 'yAxis', displayName: 'Y axis' }]
                        },
                        {
                            "value": "indexExists",
                            "displayValue": "indexExists",
                            "_args": [{ name: 'indexes', displayName: 'Index name' }]
                        },
                        {
                            "value": "indexInformation",
                            "displayValue": "indexInformation",
                            "_args": []
                        },
                        {
                            "value": "indexes",
                            "displayValue": "indexes",
                            "_args": []
                        },
                        {
                            "value": "initializeOrderedBulkOp",
                            "displayValue": "initializeOrderedBulkOp",
                            "_args": []
                        },
                        {
                            "value": "initializeUnorderedBulkOp",
                            "displayValue": "initializeUnorderedBulkOp",
                            "_args": []
                        },
                        {
                            "value": "insertMany",
                            "displayValue": "insertMany",
                            "_args": [{ name: 'docs', displayName: 'Documents' }]
                        },
                        {
                            "value": "insertOne",
                            "displayValue": "insertOne",
                            "_args": [{ name: 'document', displayName: 'Document' }]
                        },
                        {
                            "value": "isCapped",
                            "displayValue": "isCapped",
                            "_args": []
                        },
                        {
                            "value": "listIndexes",
                            "displayValue": "listIndexes",
                            "_args": []
                        },
                        {
                            "value": "options",
                            "displayValue": "options",
                            "_args": []
                        },
                        {
                            "value": "reIndex",
                            "displayValue": "reIndex",
                            "_args": []
                        },
                        {
                            "value": "removeMany",
                            "displayValue": "removeMany",
                            "_args": [{ name: 'filter', displayName: 'Filter' }]
                        },
                        {
                            "value": "removeOne",
                            "displayValue": "removeOne",
                            "_args": [{ name: 'filter', displayName: 'Filter' }]
                        },
                        {
                            "value": "rename",
                            "displayValue": "rename",
                            "_args": [{ name: 'newName', displayName: 'New name'}]
                        },
                        {
                            "value": "replaceOne",
                            "displayValue": "replaceOne",
                            "_args": [{ name: 'filter', displayName: 'Filter'}, { name: 'doc', displayName: 'Document'}]
                        },
                        {
                            "value": "stats",
                            "displayValue": "stats",
                            "_args": []
                        },
                        {
                            "value": "updateMany",
                            "displayValue": "updateMany",
                            "_args": [{ name: 'filter', displayName: 'Filter'}, { name: 'update', displayName: 'Update document'}]
                        },
                        {
                            "value": "updateOne",
                            "displayValue": "updateOne",
                            "_args": [{ name: 'filter', displayName: 'Filter'}, { name: 'update', displayName: 'Update document'}]
                        },
                        {
                            "value": "uploadFile",
                            "displayValue": "uploadFile",
                            "_args": [{ name: 'filePath', displayName: 'File path'}, { name: 'fileName', displayName: 'File name'}]
                        },
                        {
                            "value": "watch",
                            "displayValue": "watch",
                            "_args": [{ name: 'pipeline', displayName: 'Pipeline' }]
                        }
                        ];

                        /*Attach all default values*/
                        for (let i = 0; i < operationsList.length; i++) {
                            const args = operationsList[i]._args;
                            for (let i =0 ; i < args.length; i ++) {
                                 defaults[args[i]['name']] = { value: '' };
                            }
                        }
                        return defaults;
            },
            oneditinit: function (SRD) {
                let node = this;
                const form = $('#dialog-form');
                let __$ = form.find.bind(form);

                collectionFieldTypes = [
                    { value: 'bh', label: 'bh.', validate: SRD.validators.typedInput('bh', true) },
                    { value: 'bh.input', label: 'bh.input.', validate: SRD.validators.typedInput('bh.input', true) },
                    { value: 'bh.local', label: 'bh.local.', validate: SRD.validators.typedInput('bh.local', true) },
                    { value: 'str', label: 'string', validate: SRD.validators.typedInput('str', true) },
                    { value: "process.env", label: 'env', validate: SRD.validators.typedInput('env', true) }
                ];

                dynamicFields = [
                    { value: 'bh', label: 'bh.', validate: SRD.validators.typedInput('bh', true)  },
                    { value: 'bh.input', label: 'bh.input.' , validate: SRD.validators.typedInput('bh.input', true) },
                    { value: 'bh.local', label: 'bh.local.' , validate: SRD.validators.typedInput('bh.local', true) }
                ];

                optionFieldTypes = [
                    { value: 'bh', label: 'bh.', nullable: true, nullableValue: undefined},
                    { value: 'bh.input', label: 'bh.input.', nullable: true, nullableValue: undefined },
                    { value: 'bh.local', label: 'bh.local.', nullable: true, nullableValue: undefined }
                ];

                
                function validateForm() {
					SRD.defaults.validateForm(true);
                }


                const typedInput = {
                    'collection': collectionFieldTypes,
                    'options': optionFieldTypes
                };

                __$('input[static]').each(function (i) {
                    const elm = $(this);
                    if (elm.attr('ui-element-type') === 'typedInput') {
                        const field = elm.attr('id').replace('node-input-typed-', '');
                        elm.typedInput({
                            types: (typedInput[field] ? typedInput[field] : dynamicFields),
							noformvalidation: false,
                        })
                    } else {
                        elm.inputField()
                    }
                });

                function hadleDisplayFields(val) {
                    __$('div[canDelete="true"]').each(function(i) {
                        $(this).hide(); // Hide all the previous attributes when operation is changed
                    });
                    const operationIndex = operationsList.findIndex(a => a.value === val);
                    if (operationIndex > -1) {
                        for (let i = 0; i < operationsList[operationIndex]._args.length; i++) {
                            const containerId = `node-typedInput-${operationsList[operationIndex]._args[i]['name']}-container`;
                            if (!$(`#${containerId}`).length) {
                                const inputId = `node-input-typed-${operationsList[operationIndex]._args[i]['name']}`;
                                const el = $(`<div class="editor-form-row" id="${containerId}" canDelete="true">
                                                    <label><span>${operationsList[operationIndex]._args[i]['displayName']}</span></label>
                                                    <input type="text" id="${inputId}" ui-element-type="typedInput" style="width:100%">
                                                    </div>`);
                                $(el).find(`#${inputId}`).typedInput({
                                    types: dynamicFields,
									noformvalidation: false,
                                });
                                $(inputId).inputField({
                                    value: node[operationsList[i]] || ''
                                });
                                $('#operation-container').after(el);
                            }
                            $(`#${containerId}`).show();
                        }
                    }
                }

                $('#node-input-operation').selectField({
                    optionsData: operationsList,
                    showError: true,
                    disableDoneIfInvalid: true,
                    validateOnCreate: true,
                    props: {
                        requirmethodTypedInputEleed: true
                    },
                    value: node.operation ? node.operation : operationsList[0].value,
                    change: function (val) {
                        hadleDisplayFields(val);
                        validateForm();
                    }
                });
                validateForm();
                hadleDisplayFields(node.operation ? node.operation : operationsList[0].value);
            },
            onpropertieschange: function (changes) {
                    node = this;
                    const operationIndex = operationsList.findIndex(a => a.value === this.operation);
                    node.argumentArray = operationsList[operationIndex]._args.map(x => x.name);
            },
            docsLink: 'mongodb-node'
        }
    });
</script>