<script type="text/x-red" data-template-name="AMQPProducer"></script>
<script type="text/javascript">
    registerNode({
        nodeType: 'AMQPProducer',
        serviceType: 'server',
        nodeDef: {
            color: "#99c",
            category: 'Messaging',
            inputs: 1,
            outputs: 1,
            icon: "ndefault-amqp-producer/amqp-node.svg",
            label: function () {
                return this.name || 'AMQP Producer';
            },
            paletteLabel: function () {
                return 'AMQP Producer';
            },
            initdefaults: function (n, S) {
                const env = 'server_env';
                const str = { label: 'string', value: 'str', validate: S.validators.typedInput('str', true) };
                const assertNullable = { nullable: true, nullableValue: JSON.stringify({ durable: true }) };
                const publishNullable = { nullable: true, nullableValue: JSON.stringify({ persistent: true }) };
                const requiredbh = ['bh', 'bh.input', 'bh.local'];
                const bhTypes = [
                    { value: 'bh', label: 'bh.', validate: S.validators.typedInput('bh') },
                    { value: 'bh.input', label: 'bh.input.', validate: S.validators.typedInput('bh.input') },
                    { value: 'bh.local', label: 'bh.local.', validate: S.validators.typedInput('bh.local') }
                ]
                const defaults = {
					name: { value: '' },
                    amqpConfigId: {
                        attrDef: { label: 'AMQP Config' },
                        type: 'amqp-config', value: {}, required: true, options: {}
                    },
                    producerQ: {
                        attrDef: {
                            attrType: 'TYPED_INPUT', label: 'Producer Queue',
                            options: { types: [env, str, ...requiredbh] }
                        },
                        value: { type: 'server_env', value: '' }
                    },
                    assertQueueOptions: {
                        attrDef: {
                            attrType: 'TYPED_INPUT', label: 'Assert Queue Options',
                            options: { types: bhTypes.map(v => ({ ...v, ...assertNullable })) }
                        },
                        value: { type: 'bh', value: '' }
                    },
                    messageType: {
                        attrDef: {
                            attrType: 'TYPED_INPUT', label: 'Message Type',
                            options: {
                                types: [
                                    { value: 'JSON', label: 'JSON', constant: true },
                                    { value: 'Buffer', label: 'Buffer', constant: true },
                                    { value: 'String', label: 'String', constant: true },
                                    ...requiredbh
                                ]
                            }
                        },
                        value: { type: 'JSON', value: '', constant: true }
                    },
                    message: {
                        attrDef: {
                            attrType: 'TYPED_INPUT', label: 'Message',
                            options: { types: [str, 'literal', ...requiredbh] }
                        },
                        value: { type: 'bh.input', value: '' }
                    },
                    publishOptions: {
                        attrDef: {
                            attrType: 'TYPED_INPUT', label: 'Publish Options',
                            options: { types: bhTypes.map(v => ({ ...v, ...publishNullable })) }
                        },
                        value: { type: 'bh', value: '' }
                    }
                };

                return defaults;
            },
            docsLink: 'amqp-producer-node'
        }
    });
</script>