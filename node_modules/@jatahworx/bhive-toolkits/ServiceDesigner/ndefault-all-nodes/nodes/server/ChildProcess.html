<script type="text/x-red" data-template-name="ChildProcess">
    <!-- Command -->
    <div class="editor-form-row">
        <label for="node-input-typed-command"><span data-i18n="childProcess.placeholder.command"></span></label>
        <input type="text" id="node-input-typed-command" ui-element-type="typedInput" style="width: 100%;">
    </div>

    <!-- Output -->
    <div class="editor-form-row">
        <label for="node-input-outputType" class="label-input"><span
                data-i18n="childProcess.placeholder.outputType"></span>
        </label>
        <select style="width:100%;" type="text" id="node-input-outputType">
            <option value="execSync" title="Choose this mode to get the result after the command is executed"> Exec mode </option>
            <option value="spawn" title="Choose this mode to get events while the command is getting executed"> Spawn mode </option>
            <option value="fork" title="Choose this mode to get events while the command is getting executed with built-in IPC"> Fork mode </option>
        </select>
    </div>

    <input type="hidden" id="node-input-outputs" />

    <!-- Command Options-->
    <div class="editor-form-row">
        <label for="node-input-typed-commandOptions"><span
                data-i18n="childProcess.placeholder.commandOptions"></span></label>
        <input type="text" id="node-input-typed-commandOptions" ui-element-type="typedInput" style="width: 100%;">
    </div>

    <!-- Spawn args -->
    <div class="editor-form-row" id="node-input-spawnArgs-container">
        <label for="node-input-typed-spawnArgs"><span data-i18n="childProcess.placeholder.spawnArgs"></span></label>
        <input type="text" id="node-input-typed-spawnArgs" ui-element-type="typedInput" style="width: 100%;">
    </div>

    <!-- Result Mapping -->
    <div class="editor-form-row" id="node-input-resultMapping-container">
        <label for="node-input-typed-resultMapping"><span
                data-i18n="childProcess.placeholder.resultMapping"></span></label>
        <input type="text" id="node-input-typed-resultMapping" ui-element-type="typedInput" style="width:100%">
    </div>

    <!-- Spawn result mapping -->
    <div id="node-spawn-resultMapping-container">
        <div style="margin-top: 2.3em;margin-bottom: 0.5em;font-weight: 300;"">
            <span>Result Mapping</span>
        </div>

        <div class="editor-form-row">
            <label for="node-input-typed-processInstance"><span data-i18n="childProcess.placeholder.processInstance"></span></label>
            <input type="text" id="node-input-typed-processInstance" ui-element-type="typedInput" style="width:100%">
        </div>

        <div class="editor-form-row">
            <label for="node-input-typed-stdout"><span data-i18n="childProcess.placeholder.stdout"></span></label>
            <input type="text" id="node-input-typed-stdout" ui-element-type="typedInput" style="width:100%">
        </div>

        <div class="editor-form-row">
            <label for="node-input-typed-stderr"><span data-i18n="childProcess.placeholder.stderr"></span></label>
            <input type="text" id="node-input-typed-stderr" ui-element-type="typedInput" style="width:100%">
        </div>

        <div class="editor-form-row">
            <label for="node-input-typed-close"><span data-i18n="childProcess.placeholder.close"></span></label>
            <input type="text" id="node-input-typed-close" ui-element-type="typedInput" style="width:100%">
        </div>
    </div>

</script>

<script type="text/javascript">
    registerNode({
        nodeType: 'ChildProcess',
        serviceType: 'server',
        nodeDef: {
            color: "#6F51FF",
            category: 'Function',
            defaults: {
                name: {
                    value: ''
                },
                command: {
                    value: '',
                    required: true
                },
                outputType: {
                    value: 'execSync'
                },
                resultMapping: {
                    value: '',
                    required: true
                },
                commandOptions: {
                        value: ''
                },
                processInstance: {
                    value: '',
                    required: true
                },
                stdout: {
                    value: '',
                    required: true
                },
                stderr: {
                    value: '',
                    required: true
                },
                close: {
                    value: '',
                    required: true
                },
                spawnArgs: {
                    value: [],
                    required: true
                },
                outputs: {
                    value: 1
                }

            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-all-nodes/child-process-node.svg",
            paletteLabel: function (def) {
                return 'Child Process';
            },
            label: function () {
                return this.name || 'Child Process'
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            initdefaults: function () {
                let defaults = this;
                defaults['spawnArgs'] = {
                    value: undefined
                };
                defaults['commandOptions'] = {
                    value: undefined
                };
                return defaults;
            },
            oneditinit: function (SRD) {
                const bhInputTypes = [{
                        value: 'bh',
                        label: 'bh.',
                        validate: SRD.validators.typedInput('bh', true)
                    },
                    {
                        value: 'bh.input',
                        label: 'bh.input.',
                        validate: SRD.validators.typedInput('bh.input', true)
                    },
                    {
                        value: 'bh.local',
                        label: 'bh.local.',
                        validate: SRD.validators.typedInput('bh.local', true)
                    }
                ];

                const optionFieldTypes = [{
                        value: 'bh',
                        label: 'bh.',
                        nullable: true,
                        nullableValue: undefined
                    },
                    {
                        value: 'bh.input',
                        label: 'bh.input.',
                        nullable: true,
                        nullableValue: undefined
                    },
                    {
                        value: 'bh.local',
                        label: 'bh.local.',
                        nullable: true,
                        nullableValue: undefined
                    }
                ];

                const stringInputType = [{
                    value: 'str',
                    label: 'string',
                    validate: SRD.validators.typedInput('str', true)
                }]

                const validateFormObj = {
                    // onvalchanged: validateForm,
					// change: validateForm
					noformvalidation: false
                };

                const outputCount = $("#node-input-outputs").val(1);

                function initTypedInputs() {
                    const nodeName = $(`#node-input-name`).inputField();

                    $('#node-input-typed-resultMapping').typedInput({
                        types: bhInputTypes,
                        ...validateFormObj
                    });

                    $('#node-input-typed-stdout').typedInput({
                        types: bhInputTypes,
                        ...validateFormObj
                    });

                    $('#node-input-typed-stderr').typedInput({
                        types: bhInputTypes,
                        ...validateFormObj
                    });

                    $('#node-input-typed-close').typedInput({
                        types: bhInputTypes,
                        ...validateFormObj
                    });

                    $('#node-input-typed-command').typedInput({
                        types: [...stringInputType, ...bhInputTypes],
                        ...validateFormObj
                    });

                    $('#node-input-typed-commandOptions').typedInput({
                        types: optionFieldTypes,
                        ...validateFormObj
                    });

                    $('#node-input-typed-spawnArgs').typedInput({
                        types: optionFieldTypes.map(obj => ({
                            ...obj,
                            validate: SRD.validators.typedInput(obj.value, true)
                        })),
                        ...validateFormObj
                    });

                    $('#node-input-typed-processInstance').typedInput({
                        types: bhInputTypes,
                        ...validateFormObj
                    });

                    $('#node-input-outputType').selectField({
                        change: (val) => {
                            toggleFields(val);
                            SRD.defaults.validateForm(true);
                        }
                    });
                }

                function toggleFields(outputType) {
                    if (outputType === 'spawn' ) {
                        outputCount.val(3)
                        $('#node-input-spawnArgs-container').show();
                        $('#node-spawn-resultMapping-container').show();
                        $('#node-input-resultMapping-container').hide();
                    }else if( outputType === 'fork'){
                        outputCount.val(1);
                        $('#node-input-spawnArgs-container').show();
                        $('#node-spawn-resultMapping-container').hide();
                        $('#node-input-resultMapping-container').show();
                    } else {
                        outputCount.val(1);
                        $('#node-input-spawnArgs-container').hide();
                        $('#node-spawn-resultMapping-container').hide();
                        $('#node-input-resultMapping-container').show();
                    }
                }
                initTypedInputs();
            },
            docsLink: 'child-process-node'
        }
    });
</script>