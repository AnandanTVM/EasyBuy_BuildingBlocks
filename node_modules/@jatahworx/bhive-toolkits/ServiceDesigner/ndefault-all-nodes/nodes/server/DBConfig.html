// TODO: @sankarshanaj - set "docsLink" property
<script type="text/x-red" data-template-name="db-config">
    <div class="editor-form-row" id="disabledb-container">
        <input type="checkbox" id="node-input-disabledb">
    </div>
</script>
<script type="text/javascript">
    registerNode({
        nodeType: 'db-config',
        serviceType: 'server',
        nodeDef: {
            category: 'config',
            defaults: {
                dbOption: { value: {} },
                disabledb: { value: false },
                selectedDB: { value: '' },
                selectedOption: { value: '' },
                dbCategory: { value: '' }
            },
            paletteLabel: 'Database',
            label: function () {
                return this.name || (this.dbOption && this.dbOption.name) || "db-config";
            },
            labelStyle: function () {
                return this.name || (this.dbOption && this.dbOption.name) ? "node_label_italic" : "";
            },
            oneditinit: function (SRD, nodeOptions) {
                let node = this;
                node.funcs = {};
                const doneBtn = $('#node-config-dialog-ok');
                const form = $('#node-config-dialog-edit-form');
                let __$ = form.find.bind(form);
                if (SRD.models && SRD.models.connections && SRD.models.connections.db) {
                    node.existingDBConfigNodesArr = SRD.nodes.filterConfigNodes({ type: 'db-config' });
                    function hideAll() {
                        __$('.db-options-clearer').hide();
                    }
                    function validateForm() {
                        if ([...__$('.input-error')].some(e => !$(e).is(
                            ':hidden'))) {
                            doneBtn.addClass('disabled');
                        } else {
                            doneBtn.removeClass('disabled');
                        }
                    }
                    function appendSelect(options) {
                        if (options.appendToSelector) {
                            let selectContainer = $(`<div id="node-input-select-container"></div>`)
                            $(options.appendToSelector).append(selectContainer);
                            let selectElement = $(`
                    <select id="node-input-${options.name}" style="width:100%" required class="no-error-element"></select>
                   `);
                            selectContainer.append('<label for="' + 'node-input-' + options.name + '">Database Options</label>')
                            selectContainer.append(selectElement);
                            __$(`#node-input-${options.name}`).selectField({
                                value: options.value,
                                optionsData: options.data,
                                placeholder: options.placeholder,
                                change: options.change,
								required: options.required,
								noformvalidation: options.noformvalidation
                            })
                        }
                    }
                    let dbModelArr = SRD.models.connections.db.filter(v => v.enabled);
                    node.funcs.getAllDBTypes = function (dbCategory) {
                        let names = [];
                        if (dbModelArr instanceof Array) {
                            for (let i = 0; i < dbModelArr.length; i++) {
                                if (!dbCategory || (dbCategory && dbModelArr[i].dbCategory == dbCategory)) {
                                    names.push({
                                        displayValue: dbModelArr[i].type,
                                        value: dbModelArr[i].type,
                                        name: dbModelArr[i].name,
                                        type: dbModelArr[i].type,
                                    })
                                }

                            }
                        }
                        return names;
                    }

                    function populateDB() {
                        let domArr = [];
                        for (let db of dbModelArr) {
                            let dOptional = [`<div><div id="db-options-${db.name}" class="db-options-clearer accordion">
                                <h3 class="pallete-category-title cursor-pointer">Optional <img src="assets/pallete_icons/arrow_down.svg"></h3>
                                <div class="placeholder">`];
                            let dRequired = [
                                `<div id="db-options-${db.name}-required" class="db-options-clearer">`,
                                `<input type="text" name="name" id="node-input-${db.name + '_name'}" class="dbname"/>`];
                            node._def.defaults[db.name + '_name'] = {
                                value: ''
                            }
                            node._def.defaults[db.name + '_type'] = {
                                value: ''
                            }
                            if (db.fields instanceof Array) {
                                for (let field of db.fields) {
                                    node._def.defaults[db.name + '_' + field.name] = {
                                        value: '',
                                        required: field.required
                                    }
                                    let input = '';
                                    let label = `<label for="node-input-${db.name + '_' + field.name}" class="editor-form-row-label">${field.label}</label>`;
                                    if (field.name === 'type') {
                                        label = '';
                                        input = `<input id="node-input-${db.name + '_type'}" style="width:100%" type="text" class="dbtype">`;
                                    } else {
                                        input = `
                                        <div id="node-input-faster-typed-${db.name + '_' + field.name}">
                                            <button class="label"></button>
                                            <input/>
                                        </div>
                                        `;
                                    }
                                    if (field.name !== 'type') {
                                        if (field.required) {
                                            dRequired.push(label);
                                            dRequired.push(input);
                                        } else {
                                            dOptional.push(label);
                                            dOptional.push(input);
                                        }
                                    } else {
                                        dRequired.push(label);
                                        dRequired.push(input);
                                    }
                                }
                            }
                            dOptional.push('</div></div></div></div>');
                            domArr = domArr.concat(dRequired).concat(dOptional);
                            // node._def.defaults['dbCategory'] = db.dbCategory;
                        }
                        form.append($(domArr.join('')));
                    }
                    function typingInputs() {
                        for (let db of dbModelArr) {
                            if (db.fields instanceof Array) {
                                for (let field of db.fields) {
                                    let id = `${db.name}_${field.name}`;
                                    let t = __$(`#node-input-faster-typed-${SRD.utils.cssQueryFilter(id)}`);
                                    let type = '';
                                    let types = ['server_env'];
                                    if (field.type === 'text' || field.type === 'password') {
                                        type = 'str';
                                        types.unshift({ value: 'str', label: 'string' });
                                    } else if (field.type === 'number') {
                                        type = 'num';
                                        types.unshift({ value: 'num', label: 'number', validate: /^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/, error_msg: 'value should be numeric type' });
                                    } else if (field.type === 'boolean') {
                                        type = 'bool';
                                        types.unshift(type);
                                    }
                                    t.typedInputFaster({
                                        types: types,
                                        noerror: true,
                                        required: field.required,
                                        input: () => {
                                            validateForm()
                                        }
                                    });
                                    t.typedInputFaster('type', type);
                                    t.typedInputFaster('value', field.value);
                                }
                            }
                        }
                    }

                    /**
                     *  condition to exclude the select option for mongodb and mssql
                     */
                    if ((!node.selectedDB) && !(nodeOptions && nodeOptions.hasOwnProperty('dbCategory') && (nodeOptions.dbCategory == 'no-sql'))) {
                        appendSelect({
                            appendToSelector: '#node-config-dialog-edit-form',
                            name: 'selectedOption',
                            placeholder: 'Select Database type',
                            data: node.funcs.getAllDBTypes(nodeOptions ? nodeOptions.dbCategory : undefined),
							value: (node.dbOption && node.dbOption.type) || undefined,
							required: true,
							noformvalidation: false,
                            change: (dbType) => {
                                __$('.db-options-clearer').hide();
                                __$(`#db-options-${dbType}`).show();
                                __$(`#db-options-${dbType}-required`).show();
                                node.selectedDB = dbType;
                            }
                        })
                    }

                    populateDB();
                    typingInputs();
                    __$('.accordion')
                        .accordion({
                            animate: 100,
                            heightStyle: "content",
                            collapsible: true,
                            header: '.pallete-category-title',
                            icons: {
                                header: 'ui-icon-plus',
                                activeHeader: 'ui-icon-minus'
                            },
                            collapsible: true,
                            active: false
                        });
                    hideAll();
                }
            },
            oneditprepare: function (SRD, nodeOptions) {
                let node = this;
                const form = $('#node-config-dialog-edit-form');
                let __$ = form.find.bind(form);
                function showDB(dbType) {
                    __$(`#db-options-${dbType}`).show();
                    __$(`#db-options-${dbType}-required`).show();
                    __$('#node-input-select-container').hide();
                }
                function computeDBName(dbType, number) {
                    if (typeof number !== "number") throw new Error('Invalid number for computing db name');
                    let name = dbType + '_' + number;
                    if (node.existingDBConfigNodesArr instanceof Array) {
                        for (let i = 0; i < node.existingDBConfigNodesArr.length; i++) {
                            const db = node.existingDBConfigNodesArr[i].dbOption;
                            if (db && db.type === dbType && db.name === name) {
                                name = computeDBName(dbType, number + 1);
                            }
                        }
                    }
                    return name;
                }
                function covertToInput() {
                    let dbs = node.funcs.getAllDBTypes();
                    for (let i = 0; i < dbs.length; i++) {
                        let dbe = __$(`#node-input-${dbs[i].name + '_' + 'name'}`);
                        let dbte = __$(`#node-input-${dbs[i].name + '_type'}`);
                        if (dbe.length) {
                            dbe.inputField({
                                placeholder: 'Connection Name',
                                wrapperClass: 'editor-form-row',
                                value: (node.dbOption && node.dbOption.name) || computeDBName(dbs[i].name, 0),
                                validatorRegexp: SRD.validators.patterns.noblank
                            });
                        }
                        if (dbte.length) {
                            dbte.inputField({
                                placeholder: 'Type',
                                wrapperClass: 'editor-form-row',
                                value: (node.dbOption && node.dbOption.type) || dbs[i].type,
                                disabled: true
                            })
                        }
                    }
                }
                covertToInput();
                __$(`#node-input-disabledb`).toggleButton({
                    label: 'Disable Database'
                });
                __$(`#disabledb-container`).hide()
                if (node.selectedDB) {
                    showDB(node.selectedDB);
                    __$(`#disabledb-container`).show();
                } else if (nodeOptions && nodeOptions.hasOwnProperty('dbCategory')) {
                    if (nodeOptions.dbCategory != 'sql') {
                        node.selectedDB = nodeOptions.type;
                        showDB(node.selectedDB);
                    }

                }
            },
            oneditsave: function (SRD) {
                let node = this;
                let dbOption = {
                    name: node[node.selectedDB + '_name'],
                    type: node[node.selectedDB + '_type']
                };
                let nodeKeys = Object.keys(node);
                for (let i = 0; i < nodeKeys.length; i++) {
                    if (nodeKeys[i].startsWith(node.selectedDB)) {
                        if (nodeKeys[i].includes('.') && typeof node[nodeKeys[i]] === 'object') {
                            const o = nodeKeys[i].substr(nodeKeys[i].indexOf('.'), nodeKeys[i].length);
                            dbOption[o] = node[nodeKeys[i]];
                        } else if (!nodeKeys[i].includes('.')) {
                            const o = nodeKeys[i].substr(node.selectedDB.length + 1, nodeKeys[i].length);
                            dbOption[o] = node[nodeKeys[i]];
                        }
                    }
                }
                node.dbOption = dbOption;
                node.selectedDB = node.selectedOption = dbOption.type;
                // node.dbOption.dbCategory = node._def.defaults.dbCategory;

                if (node.dbOption.type == 'mongodb') {
                    node.dbCategory = 'no-sql'
                } else {
                    node.dbCategory = 'sql'
                }

                if(node.dbOption.type === 'oracle') {
                    // node.dbOption.connectString = `(DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = ${node.dbOption.host})(PORT = ${node.dbOption.port}))(CONNECT_DATA = (SERVER = DEDICATED)(SERVICE_NAME = ${node.dbOption.serviceName})))`;
                }
            }
        }
    })
</script>