<script type="text/x-red" data-template-name="CORS">
<!-- origin Section -->
<div class="editor-form-row" id="origin-toggle-section">
    <input id="node-input-origin" type="checkbox">
    <button class="map-button-wrp" title="Create Origins List">
        <image class="node-input-parse-col-button map-button proxy-map-value-toggle-headers"
            src="assets/serviceDesigner/refresh.svg"></image>
    </button>
</div>
<div class="editor-form-row margin-bottom-0" id="origin-section" >
    <div class="props-section">
        <label for="origin-section" class="label-input">Origin</label>
        <div class="srd-editableList-add-kv-wrp">
            <input type="text" class="property-key" id="origin" ignore style="width:91%;">
        </div>
        <div class="properties-container" validatesform="true">
            <ol id="origin-list"></ol>
        </div>
        <span class="list-keys-invalid">Editable List Invalid Message</span>
    </div>
</div>
<!-- origin Section End -->

<!-- methods Section -->
<div class="editor-form-row margin-bottom-0 " >
    <label for="methods-section" class="label-input">Methods</label>
    <div id="methods-section" class="props-section">
        <div class="srd-editableList-add-kv-wrp">
            <select class="property-key" id="methods" style="width:100%"></select>
        </div>
        <div class="properties-container" validatesform="true">
            <ol id="methods-list"></ol>
        </div>
        <span class="list-keys-invalid">Editable List Invalid Message</span>
    </div>
</div>
<!-- methods Section End -->

<!-- allowedHeaders Section -->
<div class="editor-form-row margin-bottom-0 " >
    <label for="allowedHeaders-section" class="label-input">Allowed headers</label>
    <div id="allowedHeaders-section" class="props-section">
        <div class="srd-editableList-add-kv-wrp">
            <input type="text" class="property-key" id="allowedHeaders">
        </div>
        <div class="properties-container" validatesform="true">
            <ol id="allowedHeaders-list"></ol>
        </div>
        <span class="list-keys-invalid">Editable List Invalid Message</span>
    </div>
</div>
<!-- allowedHeaders Section End -->

<!-- exposedHeaders Section -->
<div class="editor-form-row margin-bottom-0 " >
    <label for="exposedHeaders-section">Exposed headers</label>
    <div id="exposedHeaders-section" class="props-section">
        <div class="srd-editableList-add-kv-wrp">
            <input type="text" class="property-key" id="exposedHeaders">
        </div>
        <div class="properties-container" validatesform="true">
            <ol id="exposedHeaders-list"></ol>
        </div>
        <span class="list-keys-invalid">Editable List Invalid Message</span>
    </div>
</div>
<!-- exposedHeaders Section End -->

<!-- Credentials -->
<div class="editor-form-row margin-bottom-05 " >
    <input id="node-input-credentials" type="checkbox">
</div>

<!-- maxAge-->
<div class="editor-form-row">
    <input type="number" id="node-input-maxAge" placeholder="Max Age">
</div>

<!-- Pre-flight Continue -->
<div class="editor-form-row margin-bottom-05 " >
    <input id="node-input-preflightContinue" type="checkbox">
</div>

<!-- optionsSuccessStatus-->
<div class="editor-form-row">
    <input type="number" id="node-input-optionsSuccessStatus" placeholder="Options success status" ignore>
</div>
</script>
<script type="text/javascript">
    registerNode({
        nodeType: 'CORS',
        serviceType: 'server',
        nodeDef: {
            category: 'Global',
            color: "#B8B2A6",
            inputs: 1,
            outputs: 1,
            icon: "ndefault-all-nodes/cors-node.svg",
            defaults: {
				name: { value: '' },
                methods: {
                    value: []
                },
                origin: { value: true },
                editableListData: {
                    value: {
                        methods: [],
                        allowedHeaders: [],
                        exposedHeaders: []
                    }
                },
                showOriginToggleButton: {
                    value: true
                },
                credentials: {
                    value: false,
                    required: false
                },
                maxAge: {
                    value: '',
                    validate: function (v) {
                        if (typeof v === 'string' && v.match(/^(\s*|\d+)$/)) {
                            return true;
                        } else {
                            return false;
                        }
                    }
                },
                preflightContinue: {
                    value: false,
                    required: false
                },
                optionsSuccessStatus: {
                    value: ''
                }
            },
            paletteLabel: function (def) { return 'CORS'; },
            label: function () {
                return this.name || "CORS";
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function (SD) {
                const node = this;
                const form = $('#dialog-form');
                const fieldPrefix = 'node-input-';
                const methods = [
                    { value: 'GET', displayValue: 'GET' },
                    { value: 'POST', displayValue: 'POST' },
                    { value: 'PUT', displayValue: 'PUT' },
                    { value: 'DELETE', displayValue: 'DELETE' },
                    { value: 'PATCH', displayValue: 'PATCH' },
                    { value: 'OPTIONS', displayValue: 'OPTIONS' }
                ];
                const allowedHeaders = []
                const selectOptions = {
                    methods: {
                        optionsData: methods,
                        value: node.methods
                    }
                };
                form.find('input[type="text"]:not([ignore]), input[type="number"]:not([ignore])').each(function () {
                    const inputElm = $(this);
                    inputElm.inputField();
                });

                form.find('#node-input-optionsSuccessStatus').inputField({
                    validator: function (v) {
                        return {valid: v === '' || SD.utils.isValidHttpStatusCode(v), errorMessage: 'Not a valid http status code'};
                    },
                    noformvalidation: false
                });
                form.find('select').each(function () {
                    selectElm = $(this);
                    const field = selectElm.attr('id').replace(fieldPrefix, '');
                    selectElm.selectField(selectOptions[field]);
                });
                form.find('#accordion').accordion({
                    active: false,
                    animate: 75,
                    heightStyle: "content",
                    collapsible: true,
                    activate: function (event, ui) {
                        ui.oldHeader.find('img').removeClass('rotate-icon');
                        ui.newHeader.find('img').addClass('rotate-icon');
                    }
                });
                function hideOriginEditableList() {
                    $('#origin-section').hide();
                    $('#origin-toggle-section').show();
                }
                function hideOriginToggleButton() {
                    $('#origin-toggle-section').hide();
                    $('#origin-section').show();
                }

                function updateEditableListData(prop, val, currentRowIdArr, section) {
                    const i = node._editableListData[section].findIndex(element => currentRowIdArr === element['rowId']);
                    node._editableListData[section][i][prop] = val;
                    return i;
                }

                function validate(checkUnique, section, editableList) {
                    SD.defaults.validateForm(SD.validators.editableList(editableList.closest('.properties-container'), editableList, {
                        checkUniquenessOn: checkUnique && node._editableListData[section].map(x => x.key),
                        checkValidityOn: node._editableListData[section],
                        errorMsgContainer: $(`#${section}-section span.list-keys-invalid`)
                    }));
                }

                function updations(prop, elemData, inputVal, container, section, checkUnique) {
                    let index = updateEditableListData(prop, inputVal, container.data().data.rowData.rowId, section);
                    node._editableListData[section][index].valid = elemData ? elemData.valid : true;
                    container.data('data', { rowData: node._editableListData[section][index] });
                    validate(checkUnique, section, $(`#${section}-section ol`));
                }

                function createEditableListHeaders(headerTitles, propertiesContainer) {
                    if (headerTitles instanceof Array && headerTitles.length) {
                        const propertiesHeaderContainer = $(`<div class="properties-header-container"></div>`).prependTo(propertiesContainer);
                        headerTitles.forEach((header, i) => {
                            const style = header.style || '';
                            const classList = `editableList-header ${header.classList || ''}`
                            propertiesHeaderContainer.append(`<div class="${classList}" style="${style}">${header.title}</div>`);
                        });
                    }
                }

                function onItemRemoved(data, sectionType, propertiesContainer, checkUnique) {
                    node._editableListData[sectionType] = node._editableListData[sectionType].filter(vObj => vObj['rowId'] !== data.rowData.rowId);
                    validate(checkUnique, sectionType, propertiesContainer);
                    if (node._editableListData[sectionType].length === 0) {
                        propertiesContainer.hide();
                    }
                }

                // sectionType, headerTitles = [], checkUnique = true, headerFieldType, disabledRow = false
                function prepareEditableList(options) {
                    let sectionType = options.sectionType;
                    let headerTitles = options.headerTitles || [];
                    let checkUnique = options.checkUnique || true;
                    let headerFieldType = options.headerFieldType;
                    let disabledRow = options.disabledRow || false;
                    let mapperButton = options.mapperButton;
                    let isTypedInput = options.isTypedInput;
                    let keyField = $(`#${sectionType}-section .property-key`);
                    if (headerFieldType === 'typedInput') {
                        keyField.typedInput({
                            types: ['str', 're', { value: 'process.env', label: 'env'}],
                            value: '',
                            type: 'str'
                        })
                    } else if (headerFieldType === 'select') {
                        keyField.selectField('option', 'validatorRegexp', SD.validators.patterns.noblank);
                    } else {
                        keyField = keyField.inputField('option', 'validatorRegexp', SD.validators.patterns.noblank);
                    }
                    const propertiesContainer = $(`#${sectionType}-section .properties-container`);
                    const invalidListMsg = $(`#${sectionType}-section .list-keys-invalid`);

                    createEditableListHeaders(headerTitles, propertiesContainer);
                    if (!node._editableListData) node._editableListData = {};
                    node._editableListData[sectionType] = [];
                    const editableList = $(`#${sectionType}-list`).data({ valid: true, isUnique: true, isValid: true, isTypedInput: isTypedInput });
                    editableList.editableList({
                        addItem: function (container, i, data) {
                            const rowData = data.rowData || {};
                            const isTypedInput = $(`#${sectionType}-list`).data().isTypedInput;
                            const inputOptions = {
                                validatorRegexp: SD.validators.patterns.noblank,
                                disabled: disabledRow,
                                value: rowData.key || keyField.val(),
                                noErrorElement: true
                            }
                            function update(elemData, inputVal) {
                                container.attr('id', dataObj.rowId).data('data', { rowData: dataObj });
                                updations('key', elemData, inputVal, container, sectionType, checkUnique);
                            }

                            function typedInputUpdate(v) {
                                dataObj.type = listKey.typedInput('type');
                                dataObj.key = listKey.typedInput('value');
                                container.attr('id', dataObj.rowId).data('data', {
                                    rowData: dataObj
                                })
                                updations('key', dataObj, dataObj.key, container, sectionType, checkUnique);
                            }
                            if (isTypedInput) {
                                inputOptions.types = ['str', 're', { value: 'process.env', label: 'env'}];
                                inputOptions.onvalchanged = typedInputUpdate;
                                inputOptions.type = rowData.type || keyField.typedInput('type') || 'str';
                            } else {
                                inputOptions.updations = update;
                            }

                            const listKey = $(`<input type="text" class="property-key" ${isTypedInput ? 'style="width:85%"' : 'style="width:100%"'}/>`)
                                .appendTo(container)
                            [isTypedInput ? 'typedInput' : 'inputField'](inputOptions);

                            if (isTypedInput) {
                                listKey.typedInput('type', inputOptions.type);
                                listKey.typedInput('value', inputOptions.value);
                            }

                            var dataObj = {
                                key: listKey.val(),
                                rowId: rowData.rowId || SD.nodes.id(),
                                valid: true,
                                type: inputOptions.type
                            };

                            node._editableListData[sectionType].push(dataObj);
                            propertiesContainer.show();
                            container.attr('id', dataObj.rowId).data('data', { rowData: dataObj });

                            /* Clear the "Add" Section input fields */
                            if (headerFieldType === 'typedInput') {
                                keyField.typedInput('value','');
                            } 
                            if (!headerFieldType) {
                                keyField.inputField('reset');
                            }
                        },
                        addButton: true,
                        showAddBtnLabel: false,
                        removable: true,
                        scrollOnAdd: true,
                        removeItem: function (data) {
                            onItemRemoved(data, sectionType, propertiesContainer, checkUnique)
                        },
                        validator: function () {
                            if (headerFieldType === 'select') {
                                if (checkUnique && node._editableListData && node._editableListData[sectionType].find(vObj => vObj['key'] === keyField.val())) {
                                    SD.dialogService.openSnackBar('Duplicate key! This key already exists.');
                                    return false;
                                }
                            } else if (headerFieldType === 'typedInput') {
                                if (checkUnique && node._editableListData && node._editableListData[sectionType].find(vObj => vObj['key'] === keyField.typedInput('value'))) {
                                    SD.dialogService.openSnackBar('Duplicate key! This key already exists.');
                                    return false
                                }
                            } else {
                                if (!keyField.inputField('validateRegex')) {
                                    SD.dialogService.openSnackBar('Invalid key! Key should contain atleast one character.');
                                    return false;
                                }
                                if (checkUnique && node._editableListData && node._editableListData[sectionType].find(vObj => vObj['key'] === keyField.val())) {
                                    SD.dialogService.openSnackBar('Duplicate key! This key already exists.');
                                    return false
                                }
                            }
                            return true;
                        }
                    });
                    $(`#${sectionType}-section .srd-editableList-add-kv-wrp`).append($(`#${sectionType}-section .add-prop-btn-wrp`));
                    if (mapperButton) {
                        $(`#${sectionType}-section .srd-editableList-add-kv-wrp`).append(mapperButton);
                    }
                    if (!editableList.editableList('items').length) {
                        propertiesContainer.hide();
                    }
                }
                const methodsOptionHeaders = [
                    { title: 'Methods', style: 'left: 5.5%' }
                ];
                const allowedHeadersHeaders = [
                    { title: 'Header', style: 'left: 5.5%' }
                ]

                const originHeaders = [
                    { title: 'Origin', style: 'left: 5.5%' }
                ]

                const exposedHeadersHeaders = [
                    { title: 'Header', style: 'left: 5.5%' }
                ]

                $('#node-input-origin').toggleButton({
                    label: 'Origin',
                    checked: this.origin || true
                });

                $('#node-input-credentials').toggleButton({
                    label: 'Credentials'
                });

                $('#node-input-preflightContinue').toggleButton({
                    label: 'Preflight Continue'
                })

                /**
                  let sectionType = options.sectionType;
                    let headerTitles = options.headerTitles || [];
                    let checkUnique = options.checkUnique || true;
                    let headerFieldType = options.headerFieldType;
                    let disabledRow = options.disabledRow || false;
                **/
                prepareEditableList({
                    sectionType: 'methods',
                    headerTitles: methodsOptionHeaders,
                    checkUnique: true,
                    headerFieldType: 'select',
                    disabledRow: true
                });

                prepareEditableList({
                    sectionType: 'allowedHeaders',
                    headerTitles: allowedHeadersHeaders,
                    checkUnique: true
                });

                prepareEditableList({
                    sectionType: 'exposedHeaders',
                    headerTitles: allowedHeadersHeaders,
                    checkUnique: true
                });

                prepareEditableList({
                    sectionType: 'origin',
                    headerTitles: originHeaders,
                    checkUnique: true,
                    mapperButton: $(`
                                    <button class="map-button-wrp"  title="Origin">
                                        <image class="node-input-parse-col-button map-button proxy-map-value-toggle-headers" src="assets/serviceDesigner/refresh.svg"></image>
                                    </button>
                                `),
                    isTypedInput: true,
                    headerFieldType: 'typedInput'
                });
                function populateExistingVariables(sectionName) {
                    const list = form.find(`#${sectionName}-list`)
                    if (node.editableListData[sectionName] && node.editableListData[sectionName] instanceof Array) {
                        for (let row of node.editableListData[sectionName])
                            list.editableList('addItem', { rowData: row, validator: false });
                    }
                }
                if (node.editableListData) {
                    Object.keys(node.editableListData).forEach(section => {
                        populateExistingVariables(section);
                    });
                }
                function toggleOrigin() {
                    if (node.showOriginToggleButton) {
                        hideOriginEditableList();
                    } else {
                        hideOriginToggleButton();
                    }
                }
                $('.node-input-parse-col-button').on('click', function () {
                    node.showOriginToggleButton = !node.showOriginToggleButton;
                    toggleOrigin();
                })

                toggleOrigin();
            },
            oneditsave: function (SD) {
                this.editableListData = JSON.parse(JSON.stringify(this._editableListData));
                if (this.showOriginToggleButton) {
                    delete this.editableListData['origin'];
                } else {
                    delete this.origin;
                }
            },
			docsLink: 'cors-node'
        },
    })
</script>