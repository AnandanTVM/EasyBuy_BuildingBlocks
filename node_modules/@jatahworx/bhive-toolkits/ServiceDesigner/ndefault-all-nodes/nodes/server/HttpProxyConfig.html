// TODO: @sankarshanaj - set "docsLink" property
<script type="text/x-red" data-template-name="httpProxy-config">

    <!-- Name-->
    <div class="editor-form-row">
        <input type="text" id="node-input-name" placeholder="[n-sd]common.label.name">
    </div>
    <!-- URL -->
    <div class="editor-form-row">
        <label for="node-input-typed-url"><span data-i18n="httpProxy.label.url"></span></label>
        <input type="text" id="node-input-typed-url" style="width: 100% !important;">
    </div>
    <!-- verify server certificate -->
    <div class="editor-form-row">
        <input type="checkbox" id="node-input-useProxyAuth">
        <!-- <label for="node-input-useProxyAuth" class="props-title" style="width: auto" data-i18n="http-proxy.label.useProxyAuth"></label> -->
    
        <div id="node-input-row-useProxyAuth" style="padding-left: 1em">
                <!--Username  -->
            <div class="http-container editor-form-row" style="margin-top: 0.5em;">
                 <label for="node-input-username"><span
                         data-i18n="httpProxy.label.username"></span></label>
                 <div class="form-row  field-wrapper-typedInput http-element-container" id="node-input-username-mapping">
                     <input type="text" id="node-input-username" class="node-input-property typed-input-width"
                         style="width: 100% !important" />
                     <!-- <input type="hidden" id="node-input-outputs" /> -->
                 </div>
             </div>
             <!-- Password  -->
            <div class="http-container editor-form-row" style="margin-top: 0.5em;">
                 <label for="node-input-password"><span
                         data-i18n="httpProxy.label.password"></span></label>
                 <div class="form-row  field-wrapper-typedInput http-element-container" id="node-input-password-mapping">
                     <input type="text" id="node-input-password" class="node-input-property typed-input-width"
                         style="width: 100% !important" />
                     <!-- <input type="hidden" id="node-input-outputs" /> -->
                 </div>
             </div>
        </div>
    </div>

    <!-- Ignore hosts -->
    <div id="qparams-props-section-container" class="navigation-field-container editor-form-row" style="margin-top: 1em;">
        <div style="display: flex;">
            <label style="margin-bottom: 0;">
                <span data-i18n="common.label.ignoreList"></span>
            </label>
            <image style="display:none !important;" id="params-button-hidden" title="Map" />
            </image>
        </div>
        <div class="form-row http-element-container field-wrapper-typedInput" id="params-map-wrp"
            style="margin: 0.75em 0 2em 0;width: 100% !important;">
            <input type="text" id="node-input-ignoreList" class="node-input-property typed-input-width"
                style="width: 100% !important" />
            <button type="button" class="map-button-wrp" style="height: 100%; margin-top: 0.75em;">
                <image class="map-button proxy-map-value-toggle-params" title="Value" src="assets/serviceDesigner/edit.svg"
                    style="margin-bottom: 0.75em;"></image>
            </button>
        </div>
        <div id="qparams-props-section" class="props-section">
            <div class="add-section params-section">
                <div class="srd-editableList-add-kv-wrp">
                    <input type="text" class="property-key" style="width: 98%">
                </div>
                <!-- <button type="button" class="map-button-wrp" style="margin-left: 0em;">
                    <image class="map-button proxy-map-value-toggle-params" title="Map" src="assets/serviceDesigner/refresh.svg">
                    </image>
                </button> -->
            </div>
            <div class="properties-container">
                <ol id="qparams-properties-content"></ol>
            </div>
            <span class="list-keys-invalid">{{Editable List Invalid Message}}</span>
        </div>
    </div>

   
</script>

<script type="text/javascript">


    function switchToMapping(mapBtn) {
        return mapBtn.attr('title') === 'Value';
    }


    registerNode({
        nodeType: 'httpProxy-config',
        serviceType: 'server',
        nodeDef: {
            category: 'config',
            color: '#009978',
            defaults: {
                name: { value: "" },
                url: { value: "str" },
                username: { value: "" },
                usernameMappingObj: { value: {} },
                users: {},
                password: { value: "" },
                passwordMappingObj: { value: {} },
                useProxyAuth: { value: "" },
                qparams: { value: '' },
                qparamsMap: { value: '' },
                noproxy: { value: '' },

            },
            inputs: 1,
            outputs: 1,
            icon: "",
            paletteLabel: 'HTTP Proxy',
            label: function () {
                return this.name || "http-proxy-config";
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditinit: function(SRD) {
                let url = $("#node-input-typed-url").typedInput({ 
                    types: [
                        { value: 'str', label: 'string' },
                        { value: 'process.env', label: 'env' }
                    ]
                });
            },
            oneditprepare: function (SRD) {
                const node = this
                const editor = $('form#dialog-form');
                let editPrepareComplete = false; //validate: /[^\s]+/
                const types = [
                    { value: 'str', label: 'string' },
                    { value: 'process.env', label: 'env' }
                ]
                const srcs = {
                    Map: 'assets/serviceDesigner/refresh.svg',
                    Value: 'assets/serviceDesigner/edit.svg'
                }
                /* Creates the input field of the name*/
                let nodeName = $(`#node-input-name`).inputField();

                /* Creates the server input field of the name*/

                function updateProxyAuth(checked) {
                    if (checked) {
                        $("#node-input-row-useProxyAuth").show();
                    } else {
                        $("#node-input-row-useProxyAuth").hide();
                    }
                }

                $("#node-input-useProxyAuth").toggleButton({
                    label: SRD._('httpProxy.label.useProxyAuth'),
                    labelCss: {
                        "margin-right": "3em"
                    },
                    cssObject: {
                        "margin-top": "1.5em"
                    },
                    afterToggle: updateProxyAuth
                });

                function updateTypedInputValue(typedInputEle, mappingObj) {
                    if (node[mappingObj] && node[mappingObj].hasOwnProperty('mapVarType')) {
                        typedInputEle.typedInput('type', node[mappingObj].mapVarType);
                        typedInputEle.typedInput('value', node[mappingObj].mapVarValue)

                    }
                }

                const usernameMapping = $('#node-input-username').typedInput({ types: types });
                updateTypedInputValue(usernameMapping, 'usernameMappingObj')

                const passwordMapping = $('#node-input-password').typedInput({ types: types });
                updateTypedInputValue(passwordMapping, 'passwordMappingObj')

                const qparams = $('#qparams-properties-content');

                function validateForm() {
                    let disableFlag = false;
                    $('.red-ui-editableList-list').each((i, e) => {
                        disableFlag = $(e).data().valid === false ? true : disableFlag;
                    })
                    if (disableFlag) {
                        // isTableValid = false
                        $('#node-config-dialog-ok').addClass('disabled');
                    } else {
                        // isTableValid = true;
                        $('#node-config-dialog-ok').removeClass('disabled');
                    }
                    // handleFormValidity();
                }

                function setTitle(mapBtn, title) {
                    mapBtn.attr('title', title);
                    mapBtn.attr('src', srcs[title]);
                }

                function toggleBtns(mapBtn) {
                    if (!switchToMapping(mapBtn)) {
                        setTitle(mapBtn, 'Value');
                    } else {
                        setTitle(mapBtn, 'Map');
                    }
                }


                // editable List
                node.tempVarStore = { paramsVariables: [] };

                /* Creates the pathparams editable list section*/
                function decorateAndPopulatePropsSection(sectionName) {
                    /* Properties add section key-value fields */
                    let kvWrp = $(`#${sectionName}-props-section .srd-editableList-add-kv-wrp`);
                    let keyField = $(`#${sectionName}-props-section .property-key`).inputField({
                        placeholder: SRD._('common.label.key'),
                        validatorRegexp: /[^\s]+/
                    });

                    /* Properties List */
                    let propertiesContainer = $(`#${sectionName}-props-section .properties-container`);
                    let invalidListMsg = $(`#${sectionName}-props-section .list-keys-invalid`).css({ 'visibility': 'hidden' });

                    let propertiesHeaderContainer = $(`<div class="properties-header-container"></div>`).prependTo(propertiesContainer);

                    let headers = $(`
                <div class="header">No.</div>
                <div class="wide-header ">Key</div>
                `).appendTo(propertiesHeaderContainer);

                    let varArrType = 'paramsVariables';

                    function updateTempVarStore(prop, val, currentRowIdArr, setRest) {
                        for (let i in node.tempVarStore[varArrType]) {
                            if (currentRowIdArr.includes(node.tempVarStore[varArrType][i]['rowId'])) {
                                node.tempVarStore[varArrType][i][prop] = val;
                                if (setRest === undefined) {
                                    return i;
                                }
                            } else if (setRest !== undefined) {
                                node.tempVarStore[varArrType][i][prop] = setRest;
                            }
                        }

                    }

                    function ultimateValidator() {
                        SRD.validators.editableList(propertiesContainer, propsContent, {
                            checkUniquenessOn: node.tempVarStore[varArrType].map(x => x.key),
                            checkValidityOn: node.tempVarStore[varArrType],
                            errorMsgContainer: invalidListMsg
                        });
                        validateForm();
                    }


                    let propsContent = $(`#${sectionName}-properties-content`).data({ valid: true, isUnique: true, isValid: true });
                    propsContent.editableList({
                        addItem: function (container, i, data) {
                            let rowData = data.rowData ? data.rowData : data;
                            let value = rowData.length ? rowData : keyField.val()
                            /* property list's "key" field */
                            let listKey = $(`<input type="text"/>`).appendTo(container).inputField({
                                wrapperAttr: { style: 'width: 80%;' },
                                validatorRegexp: /[^\s]+/,
                                disableDoneIfInvalid: true,
                                inputClassList: "property-key",
                                value: value,
                                updations: function (elemData, inputVal) {
                                    let index = updateTempVarStore('key', inputVal, container.data().data.rowData.rowId);
                                    node.tempVarStore[varArrType][index].valid = elemData.valid;
                                    container.data('data', { rowData: node.tempVarStore[varArrType][index] });
                                    ultimateValidator();
                                }
                            });

                            let dataObj = {
                                key: listKey.val(),
                                rowId: rowData.rowId || SRD.nodes.id(),
                                valid: true
                            };

                            node.tempVarStore[varArrType].push(dataObj);
                            propertiesContainer.show();
                            container.attr('id', dataObj.rowId).data('data', { rowData: dataObj });
                            $('.property-row .field-floating-placeholder').remove();
                            /* Clear the "Add" Section input fields */
                            keyField.inputField('reset');
                            $('.srd-delete-icon').addClass('http-delete-icon')
                        },
                        showAddBtnLabel: false,
                        removable: true,
                        scrollOnAdd: true,
                        removeItem: function (data) {
                            node.tempVarStore[varArrType] = node.tempVarStore[varArrType].filter(vObj => vObj['rowId'] !== data.rowData.rowId);
                            ultimateValidator();
                            if (node.tempVarStore[varArrType].length === 0) {
                                $(`#${sectionName}-props-section .properties-container`).hide();
                            }
                        },
                        validator: function () {
                            let keyToValidate = keyField.val();
                            if (!keyToValidate.match(keyField.inputField('option', 'validatorRegexp'))) {
                                SRD.dialogService.openSnackBar('Invalid Key! It Should Contain Atleast One Character.');
                                return false;
                            }
                            if (node.tempVarStore[varArrType].find(vObj => vObj['key'] === keyToValidate)) {
                                SRD.dialogService.openSnackBar('Duplicate Key! This Key Already Exists.');
                                return false
                            }
                            return true;
                        }
                    });
                    $(`#${sectionName}-props-section .add-prop-btn-wrp`).insertAfter(kvWrp);
                }


                $('#qparams-props-section .properties-container').hide();
                decorateAndPopulatePropsSection('qparams');



                $('.proxy-map-value-toggle-params').click((eventObj) => {
                    toggleBtns(qparamsToggleBtn);
                    if (switchToMapping(qparamsToggleBtn)) {
                        $('#params-map-wrp').show();
                        $('#qparams-props-section').hide();
                    } else {
                        $('#params-map-wrp').hide();
                        $('#qparams-props-section').show();
                        if (node.tempVarStore.paramsVariables.length !== 0) {
                            $('#qparams-props-section properties-container').show();
                        } else {
                            $('#qparams-props-section properties-container').hide();
                        }
                    }
                    validateForm();
                });

                function populateExistingVariables(sectionName, variablesObjectArr) {
                    if (variablesObjectArr && variablesObjectArr instanceof Array) {
                        for (let row of variablesObjectArr)
                            $(`#${sectionName}-properties-content`).editableList('addItem', { rowData: row, validator: false });
                    }
                }

                const qparamsMap = $('#node-input-ignoreList').typedInput({
                    types: [
                        { value: 'str', label: 'String' },
                        { value: 'process.env', label: 'Env' },
                    ],
                    onvalchanged: validateForm,
                    change: validateForm,
                    noErrorElement: false
                });

                editPrepareComplete = true;

                const qparamsToggleBtn = $('#params-button-hidden');
                if (node.qparams) {
                    setTitle(qparamsToggleBtn, 'Map');
                    $('#params-map-wrp').hide();
                    if (node.noproxy) {
                        node.noproxy.forEach(row => {
                            qparams.editableList('addItem', { rowData: row, validator: false })
                        });
                    }
                } else if (node.qparamsMap) {
                    setTitle(qparamsToggleBtn, 'Value');
                    $('#qparams-props-section').hide();
                    qparamsMap.typedInput('type', node.qparamsMap.type);
                    qparamsMap.typedInput('value', node.qparamsMap.value);
                } else {
                    setTitle(qparamsToggleBtn, 'Map');
                    $('#params-map-wrp').hide();
                }

                populateExistingVariables('qparams', this.noproxy);

                $(".http-delete-icon").each(function () {
                    $(this).css({ "margin-top": "1em" })
                })

                $('.srd-editableList-add-kv-wrp .field-wrapper').width('100%')

            },
            oneditsave: function () {
                const node = this;
                const qparamsToggleBtn = $('#params-button-hidden');

                function mapValFromEditableList(array) {
                    let obj = {};
                    let rmArr = [];
                    array.forEach(kv => {
                        // let key = ;
                        rmArr.push(kv.key);
                    });
                    return {
                        obj: Object.keys(obj).length === 0 ? undefined : obj,
                        reverseMapArr: rmArr.length === 0 ? undefined : rmArr
                    }
                }

                function updateMappingValue(id, mapVarObj) {
                    const mapVarType = $(`#${id}`).typedInput('type');
                    const mapVarValue = $(`#${id}`).typedInput('value');
                    node[mapVarObj] = node[mapVarObj] ? node[mapVarObj] : {}
                    node[mapVarObj]['mapVarType'] = mapVarType;
                    node[mapVarObj]['mapVarValue'] = mapVarValue;
                }

                updateMappingValue('node-input-username', 'usernameMappingObj');
                updateMappingValue('node-input-password', 'passwordMappingObj');


                /* Q params */
                if (!switchToMapping(qparamsToggleBtn)) {
                    // get editableList items, assign it to node.qparams
                    delete node.qparamsMap;
                    ({ obj: node.qparams, reverseMapArr: node.noproxy } = mapValFromEditableList(node.tempVarStore.paramsVariables));
                    node.noproxy = node.noproxy;

                } else if (switchToMapping(qparamsToggleBtn)) {
                    delete node.qparams;
                    delete node.noproxy;
                    const qparamsMap = $('#node-input-ignoreList');
                    if (qparamsMap.typedInput('value')) {
                        node.qparamsMap = {
                            type: qparamsMap.typedInput('type'),
                            value: qparamsMap.typedInput('value')
                        }
                    } else {
                        delete node.qparamsMap
                    }
                }

                delete node.tempVarStore;


            },
            oneditcancel() {
                delete this.tempVarStore;
            }
        }
    })

</script>