<script type="text/x-red" data-template-name="MiddlewareStart">
    <input type="text" id="node-input-name" required>
</script>
<script type="text/javascript">
    registerNode({
        nodeType: 'MiddlewareStart',
        serviceType: 'server',
        nodeDef: {
            color: "#adadad",
            shape: "circle",
			category: 'HTTP',
			isClassFunction: false,
            defaults: {
                name: {
                    value: "", validate: function (v, SD) {
                        return v && !SD.nodes.workspaceNodes(this.type, this.id, 'name', this.z).nodePropsArr.includes(v);
                    }
                },
                inputs: { value: 0 },
                outputs: { value: 1 },
            },
            inputs: 0,
            outputs: 1,
            icon: "ndefault-all-nodes/middleware-start-node.svg",
            useAsType: true,
            oneditprepare: function (SD) {
                const node = this;
                const okay = $('#node-dialog-ok');
                $('#node-input-name').inputField({
					placeholder: SD._('common.label.name'),
                    value: node.name || '',
                    validator: function (v) {
                        let valid = true;
                        let msg = '';
                        if (!SD.validators.patterns.validbh.test(v)) {
                            valid = false;
                            msg = 'Name should start with an alphabet/underscore and can contain alphanumeric characters';
                        } else if (SD.nodes.workspaceNodes(node.type, node.id, 'name', node.z).nodePropsArr.includes(v)) {
                            valid = false;
                            msg = 'Middlewarestart node with the same name exists in this workspace'
                        } else {
                            valid = true;
                        }
                        return {
                            valid: valid,
                            errorMessage: msg,
                        }
                    },
                    validateOnCreate: true,
                    disableDoneIfInvalid: true,
                    enableDoneIfValid: true
                });
            },
            afteradd: function (SD) {
                SD.nodes.registerMiddlewareFlow(this);
            },
            onremove: function (SD) {
                const node = this;
                if (node.valid !== false && node.name) {
                    const nodeType = SD.workspaces.get(node.z).label + ':' + node.name;
                    SD.nodes.unregisterMiddlewareFlow(nodeType);
                }
            },
            onpropertieschange: function (oldValues, wasValid, SD) {
                const node = this;
                if (oldValues.hasOwnProperty('name')) {
                    const serviceName = SD.workspaces.get(node.z).label;
                    if (oldValues.name && wasValid) {
                        SD.nodes.unregisterMiddlewareFlow(serviceName + ':' + oldValues.name);
                    }
                    SD.nodes.registerMiddlewareFlow(node);
                }
            },
            label: function () {
                return this.name || 'Middleware Start'
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            paletteLabel: 'Middleware Start',
            docsLink: 'middleware-start-node'
        }
    });
</script>