<script type="text/x-red" data-template-name="ServiceVariables">
<div class="editor-form-row">
        <label ><span  data-i18n="common.label.operation-type"></span></label>
        <select id="node-select-operation" style="width: 100%;"></select>
    </div>
    <!-- Set -->
    <label class="editor-form-row-label"><span>Variables List</span></label>
    <div id="global-props-section-container" class="editor-form-row">
        <div id="global-props-section" class="props-section">
            <div class="add-section">
                <div class="srd-editableList-add-kv-wrp">
                    <input type="text" class="property-textIp">
                    <input type="text" class="property-typedIp">
                </div>
            </div>
            <div class="properties-container" validatesform="true">
                <ol id="global-properties-content"></ol>
            </div>
            <span class="list-keys-invalid">{{Editable List Invalid Message}}</span>
        </div>
    </div>
    <!-- Get -->
    <div id="mapping-props-section-container" class="editor-form-row">
        <div id="mapping-props-section" class="props-section">
            <div class="add-section">
                <div class="srd-editableList-add-kv-wrp">
                    <input type="text" class="property-typedIp">
                    <input type="text" class="property-textIp">
                </div>
            </div>
            <div class="properties-container" validatesform="true">
                <ol id="mapping-properties-content"></ol>
            </div>
            <span class="list-keys-invalid">{{Editable List Invalid Message}}</span>
        </div>
    </div>
</script>



<script type="text/javascript">
    registerNode({
        nodeType: 'ServiceVariables',
        nodeDef: {
            color: "#0575e6",
            category: 'Function',
            defaults: {
                name: { value: "" },
                inputs: { value: 1 },
                outputs: { value: 1 },
                operation: { value: 'set' },
                globalVariables: { value: [] },
                functionName: { value: '' }
            },
            inputs: 1,
            outputs: 1,
            icon: 'ndefault-all-nodes/service-variables-node.svg',
            label: function () {
                return this.name || 'Service Variables'
            },
            paletteLabel: function (def) { return 'Service Variables'; },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function (SRD) {
				let node = this;
				const form = $('#dialog-form');
                let __$ = form.find.bind(form);
                node.tempVarStore = { globalVariables: [], varMap: [] };
                const valTypes = [
                    { value: 'bh', label: 'bh.' },
                    { value: 'bh.input', label: 'bh.input.' },
                    { value: 'bh.local', label: 'bh.local.' },
                    { value: 'str', label: 'string' },
                    { value: 'literal', label: 'as is' }
                ]
                const keyTypes = [
                    { value: 'bh', label: 'bh.' },
                    { value: 'bh.input', label: 'bh.input.' },
                    { value: 'bh.local', label: 'bh.local.' }
                ]
                const mappingELContainer = $('#mapping-props-section-container');
                const globalELContainer = $('#global-props-section-container');
                const globEL = $('#global-properties-content');
                const mapEL = $('#mapping-properties-content');
                const doneBtn = $('#node-dialog-ok');

                function populateExistingVariables(sectionName, variablesObjectArr) {
                    if (variablesObjectArr && variablesObjectArr instanceof Array) {
                        const EL = $(`#${sectionName}-properties-content`)
                        for (let row of variablesObjectArr)
                            EL.editableList('addItem', { rowData: row, validator: false });
                    }
                }

                function validateForm() {
					SRD.defaults.validateForm(true);
				}
				
				function updateTempVarStore(prop, val, currentRowIdArr, varArrType) {
					for (let i in node.tempVarStore[varArrType]) {
						if (currentRowIdArr.includes(node.tempVarStore[varArrType][i]['rowId'])) {
							node.tempVarStore[varArrType][i][prop] = val;
							return i;
						}
					}
				}

                function preparePropsSection(sectionName, dialogForm) {

                    function createTextIp(css, dataObj, container) {
                        const isKey = sectionName === 'global';
                        let textIp = '';
                        if (!dataObj) {
                            textIp = $(`#${sectionName}-props-section .property-textIp`).inputField({
                                wrapperAttr: { style: 'width: 40%;' },
                                placeholder: SRD._('common.label.serviceVar'),
                                validatorRegexp: /^[a-zA-Z][a-zA-Z_0-9]*$/,
                                showError: false,
                                validator: function (val) {
                                    return {
                                        valid: !isDuplicateVariable(val),
                                        errorMessage: 'Same as function name of a node'
                                    }
                                }
                            });
                        } else {
                            textIp = $(`<input type="text"/>`).appendTo(container).inputField({
                                wrapperAttr: { style: 'width: 40%;' },
                                inputClassList: "property-key",
                                value: dataObj.textIp,
                                validator: function (val) {
                                    let notDuplicate = true;
                                    let matchesRegex = /^[a-zA-Z][a-zA-Z_0-9]*$/.test(val);
                                    let msg = 'Alphanumeric chars are allowed';
                                    if (matchesRegex) {
                                        notDuplicate = !isDuplicateVariable(val);
                                        msg = "Same as function name of a node";
                                    }
                                    return {
                                        valid: matchesRegex && notDuplicate,
                                        errorMessage: !(matchesRegex && notDuplicate) ? msg : ''
                                    }
                                },
                                updations: function (elemData, inputVal) {
                                    let index = updateTempVarStore('textIp', inputVal, container.data('data').rowData.rowId, varArrType);
                                    node.tempVarStore[varArrType][index].valid = elemData.valid;
                                    container.data('data', { rowData: node.tempVarStore[varArrType][index] });
                                    validateEditableList();
                                }
                            });
                        }
                        return textIp;
                    }

                    function createTypedIp(css, dataObj, container) {
                        let typedIp = '';
                        const types = sectionName === 'global' ? valTypes : keyTypes
                        if (!dataObj) {
                            typedIp = $(`#${sectionName}-props-section .property-typedIp`).css(css).typedInput({
                                types: types,
                                noErrorElement: false
                            });
                        } else {
                            typedIp = $(`<input type="text"/>`).css(css).appendTo(container).typedInput({
                                types: types,
                                noErrorElement: false,
                            });
                        }
                        return typedIp;
                    }


                    function isDuplicateVariable(ipVal) {
						if(ipVal === __$('#functionName').text()) {
							return true;
						}
						const nodes = SRD.nodes.nodes();
						for (let i = 0; i < nodes.length; i++) {
							const n = nodes[i];
							if (n.z === node.z && n.id !== node.id) {
								const fnName = SRD.utils.getFnName(n);
								if (ipVal === fnName) {
									return true;
								}
							}
						}
						return false;
                    }
                    /* Properties add section key-value fields */
                    let kvWrp = $(`#${sectionName}-props-section .srd-editableList-add-kv-wrp`);
                    let textIpField = createTextIp();
                    let typedIpField = createTypedIp({ 'width': '55%' });

                    /* Properties List */
                    let propertiesContainer = $(`#${sectionName}-props-section .properties-container`);
                    let invalidListMsg = $(`#${sectionName}-props-section .list-keys-invalid`).css({ 'visibility': 'hidden' });

                    let propertiesHeaderContainer = $(`<div class="properties-header-container"></div>`).prependTo(propertiesContainer);

                    const headerStyle = `style="${sectionName === 'global' ? 'width:40%' : 'width: 60%'}"`;
                    let headers = $(`
                <div class="header">No.</div>
                <div class="header" ${headerStyle}>${sectionName === 'global' ? 'Service Variable' : 'Flow Property'}</div>
                <div class="header" ${headerStyle}>${sectionName === 'global' ? 'Default Value' : 'Service Variable'}</div>
                `).appendTo(propertiesHeaderContainer);

                    let varArrType = sectionName === 'global' ? 'globalVariables' : 'varMap';

                    function validateEditableList() {
                        const v = SRD.validators.editableList(propertiesContainer, propsContent, {
                            checkUniquenessOn: sectionName === 'global' ? node.tempVarStore[varArrType].map(x => x.textIp) : null,
                            checkValidityOn: node.tempVarStore[varArrType],
                            errorMsgContainer: invalidListMsg
                        });
                        SRD.defaults.validateForm(v);
                    }

                    let propsContent = $(`#${sectionName}-properties-content`).data({ valid: true, isUnique: true, isValid: true });
                    propsContent.editableList({
                        addItem: function (container, i, data) {
                            let rowData = data.rowData || { typedIpValue: {} };
                            let dataObj = {
                                textIp: rowData.textIp || textIpField.val(),
                                typedIpValue: {
                                    type: rowData.typedIpValue.type || typedIpField.typedInput('type'),
                                    value: rowData.typedIpValue.value || typedIpField.typedInput('value')
                                },
                                rowId: rowData.rowId || SRD.nodes.id(),
                                valid: true
                            };
                            node.tempVarStore[varArrType].push(dataObj);
                            container.attr('id', dataObj.rowId).css('align-items', 'baseline').data('data', { rowData: dataObj });

                            function changeHandler(evt) {
                                const elm = $(evt.target);
                                const val = {
                                    type: elm.typedInput('type'),
                                    value: elm.typedInput('value'),
                                };
                                let index = updateTempVarStore('typedIpValue', val, container.data('data').rowData.rowId, varArrType);
                                container.data('data', { rowData: node.tempVarStore[varArrType][index] });
                            }
                            /* property list's "textIp" field */
                            let listTextIp = createTextIp({}, dataObj, container);

                            /* property list's "typedIp" field */
                            let listTypedIp = createTypedIp({ width: '40%' }, true, container).change(changeHandler);

                            if (sectionName !== 'global') {
                                container.find('.field-wrapper').appendTo(container);
                            }
                            let v = Object.assign({}, dataObj.typedIpValue);
                            listTypedIp.typedInput('type', v.type);
                            listTypedIp.typedInput('value', v.value);


                            propertiesContainer.show();

                            /* Clear the "Add" Section input fields */
                            textIpField.inputField('reset');
                            typedIpField.typedInput('value', '');
                        },
                        removable: true,
                        scrollOnAdd: true,
                        removeItem: function (data) {
                            node.tempVarStore[varArrType] = node.tempVarStore[varArrType].filter(vObj => vObj['rowId'] !== data.rowData.rowId);
                            validateEditableList();
                            if (node.tempVarStore[varArrType].length === 0) {
                                $(`#${sectionName}-props-section .properties-container`).hide();
                            }
                        },
                        showAddBtnLabel: false,
                        validator: function () {
                            if (!textIpField.inputField('validateRegex')) {
                                SRD.dialogService.openSnackBar('Variable Name Should Start with an Alphabet and Can Contain Alphabets, Numbers, Underscore.');
                                return false;
                            }
                            if (!textIpField.inputField('execValidator').valid) {
                                SRD.dialogService.openSnackBar('Value is being used as function name of another node in this service.');
                                return false;
                            }
                            if (sectionName === 'global') {
                                let keyToValidate = textIpField.val();
                                if (node.tempVarStore[varArrType].find(vObj => vObj['textIp'] === keyToValidate)) {
                                    SRD.dialogService.openSnackBar('This Variable Already Exists In the List.');
                                    return false;
                                }
                            }
                            return true;
                        }
                    });
					$(`#${sectionName}-props-section .add-prop-btn-wrp`).insertAfter(kvWrp)
					
					return { validator: validateEditableList };
                }

                function showEL(EL, ELconatiner) {
                    ELconatiner.show();
                    if (EL.editableList('items').length) {
                        EL.closest('.properties-container').show();
                    } else {
                        EL.closest('.properties-container').hide();
                    }
                }

                function toggleELs(value) {
                    if (value === 'get') {
                        globalELContainer.hide();
                        showEL(mapEL, mappingELContainer)
                    } else {
                        mappingELContainer.hide();
                        showEL(globEL, globalELContainer);
                    }
                    validateForm();
                }
                const operation = $('#node-select-operation').selectField({
                    optionsData: [
                        { value: 'get', displayValue: 'Get Service Variables' },
                        { value: 'set', displayValue: 'Set Service Variables' }
                    ],
                    value: node.operation,
                    change: toggleELs
                })
                /* Add global and mapping properties section */
                const { validator: declarationELvalidator } = preparePropsSection('global');
				const { validator: mappingELValidator } = preparePropsSection('mapping');

                /* Hide the properties list by default. It will be displayed whenever 'addItem' runs */
                $('#global-props-section .properties-container').hide();

                /* Populate editableList with the variables if already present */
                if (node.operation === 'set') {
                    populateExistingVariables('global', node.globalVariables);
                } else {
                    populateExistingVariables('mapping', node.globalVariables);
                }
				operation.selectField('change', node.operation);

				function validateElKeysOnNameInput(input, varArrType) {
					input.inputField('valid', true);
					const container = input.closest('.property-row');
					let index = updateTempVarStore('textIp', input.inputField('value'), container.data('data').rowData.rowId, varArrType);
					node.tempVarStore[varArrType][index].valid = input.inputField('valid');
					container.data('data', { rowData: node.tempVarStore[varArrType][index] });
					const rowId = input.closest('.property-key');
				}
								
				__$('#node-input-name').on('input', function () {
					// WATCHOUT: Everything is hardcoded here!!
					let v = true;
					if (!globEL.is(':hidden')) {
						globEL.find('input.property-key:not(:hidden)').each(function () {
							validateElKeysOnNameInput($(this), 'globalVariables');
							v = SRD.validators.editableList(globEL.closest('.properties-container'), globEL, {
								checkUniquenessOn: node.tempVarStore.globalVariables.map(x => x.textIp),
								checkValidityOn: node.tempVarStore.globalVariables,
								errorMsgContainer: __$('#global-props-section .list-keys-invalid')
							});
						});
					} else if (!mapEL.is(':hidden')) {
						mapEL.find('input.property-key:not(:hidden)').each(function () {
							validateElKeysOnNameInput($(this), 'varMap');
							v = SRD.validators.editableList(mapEL.closest('.properties-container'), mapEL, {
								checkUniquenessOn: null,
								checkValidityOn: node.tempVarStore.varMap,
								errorMsgContainer: __$('#mapping-props-section .list-keys-invalid')
							});
						});
					}
					SRD.defaults.validateForm(v);
				});
            },
            oneditsave: function () {
                function typedIpEVal(type, val) {
                    return ({
                        type: val ? type : 'str',
                        value: val
                    });
                }
                this.operation = $('#node-select-operation').selectField('selected');
                if (this.operation === 'set') {
                    this.globalVariables = this.tempVarStore.globalVariables.map(x => ({ textIp: x.textIp, typedIpValue: x.typedIpValue }));
                } else {
                    this.globalVariables = this.tempVarStore.varMap.map(x => ({ textIp: x.textIp, typedIpValue: typedIpEVal(x.typedIpValue.type, x.typedIpValue.value) }));
                }
                delete this.tempVarStore;
            },
            oneditcancel: function () {
                delete this.tempVarStore;
            },
            docsLink: 'service-variables-node'
        }
    });
</script>
<script type="text/x-red" data-help-name="ServiceVariables">
</script>