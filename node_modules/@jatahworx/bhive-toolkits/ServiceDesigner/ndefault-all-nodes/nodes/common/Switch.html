<script type="text/x-red" data-template-name="Switch">
<div class="editor-form-row field-wrapper-typedInput no-error-element" id="switch-typed-input">
    <label for="switch-typed-input"><span data-i18n="switch.label.property"></span></label>
    <input type="text" id="node-typedInput-property" class="input-width" style="width: 100% !important"/>
    <input type="hidden" id="node-input-outputs"/>
</div>
<label for="main-rule-container" class="label editor-form-row-label"><span data-i18n="switch.label.rule"></span></label>
<div id="main-rule-container"></div>
</div>
<div class="editor-form-row-margin-bottom-0 node-input-rule-container-row properties-container" validatesform="true">
    <ol id="node-input-rule-container"></ol>
</div>
<span class="list-keys-invalid">{{Editable List Invalid Message}}</span>
<div class="editor-form-row">
    <select id="node-input-checkall" class="select-field-custom" style="width:100%; margin: 0 5px 1px 0;">
        <option value="false" data-i18n="switch.stopfirst"></option>
        <option value="true" data-i18n="switch.checkall"></option>
    </select>
</div>
</script>



<script type="text/javascript">
    (function () {
        var operators = [
            { v: "eq", t: "==", kind: 'V' },
            { v: "se", t: "===", kind: 'V' },
            { v: "neq", t: "!=", kind: 'V' },
            { v: "sne", t: "!==", kind: 'V' },
            { v: "lt", t: "<", kind: 'V' },
            { v: "lte", t: "<=", kind: 'V' },
            { v: "gt", t: ">", kind: 'V' },
            { v: "gte", t: ">=", kind: 'V' },
            { v: "btwn", t: "switch.rules.btwn", kind: 'V' },
            { v: "cont", t: "switch.rules.cont", kind: 'V' },
            { v: "regex", t: "switch.rules.regex", kind: 'V' },
            { v: "true", t: "switch.rules.true", kind: 'V' },
            { v: "false", t: "switch.rules.false", kind: 'V' },
            { v: "null", t: "switch.rules.null", kind: 'V' },
            { v: "nnull", t: "switch.rules.nnull", kind: 'V' },
            { v: "istype", t: "switch.rules.istype", kind: 'V' },
            { v: "empty", t: "switch.rules.empty", kind: 'V' },
            { v: "nempty", t: "switch.rules.nempty", kind: 'V' },
            // { v: "head", t: "switch.rules.head", kind: 'S' },
            // { v: "index", t: "switch.rules.index", kind: 'S' },
            // { v: "tail", t: "switch.rules.tail", kind: 'S' },
            // { v: "jsonata_exp", t: "switch.rules.exp", kind: 'O' },
            { v: "else", t: "switch.rules.else", kind: 'O' }
        ];
        function resizeRule(rule, i, subtractThis = 70) {
            var newWidth = rule.width();
            var selectField = rule.find("select");
            var type = selectField.val() || "";
            var valueField = rule.find(".node-input-rule-value");
            var typeField = rule.find(".node-input-rule-type-value");
            var numField = rule.find(".node-input-rule-num-value");
            var expField = rule.find(".node-input-rule-exp-value");
            var btwnField1 = rule.find(".node-input-rule-btwn-value");
            var btwnField2 = rule.find(".node-input-rule-btwn-value2");
            var selectWidth;
            if (type.length < 4) {
                selectWidth = 60;
            } else if (type === "regex") {
                selectWidth = 147;
            } else {
                selectWidth = 120;
            }
            selectField.width(selectWidth);
            selectField.css({ "height": "1.95em" });
            if ((type === "btwn") || (type === "index")) {
                btwnField1.typedInput("width", (newWidth - selectWidth - subtractThis));
                btwnField2.typedInput("width", (newWidth - selectWidth - subtractThis));
            } else if ((type === "head") || (type === "tail")) {
                numField.typedInput("width", (newWidth - selectWidth - subtractThis));
            } else if (type === "jsonata_exp") {
                expField.typedInput("width", (newWidth - selectWidth - subtractThis));
            } else if (type === "istype") {
                typeField.typedInput("width", (newWidth - selectWidth - subtractThis));
            } else {
                if (type === "true" || type === "false" || type === "null" || type === "nnull" || type === "empty" || type === "nempty" || type === "else") {
                    selectField.width(newWidth - (subtractThis - 5));
                } else {
                    valueField.typedInput("width", (newWidth - selectWidth - subtractThis));
                }
            }
        }
        function getRule(rule, type, SRD) {
            let r = { t: type };
            if (!(type === "true" || type === "false" || type === "null" || type === "nnull" || type === "empty" || type === "nempty" || type === "else")) {
                if ((type === "btwn") /* || (type === "index") */) {
                    r.v = rule.find(".node-input-rule-btwn-value").typedInput('value');
                    r.vt = rule.find(".node-input-rule-btwn-value").typedInput('type');
                    r.v2 = rule.find(".node-input-rule-btwn-value2").typedInput('value');
                    r.v2t = rule.find(".node-input-rule-btwn-value2").typedInput('type');
                    r.gv2 = SRD.utils.getPropertyGenVal(r.v2, r.v2t);
                } else if (type === "istype") {
                    r.v = rule.find(".node-input-rule-type-value").typedInput('type');
                    r.vt = rule.find(".node-input-rule-type-value").typedInput('type');
                } else {
                    r.v = rule.find(".node-input-rule-value").typedInput('value');
                    r.vt = rule.find(".node-input-rule-value").typedInput('type');
                }
                r.gv = SRD.utils.getPropertyGenVal(r.v, r.vt);
                if (type === "regex") {
                    r.case = rule.find(".node-input-rule-case").prop("checked");
                }
            }
            return r;
        }
        /*
                <div class="output-toggle-group">
                    <div class="output-toggle-label">${caseLabel}</div>
                    <div class="toggle-button">
                        <label class="switch">
                            <input type="checkbox" class="node-input-rule-case" id=${"node-input-rule-case-" + i}>
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
        */

        function createToggleButton(caseLabel, cssObject = {}) {
            Object.assign(cssObject, { 'padding-top': 0, left: 0, position: 'absolute' });
            let toggleGroup = $(`<div class="output-toggle-group">`).css(cssObject);
            $(`<div class="output-toggle-label">${caseLabel}</div>`).appendTo(toggleGroup);
            let toggleBtn = $(`<div class="toggle-button">`).appendTo(toggleGroup);
            let label = $(`<label class="switch">`).appendTo(toggleBtn);
            let toggleIp = $(`<input type="checkbox">`).appendTo(label);
            label.append($(`<span class="slider round"></span>`));
            return { toggleGroup: toggleGroup, toggleIp: toggleIp };
        }

        function clipValueLength(v) {
            if (v.length > 15) {
                return v.substring(0, 15) + "...";
            }
            return v;
        }
        function prop2name(key) {
            var result = SRD.utils.parseContextKey(key);
            return result.key;
        }
        function getValueLabel(t, v) {
            if (t === 'str') {
                return '"' + clipValueLength(v) + '"';
            } else if (t === 'msg') {
                return t + "." + clipValueLength(v);
            } else if (t === 'flow' || t === 'global') {
                return t + "." + clipValueLength(prop2name(v));
            } else if(t.startsWith('bh')) {
                return t + '.' + clipValueLength(v);
            }
            return clipValueLength(v);
        }
        registerNode({
            nodeType: 'Switch',
            nodeDef: {
                color: "",
                category: 'Function',
                defaults: {
                    name: { value: "" },
                    property: { value: "", validate: function (v, SRD) { return SRD.validators.typedInput(this.propertyType, true)(v); } },
                    propertyType: { value: "bh" },
                    propertyGv: { value: "", required: true },
                    rules: { value: [] },
                    checkall: { value: "false", required: true },
                    repair: { value: false },
                    outputs: { value: 0 }
                },
                inputs: 1,
                outputs: 1,
                outputLabels: function (index) {
                    var rule = this.rules[index];
                    var label = "";
                    if (rule) {
                        for (var i = 0; i < operators.length; i++) {
                            if (operators[i].v === rule.t) {
                                label = /^switch/.test(operators[i].t) ? this._(operators[i].t) : operators[i].t;
                                break;
                            }
                        }
                        if ((rule.t === 'btwn') || (rule.t === 'index')) {
                            label += " " + getValueLabel(rule.vt, rule.v) + " & " + getValueLabel(rule.v2t, rule.v2);
                        } else if (rule.t !== 'true' && rule.t !== 'false' && rule.t !== 'null' && rule.t !== 'nnull' && rule.t !== 'empty' && rule.t !== 'nempty' && rule.t !== 'else') {
                            label += " " + getValueLabel(rule.vt, rule.v);
                        }
                        return label;
                    }
                },
                color: "#EB8208",
                icon: "ndefault-all-nodes/switch-node.svg",
                label: function () {
                    return this.name || 'Switch';
                },
                labelStyle: function () {
                    return this.name ? "node_label_italic" : "";
                },
                oneditprepare: function (SRD) {
                    let doneBtn = $('button#node-dialog-ok');
                    var node = this;
                    $('#node-input-name').inputField();
                    // var previousValueType = { value: "prev", label: this._("inject.previous"), constant: true };
                    let bhTypes = [
                        { value: 'bh', label: 'bh.', validate: SRD.validators.typedInput('bh', true) },
                        { value: 'bh.input', label: 'bh.input.', validate: SRD.validators.typedInput('bh.input', true) },
                        { value: 'bh.local', label: 'bh.local.', validate: SRD.validators.typedInput('bh.local', true) }
                    ]
                    let otherTypes = [
                        { value: 'num', label: 'number', validate: (v) => /^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(v) && ('' + v).length > 0 },
                        { value: 'str', label: 'string', validate: (v) => v.length !== 0/*  && !v.match(/[\'\"]/ )*/ },
                        { value: 'literal', label: 'as is', validate: SRD.validators.patterns.noblank }
                    ]

                $("#node-typedInput-property").typedInput({
                    default: this.propertyType || bhTypes[0],
                    types: bhTypes
                }).typedInput('value', node.property );
                var outputCount = $("#node-input-outputs").val("{}");

                    var andLabel = this._("switch.and");
                    var caseLabel = this._("switch.ignorecase");

                    function changeHandler(row2, row3, type, valueField, expValueField, numValueField, typeValueField, btwnValueField, btwnValue2Field) {
                        if ((type === "btwn") || (type === "index")) {
                            valueField.typedInput('hide');
                            expValueField.typedInput('hide');
                            numValueField.typedInput('hide');
                            typeValueField.typedInput('hide');
                            btwnValueField.typedInput('show');
                        } else {
                            btwnValueField.typedInput('hide');
                            expValueField.typedInput('hide');
                            numValueField.typedInput('hide');
                            typeValueField.typedInput('hide');
                            valueField.typedInput('hide');
                            if (type === "true" || type === "false" || type === "null" || type === "nnull" || type === "empty" || type === "nempty" || type === "else") {
                                valueField.typedInput('hide');
                                typeValueField.typedInput('hide');
                            }
                            else
                                if (type === "istype") {
                                    valueField.typedInput('hide');
                                    typeValueField.typedInput('show');
                                }
                                else {
                                    typeValueField.typedInput('hide');
                                    valueField.typedInput('show');
                                }
                        }
                        if (type === "regex") {
                            row2.show();
                            row3.hide();
                        } else if ((type === "btwn") || (type === "index")) {
                            row2.hide();
                            row3.show();
                            btwnValue2Field.typedInput('show');
                        } else {
                            row2.hide();
                            row3.hide();
                        }
                    }
                    let optToAdd = { r: {} };
                    let ruleToAdd = optToAdd.r;
                    ruleToAdd.t = 'eq';
                    let mainRuleCont = $('#main-rule-container').css({ width: 'inherit' });
                    let rowToAdd = $('<div/>', { style: "padding-top: 0.45em;" }).addClass('row').appendTo(mainRuleCont);
                    let row2ToAdd = $('<div/>', { style: "padding-left: 9.5em; height: 1.5em;" }).addClass('row2').insertAfter(rowToAdd);
                    let row3ToAdd = $('<div/>', { style: "padding-top: 0.45em; padding-left: 5.5em;" }).addClass('row3').insertAfter(row2ToAdd);
                    let selectFieldToAdd = $('<select class="select-field-custom"/>', { style: "width: 120px;position: relative; top: 0.15em;text-align: center;" }).appendTo(rowToAdd);
                    for (let d in operators) {
                        if (operators[d].kind === 'V') {
                                /* group0 */selectFieldToAdd.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t) ? node._(operators[d].t) : operators[d].t));
                        }
                    }
                    for (let d in operators) {
                        if (operators[d].kind === 'S') {
                            selectFieldToAdd.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t) ? node._(operators[d].t) : operators[d].t));
                        }
                    }
                    for (let d in operators) {
                        if (operators[d].kind === 'O') {
                            selectFieldToAdd.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t) ? node._(operators[d].t) : operators[d].t));
                        }
                    }
                    let valueFieldToAdd = $('<input/>', { class: "node-input-rule-value", type: "text", style: "margin-left: 5px;" }).appendTo(rowToAdd).typedInput({ default: 'str', types: [...bhTypes, ...otherTypes,/* 'msg', 'flow', 'global', 'str', 'num',  'jsonata', 'env', previousValueType */], noErrorElement: false });
                    let numValueFieldToAdd = $('<input/>', { class: "node-input-rule-num-value", type: "text", style: "margin-left: 5px;" }).appendTo(rowToAdd).typedInput({ default: 'num', types: [...bhTypes, ...otherTypes], noErrorElement: false });
                    let expValueFieldToAdd = $('<input/>', { class: "node-input-rule-exp-value", type: "text", style: "margin-left: 5px;" }).appendTo(rowToAdd).typedInput({ default: 'jsonata', types: ['jsonata'], noErrorElement: false });
                    let btwnValueFieldToAdd = $('<input/>', { class: "node-input-rule-btwn-value", type: "text", style: "margin-left: 5px;" }).appendTo(rowToAdd).typedInput({ default: 'num', types: [...bhTypes, ...otherTypes], noErrorElement: false });
                    let btwnAndLabelToAdd = $('<span/>', { class: "node-input-rule-btwn-label" }).text(" " + andLabel + " ").appendTo(row3ToAdd);
                    let btwnValue2FieldToAdd = $('<input/>', { class: "node-input-rule-btwn-value2", type: "text", style: "margin-left:2px;" }).appendTo(row3ToAdd).typedInput({ default: 'num', types: [...bhTypes, ...otherTypes], noErrorElement: false });
                    let typeValueFieldToAdd = $('<input/>', { class: "node-input-rule-type-value", type: "text", style: "margin-left: 5px;" }).appendTo(rowToAdd)
                        .typedInput({
                            default: '"string"', types: [
                                { value: '"string"', label: "string", constant: true },
                                { value: '"number"', label: "number", constant: true },
                                { value: '"boolean"', label: "boolean", constant: true },
                                { value: '"array"', label: "array", constant: true },
                                { value: '"buffer"', label: "buffer", constant: true },
                                { value: '"object"', label: "object", constant: true },
                                { value: '"json"', label: "JSON string", constant: true },
                                { value: '"undefined"', label: "undefined", constant: true },
                                { value: '"null"', label: "null", constant: true }
                            ],
                            noErrorElement: false
                        });
                    let { toggleGroup: toggleGroupToAdd, toggleIp: caseSensitiveToAdd } = createToggleButton(caseLabel, { width: '10em' });
                    toggleGroupToAdd.appendTo(row2ToAdd);
                    selectFieldToAdd.change(function () {
                        ruleToAdd.t = selectFieldToAdd.val();
                        changeHandler(row2ToAdd, row3ToAdd, ruleToAdd.t,
                            valueFieldToAdd, expValueFieldToAdd, numValueFieldToAdd, typeValueFieldToAdd, btwnValueFieldToAdd, btwnValue2FieldToAdd);
                        resizeRule(mainRuleCont, '', 6);
                    });
                    selectFieldToAdd.val(ruleToAdd.t);
                    selectFieldToAdd.change();

                    let invalidListMsg = $(`.list-keys-invalid`).css({ 'visibility': 'hidden' });

                    let editableListContainer = $("#node-input-rule-container")
                        .css({ 'min-width': '450px' })
                        .data({ isValid: true, isUnique: true });
                    let propsContainer = $('.properties-container').css({ 'margin-bottom': '0' });
                    /*------------------------------------------old---------------------------------------------*/
                    function validateEditableList() {
                        if ([...$('#node-input-rule-container .red-ui-typedInput-input.input-error')].some(e => !$(e).is(':hidden'))) {
                            editableListContainer.data('isValid', false);
                        } else {
                            editableListContainer.data('isValid', true);
                        }
                        SRD.defaults.validateForm(SRD.validators.editableList(propsContainer, editableListContainer, {
                            errorMsgContainer: invalidListMsg,
                            errorMsg: 'Invalid properties'
                        }));
                    }
                    editableListContainer.editableList({
                        addItem: function (container, i, opt, miscElms) {
                            propsContainer.show();
                            if (!opt.hasOwnProperty('r')) {
                                opt.r = getRule(mainRuleCont, optToAdd.r.t, SRD)
                            }
                            var rule = opt.r;
                            if (!rule.hasOwnProperty('t')) {
                                rule.t = 'eq';
                            }
                            if (!opt.hasOwnProperty('i')) {
                                opt._i = Math.floor((0x99999 - 0x10000) * Math.random()).toString();
                            }
                            container.css({
                                // overflow: 'hidden',
                                whiteSpace: 'nowrap',
                                'flex-wrap': 'wrap',
                                'justify-content': 'space-between'
                            });
                            var row = $('<div/>', { style: "padding-top: 0.45em;" }).addClass('row').appendTo(container);
                            var row2 = $('<div/>', { style: "padding-left: 9.5em; height: 1.5em;" }).addClass('row2').appendTo(container);
                            var row3 = $('<div/>', { style: "padding-top: 0.45em; padding-left: 5.5em;" }).addClass('row3').appendTo(container);
                            var selectField = $('<select class="select-field-custom"/>', { style: "width: 120px; position: relative; top: 0.15em;text-align: center;" }).appendTo(row);
                            // var group0 = $('<optgroup/>', { label: "value rules" }).appendTo(selectField);
                            for (var d in operators) {
                                if (operators[d].kind === 'V') {
                                /* group0 */selectField.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t) ? node._(operators[d].t) : operators[d].t));
                                }
                            }
                            // var group1 = $('<optgroup/>', { label: "sequence rules" }).appendTo(selectField);
                            for (var d in operators) {
                                if (operators[d].kind === 'S') {
                                /* group1 */selectField.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t) ? node._(operators[d].t) : operators[d].t));
                                }
                            }
                            for (var d in operators) {
                                if (operators[d].kind === 'O') {
                                    selectField.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t) ? node._(operators[d].t) : operators[d].t));
                                }
                            }
                            var valueField = $('<input/>', { class: "node-input-rule-value", type: "text", style: "margin-left: 5px;" }).appendTo(row).typedInput({ default: 'str', types: [...bhTypes, ...otherTypes,/* 'msg', 'flow', 'global', 'str', 'num',  'jsonata', 'env', previousValueType */], change: validateEditableList, noErrorElement: false });
                            var numValueField = $('<input/>', { class: "node-input-rule-num-value", type: "text", style: "margin-left: 5px;" }).appendTo(row).typedInput({ default: 'num', types: [...bhTypes, ...otherTypes,/* 'flow', 'global', 'num', 'jsonata', 'env' */], change: validateEditableList, noErrorElement: false });
                            var expValueField = $('<input/>', { class: "node-input-rule-exp-value", type: "text", style: "margin-left: 5px;" }).appendTo(row).typedInput({ default: 'jsonata', types: ['jsonata'], noErrorElement: false });
                            var btwnValueField = $('<input/>', { class: "node-input-rule-btwn-value", type: "text", style: "margin-left: 5px;" }).appendTo(row).typedInput({ default: 'num', types: [...bhTypes, ...otherTypes, /* 'msg',  'flow', 'global', 'str', 'num', 'jsonata', 'env', previousValueType */], change: validateEditableList, noErrorElement: false });
                            var btwnAndLabel = $('<span/>', { class: "node-input-rule-btwn-label" }).text(" " + andLabel + " ").appendTo(row3);
                            var btwnValue2Field = $('<input/>', { class: "node-input-rule-btwn-value2", type: "text", style: "margin-left:2px;" }).appendTo(row3).typedInput({ default: 'num', types: [...bhTypes, ...otherTypes/* 'msg', 'flow', 'global', 'str', 'num', 'jsonata', 'env', previousValueType */], change: validateEditableList, noErrorElement: false });
                            var typeValueField = $('<input/>', { class: "node-input-rule-type-value", type: "text", style: "margin-left: 5px;" }).appendTo(row)
                                .typedInput({
                                    default: '"string"', types: [
                                        { value: '"string"', label: "string", constant: true },
                                        { value: '"number"', label: "number", constant: true },
                                        { value: '"boolean"', label: "boolean", constant: true },
                                        { value: '"array"', label: "array", constant: true },
                                        { value: '"buffer"', label: "buffer", constant: true },
                                        { value: '"object"', label: "object", constant: true },
                                        { value: '"json"', label: "JSON string", constant: true },
                                        { value: '"undefined"', label: "undefined", constant: true },
                                        { value: '"null"', label: "null", constant: true }
                                    ],
                                    noErrorElement: false
                                });
                            // var finalspan = $('<span/>', { style: "float: right;margin-top: 6px;" }).appendTo(row);
                            // finalspan.append(' &#8594; <span class="node-input-rule-index">' + (i + 1) + '</span> ');
                            // var caseSensitive = $('<input/>', { id: "node-input-rule-case-" + i, class: "node-input-rule-case", type: "checkbox", style: "width:auto;vertical-align:top" }).appendTo(row2);
                            // $('<label/>', { for: "node-input-rule-case-" + i, style: "margin-left: 3px;" }).text(caseLabel).appendTo(row2);
                            const { toggleGroup, toggleIp: caseSensitive } = createToggleButton(caseLabel);
                            toggleGroup.appendTo(row2);
                            caseSensitive.attr({ 'class': "node-input-rule-case", 'id': "node-input-rule-case-" + i });
                            selectField.change(function () {
                                changeHandler(row2, row3, selectField.val(), valueField, expValueField, numValueField,
                                    typeValueField, btwnValueField, btwnValue2Field);
                                resizeRule(container);
                                validateEditableList();
                            });
                        selectField.val(rule.t);
                        if ((rule.t == "btwn") || (rule.t == "index")) {
                            btwnValueField.typedInput('type', rule.vt || 'num');
                            btwnValueField.typedInput('value', rule.v);
                            btwnValue2Field.typedInput('type', rule.v2t || 'num');
                            btwnValue2Field.typedInput('value', rule.v2);
                        } else if ((rule.t === "head") || (rule.t === "tail")) {
                            numValueField.typedInput('type', rule.vt || 'num');
                            numValueField.typedInput('value', rule.v);
                        } else if (rule.t === "istype") {
                            typeValueField.typedInput('type', rule.vt);
                            typeValueField.typedInput('value', rule.vt);
                        } else if (rule.t === "jsonata_exp") {
                            expValueField.typedInput('type', rule.vt || 'jsonata');
                            expValueField.typedInput('value', rule.v);
                        } else if (typeof rule.v != "undefined") {
                            valueField.typedInput('type', rule.vt || 'str');
                            valueField.typedInput('value', rule.v);
                        }
                        if (rule.case) {
                            caseSensitive.prop('checked', true);
                        } else {
                            caseSensitive.prop('checked', false);
                        }
                        selectField.change();

                            var currentOutputs = JSON.parse(outputCount.val() || "{}");
                            currentOutputs[opt.hasOwnProperty('i') ? opt.i : opt._i] = i;
                            outputCount.val(JSON.stringify(currentOutputs));
                            miscElms.deleteBtn ? miscElms.deleteBtn.attr('class', 'switch-delete-icon') : null;
                            if (miscElms.sortableHandle) {
                                miscElms.sortableHandle.css({
                                    'padding-top': '1em',
                                    'right': '.75em'
                                })
                            }
                            container.find('.red-ui-typedInput-input input').on('input', (event) => {
                                validateEditableList();
                            });
                            $('#main-rule-container .node-input-rule-value').typedInput('value', '');
                        },
                        removeItem: function (opt) {
                            var currentOutputs = JSON.parse(outputCount.val() || "{}");
                            if (opt.hasOwnProperty('i')) {
                                currentOutputs[opt.i] = -1;
                            } else {
                                delete currentOutputs[opt._i];
                            }
                            var rules = $("#node-input-rule-container").editableList('items');
                            rules.each(function (i) {
                                $(this).find(".node-input-rule-index").html(i + 1);
                                var data = $(this).data('data');
                                currentOutputs[data.hasOwnProperty('i') ? data.i : data._i] = i;
                            });
                            outputCount.val(JSON.stringify(currentOutputs));
                            if (editableListContainer.editableList('items').length === 0) {
                                propsContainer.hide();
                            }
                            validateEditableList();
                        },
                        resizeItem: resizeRule,
                        sortItems: function (rules) {
                            var currentOutputs = JSON.parse(outputCount.val() || "{}");
                            var rules = $("#node-input-rule-container").editableList('items');
                            rules.each(function (i) {
                                $(this).find(".node-input-rule-index").html(i + 1);
                                var data = $(this).data('data');
                                currentOutputs[data.hasOwnProperty('i') ? data.i : data._i] = i;
                            });
                            outputCount.val(JSON.stringify(currentOutputs));
                        },
                        sortable: true,
                        removable: true,
                        validator: function () {
                            const errorExists = [...$('#main-rule-container .red-ui-typedInput-input.input-error')].some(e => !$(e).is(':hidden'));
                            if (errorExists) {
                                SRD.dialogService.openSnackBar('Invalid value. Please key-in the correct value based on the type.');
                            }
                            return !errorExists;
                        }
                    });
                    $('.add-prop-btn-wrp').css({ 'margin-top': '0.5em' }).insertAfter(mainRuleCont);
                    propsContainer.hide();
                    for (var i = 0; i < this.rules.length; i++) {
                        var rule = this.rules[i];
                        editableListContainer.editableList('addItem', { r: rule, i: i, validator: false });
                    }
                },
                oneditsave: function (SRD) {
                    var rules = $("#node-input-rule-container").editableList('items');
                    var ruleset;
                    var node = this;
                    node.rules = [];
                    rules.each(function (i) {
                        var ruleData = $(this).data('data');
                        var rule = $(this);
                        var type = rule.find("select").val();
                        node.rules.push(getRule(rule, type, SRD));
                    });
                    this.propertyType = $("#node-typedInput-property").typedInput('type');
                    this.property = $("#node-typedInput-property").typedInput('value');
                    this.propertyGv = SRD.utils.getPropertyGenVal($("#node-typedInput-property").typedInput('value'), this.propertyType);
                },
                oneditresize: function (size) {
                    var rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
                    var height = size.height;
                    for (var i = 0; i < rows.length; i++) {
                        height -= $(rows[i]).outerHeight(true);
                    }
                    var editorRow = $("#dialog-form>div.node-input-rule-container-row");
                    height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
                    $("#node-input-rule-container").editableList('height', height);
                    resizeRule($('#main-rule-container'), '', 6);
                },
                docsLink: 'switch-node'
            }
        });
    })();
</script>
<script type="text/x-red" data-help-name="Switch">
</script>