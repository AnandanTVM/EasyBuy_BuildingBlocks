<script type="text/x-red" data-template-name="Catch">
    <div class="editor-form-row">
            <label for="node-input-selectCatchType"  class="label-input">Catch errors from</label> 
            <select style="width:100%;" type="text" id="node-input-selectCatchType">
                <option value="allnodes">All nodes </option>
                <option value="selectednodes"> Selected nodes </option>
            </select>
        </div>
        
        <!-- List of checkbox to select nodes -->
        <div id="nodes-checkbox-container" class="margin-top-1">
        </div>
    </script>
    <script type="text/javascript">
        registerNode({
            nodeType: 'Catch',
            nodeDef: {
                color: "#FF4B2B",
                category: 'General',
                defaults: {
                    name: {
                        value: ''
                    },
                    selectedNodes: {
                        value: ''
                    },
                    selectCatchType: {
                        value: 'allnodes'
                    },
                    masternodeList: {
                        value: ''
                    },
                    ignoreList: {
                        value: ''
                    }
                },
                inputs: 0,
                outputs: 1,
                icon: "ndefault-all-nodes/catch-node.svg",
                label: function () {
                    return this.name || "Catch";
                },
                oneditprepare: function (SRD) {
                    const nodeID = this.id;
                    const ignoreConnectedNodes = SRD.nodes.getAllTargetNodes(this).map(n => n.id).filter(n => nodeID !== n);
                    this.selectedNodes = this.selectedNodes ? this.selectedNodes : [];
    
                    /*Get list of nodes that are not of type Catch*/
                    function getNodes(name) {
                        let node = this;
                        this.masternodeList = SRD.nodes.filterNodes({
                            z: SRD.workspaces.active()
                        }).filter(v => v.type != 'Catch');
                    }
    
                    /*Toggle between selected nodes and all nodes*/
                    function toggleCheckboxView(state) {
                        if (state === true) {
                            $('#nodes-checkbox-container').css({
                                display: 'block'
                            });
                        } else {
                            $('#nodes-checkbox-container').css({
                                display: 'none'
                            });
                        }
                    }
    
                    /*Create checbox list from the current tab nodes which are not type Catch*/
                    function createCheckboxItems(selectedNodes) {
                        for (let index = 0; index < this.masternodeList.length; index++) {
                            //skip Nodes
                            if(ignoreConnectedNodes.includes(this.masternodeList[index]['id']) || this.masternodeList[index]["inputs"] === 0 && this.masternodeList[index]["outputs"] === 0 )
                                continue;
                            //END Skip Nodes
                            const elId = `node-input-${this.masternodeList[index]['id']}`;
                            if ($('#' + elId).length === 0) {
                                const isChecked = selectedNodes.includes(this.masternodeList[index]['id']) ?
                                    'checked' : null;
                                const nodeName = this.masternodeList[index].name || this.masternodeList[index].type;
                                const checkboxEl =
                                    $(`
                                    <div class="output-toggle-group padding-top-0" style="width: 100%">
                                        <div style="min-width: 50%" class="fileout-toggle-label text-overflow-ellipsis"> ${nodeName} (${this.masternodeList[index].type})</div>
                                        <div style="min-width: 50%" class="toggle-button">
                                            <label class="switch">
                                                <input id="${elId}" name="${this.masternodeList[index]['id']}" type="checkbox" ${isChecked}>
                                                <span class="slider round"></span>
                                            </label>
                                        </div>
                                    </div>
                                    `);
                                $('#nodes-checkbox-container').append(checkboxEl);
                            }
    
                        }
                    }
    
    
                    /*Attach select change event*/
                    $('#node-input-selectCatchType').selectField({}).change(() => {
                        const catchType = $('#node-input-selectCatchType').val();
    
                        if (catchType === 'selectednodes') {
                            getNodes();
                            toggleCheckboxView(true);
                            createCheckboxItems(this.selectedNodes);
                        } else {
                            toggleCheckboxView(false);
                        }
                    })
                },
                onservicesave: function(SRD, flowObject) {
                    const node = this;
                    /*Get all the nodes connected a catch node which can be used to ignore the error catch from this nodes*/
                    if (this.selectCatchType === 'allnodes') {
                        const nodeMap = flowObject.reduce((flowObject, node) => {
                            if (node.type !== 'tab') {
                                flowObject[node.id] = node;
                            }
                            return flowObject;
                        }, {});
    
                        this.ignoreList = getAllOutputNodes(node).map(n => n.id);
    
                        function getAllOutputNodes(node, __rnodes = [], visitedNs = {}) {
                            if (Array.isArray(node.wires) && node.wires.length) {
                                for (let j = 0; j < node.wires.length; j++) {
                                    const pnodes = node.wires[j];
                                    if (Array.isArray(pnodes) && pnodes.length) {
                                        for (let k = 0; k < pnodes.length; k++) {
                                            const pnode = nodeMap[pnodes[k]];
                                            if (!visitedNs[pnodes[k]]) {
                                                visitedNs[pnodes[k]] = true;
                                                __rnodes.push(pnode);
                                                getAllOutputNodes(pnode, __rnodes, visitedNs);
                                            }
                                        }
                                    }
                                }
    
                            }
                            return __rnodes;
                        }
                    }
                },
                oneditsave: function (SRD) {
                    /*Get selected checkboxes*/
                    if ($('#node-input-selectCatchType').val() === 'selectednodes') {
                        const selected = [];
                        $('input:checked').each(function () {
                            selected.push($(this).attr('name'));
                        });
                        this.selectedNodes = selected;
                        console.log(this.selectedNodes)
                        console.log(this.masternodeList)
                    } else { /*Get all nodes in the tab*/
                        this.selectedNodes = 'all-nodes';
                    }
                },
                docsLink: 'catch-node'
            },
    
        });
    </script>