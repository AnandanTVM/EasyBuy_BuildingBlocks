<script type="text/x-red" data-template-name="CallService">
	<div class="editor-form-row">
		<label for="node-service-picker">Select a flow</label>
		<div id="node-service-picker" style="width:99%;"></div>
	</div> 
	<div id="input-props-section" class="props-section editor-form-row">
		<label for="input-props-section"><span  data-i18n="common.label.input-title"></span></label>
		<div class="properties-container">
			<ol id="input-properties-content"></ol>
		</div>
	</div>
	<div id="output-props-section" class="props-section editor-form-row">
		<label for="output-props-section"><span  data-i18n="common.label.output-title"></span></label>
		<div class="properties-container">
			<ol id="output-properties-content"></ol>
		</div>
	</div>
</script>

<script type="text/javascript">
    registerNode({
        nodeType: 'CallService',
        nodeDef: {
            color: "#333399",
            category: 'General',
            defaults: {
                name: { value: "" },
                outputs: { value: 1 },
                noerr: { value: 0, required: true, validate: function (v) { return ((!v) || (v === 0)) ? true : false; } },
                service: { value: '', required: true },
                flow: { value: '', required: true },
                inputVariables: [{ key: '', value: '', map: '', valueType: '', mapVarType: '' }],
                outputMapping: [{ key: '', value: '', localVar: '', mapVarType: '', mapVarName: '', valueType: '' }],
                callService: { value: "", validate: (v) => typeof v === 'string' },
                startName: { value: "", required: true },
                inputParams: { value: [] },
                accept_bh: { value: false }
            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-all-nodes/call-service-node.svg",
            usedServiceIds: function (S) {
                return this.service ? [this.service.id || this.service.serviceId] : [];
            },
            onserviceusersupdate: function (S, { action, id }) {
                if (action === 'delete-workspace') {
                    this.callService = null;
                    this.service = null;
                } else {
                    if (this.service) {
                        const wsObj = S.utils.getServiceObject(this.service.id);
                        this.service = wsObj;
                        this.callService = null;
                        if (this.service && this.service.id) {
                            this.callService = S.utils.getRelativePathFrom(this.z, this.service.id || this.service.serviceId);
                        }
                    }
                }
            },
            paletteLabel: function (def) { return 'Call Service'; },
            label: function () {
                return this.name || 'Call Service'
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function (SRD) {
                const node = this;
                let serviceList = [];
                let flowsList = [];
                let startNodesArr = [];
                let isServiceExists = false;
                let isFlowExits = false;
                // variables to assign new start node inputs and outputs 
                let startNwInputVar = [];
                let startNwLocalVar = [];
                let widgetCtx = null;
                /* Add input and output properties section */
                addPropsSection('input');
                addPropsSection('output');

                $('#node-service-picker').flowPicker({
                    onTreeInit: (ctx) => {
                        widgetCtx = ctx;
                        if (node.flow.flowId) {
                            const res = widgetCtx.getILvariables(node.flow.flowId);
                            startNwInputVar = res.inputVariables;
                            startNwLocalVar = res.localVariables;
                            /* Hide the properties list by default. It will be displayed whenever 'addItem' runs */
                            $('#output-props-section').hide();
                            $('#input-props-section').hide();
                            fillVariables('input', getNwInputVariables());
                            fillVariables('output', getNwOutputVariables());
                        }
                    },
                    selectedFlow: node?.flow?.flowId,
                    onNodeSelect: (data, selectingSelectedFlow) => {
                        if (data.flownode && !selectingSelectedFlow) {
                            $('#input-properties-content').children().remove();
                            $('#output-properties-content').children().remove();
                            $('#output-props-section').hide();
                            $('#input-props-section').hide();
                            updateAcceptBhVarsAndFields(data.flownode.id);
                            fillVariables('input', getInputVariables(data.flownode.inputVariables));
                            fillVariables('output', getOutputVariables(data.flownode.inputVariables, data.flownode.localVariables));
                            isFlowExits = true;
                            $('#select-flow-error').hide();
                        }
                    },
                    srd: SRD
                })
                // get new Input varibales based on start properties
                function getNwInputVariables() {
                    let nwInputAttrArr = [];
                    let oldInputAttrArr = node.inputVariables;

                    nwInputAttrArr = startNwInputVar.map(function (elem1) {
                        let tempElem2;
                        let isElePresent = oldInputAttrArr.some(function (elem2) {
                            tempElem2 = elem2;
                            return (elem1.key === elem2.key);
                        });
                        if (isElePresent) {
                            return tempElem2;
                        } else {
                            return { key: elem1.key, value: '', map: true, valueType: 'bh', mapVarType: 'input' };
                        }
                    });

                    return nwInputAttrArr;
                }

                function getOutputVariables(inputVariables, localVariables) {
                    let outputVariables = []
                    if (Array.isArray(inputVariables)) {
                        inputVariables.forEach((ele) => {
                            if (ele.output) {
                                outputVariables.push({ key: ele.key, value: '', mapVarType: 'input', mapVarName: 'bh', valueType: 'bh' })
                            }
                        });
                    }
                    if (Array.isArray(localVariables)) {
                        localVariables.filter((ele) => {
                            if (ele.output) {
                                outputVariables.push({ key: ele.key, value: '', mapVarType: 'local', mapVarName: 'bh', valueType: 'bh' })
                            }
                        });
                    }
                    return outputVariables;
                }

                function getNwOutputVariables() {
                    let nwInputLocalOutVar = []
                    let oldOutputAttrArr = node.outputMapping;
                    startNwInputVar.filter(function (elem1) {
                        let tempElem2;
                        let isElePresent = oldOutputAttrArr.some(function (elem2) {
                            tempElem2 = elem2;
                            return (elem1.key === elem2.key && elem1.output == true);
                        });
                        if (isElePresent) {
                            nwInputLocalOutVar.push(tempElem2);
                        } else if (elem1.output) {
                            nwInputLocalOutVar.push({ key: elem1.key, value: '', mapVarType: 'input', mapVarName: 'bh', valueType: 'bh' });
                        }
                    });

                    startNwLocalVar.filter(function (elem1) {
                        let tempElem2;
                        let isElePresent = oldOutputAttrArr.some(function (elem2) {
                            tempElem2 = elem2;
                            return (elem1.key === elem2.key && elem1.output == true);
                        });
                        if (isElePresent) {
                            nwInputLocalOutVar.push(tempElem2);
                        } else if (elem1.output) {

                            nwInputLocalOutVar.push({ key: elem1.key, value: '', mapVarType: 'local', mapVarName: 'bh', valueType: 'bh' });
                        }
                    });
                    return nwInputLocalOutVar;
                }

                function getInputVariables(inputVariables) {
                    let retVars = [];
                    if (Array.isArray(inputVariables)) {
                        retVars = inputVariables.map((ele) => {
                            return { key: ele.key, value: '', mapVarType: 'input', valueType: 'bh', map: true }

                        });
                    }
                    return retVars;
                }

                function updateAcceptBhVarsAndFields(flowId) {
                    node.accept_bh = SRD.nodes.node(flowId).accept_bh;
                    if (node.accept_bh) {
                        $('#accept_bh-explainer').show();
                    } else {
                        $('#accept_bh-explainer').hide();
                    }
                }


                if (isFlowExits) {
                    $('#select-flow-error').hide();
                    updateAcceptBhVarsAndFields(node.flow['flowId']);
                } else {
                    $('#output-props-section').hide();
                    $('#accept_bh-explainer').hide();
                    $('#input-props-section').hide();
                }


                function fillVariables(sectionName, variablesObjectArr) {
                    if (variablesObjectArr && variablesObjectArr instanceof Array) {
                        for (let row of variablesObjectArr)
                            $(`#${sectionName}-properties-content`).editableList('addItem', { rowData: row, validator: false });
                    }
                }

                function addPropsSection(sectionName, dialogForm) {

                    /* Output toggle section */
                    let outputToggle = `<div class="output-toggle-group" style="margin-right: 0.5em;">
                <div class="output-toggle-label">Map</div>
                <div class="toggle-button">
                    <label class="switch">
                        <input id ="mapping-input" type="checkbox">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>`;
                    /* Properties List */
                    let propertiesContainer = $(`#${sectionName}-props-section .properties-container`)/* .appendTo(propsSection) */;

                    let propertiesHeaderContainer = $(`<div class="properties-header-container"></div>`).prependTo(propertiesContainer);

                    if (sectionName == 'input') {
                        let headers = $(`
                <div class="header">No.</div>
                <div class="wide-header">Key</div>
                <div class="wide-header">Value</div>
                <div class="header map-header">Map</div>
                `).appendTo(propertiesHeaderContainer);
                    } else {
                        let headers = $(`
                <div class="header">No.</div>
                <div class="wide-header wide-header-output">Key</div>
                <div class="wide-header wide-header-output">Value</div>
                `).appendTo(propertiesHeaderContainer);
                    }


                    let varArrType = sectionName === 'input' ? 'inputVariables' : 'outputVariables';

                    let propsContent = $(`#${sectionName}-properties-content`).data({ valid: true, isUnique: true, isValid: true });
                    propsContent./* appendTo(propertiesContainer). */editableList({
                        addItem: function (container, i, data) {
                            let rowData = data.rowData || {};
                            /* property list's "key" field */
                            let listKey = $(`<input type="text"/>`).appendTo(container).inputField({
                                attrs: { style: 'width: 80%' },
                                inputClassList: "property-key",
                                props: {
                                    readonly: true
                                },
                                value: sectionName == 'input' ? `bh.input.${rowData.key}` : `bh.${rowData.mapVarType}.${rowData.key}`,
                            });

                            let valueElementTypedInput = `<div class="form-row field-wrapper-typedInput">
                                                          <input type="text" class="node-input-property input-width" style="width: 90% !important"/>
                                                          <input type="hidden" id="node-input-outputs"/>
                                                      </div>`
                            // input element is used to create value filed in input properties table and type section in the output table
                            let valueElement = `<input type="text" id="value-input" style="width: 90% !important" >`;
                            let listVal;
                            let listValInput;
                            let valueElementTypedInputObj = $(valueElementTypedInput).css({ flex: 'unset' }).appendTo(container);
                            listVal = valueElementTypedInputObj.find('.node-input-property').
                                typedInput({
                                    types: [
                                        { value: "bh", label: 'bh.', validate: SRD.validators.typedInput('bh') },
                                        { value: "bh.input", label: 'bh.input.', validate: SRD.validators.typedInput('bh.input') },
                                        { value: "bh.local", label: 'bh.local.', validate: SRD.validators.typedInput('bh.local') }
                                    ]
                                });
                            // listVal = valueElementTypedInputObj.find('.node-input-property').typedInput({ types: ['bh.input', 'bh.local'] });

                            // var outputCount = $("#node-input-outputs").val("{}");
                            // listVal
                            if (rowData.valueType) {
                                listVal.typedInput('type', rowData.valueType);
                                listVal.typedInput('value', rowData.value);
                            }
                            /* property list's "value" field */
                            let dataObj = {};

                            if (sectionName == 'input') {
                                $('<span class="callservice-mapping-direction-arrows">&#x2190;</span>').appendTo(listKey.parent());
                                listValInput = $(valueElement).appendTo(container).inputField({
                                    inputClassList: "property-value",
                                    value: !rowData.map ? rowData.value || rowData.value : '',
                                    wrapperClass: rowData.map ? 'display-none value-input' : 'value-input'
                                });
                                if (!rowData.map) {
                                    valueElementTypedInputObj.addClass('display-none');
                                }
                                /* property list's "output" toggle button */
                                let listToggle = $(outputToggle).appendTo(container);
                                listToggle.find(`.output-toggle-label`).remove(); // Remove the output toggle label
                                let listToggleInputElm = listToggle.find('input');

                                listToggleInputElm.prop('checked', rowData.map || listToggleInputElm.prop('checked'))
                                    .on('input', function (event) {
                                        if ($(event.target).prop('checked')) {
                                            $(`#${container.data().data.rowData.rowId}`).children('.field-wrapper-typedInput').removeClass('display-none')
                                            listVal.typedInput('type', 'bh.input');
                                            $(`#${container.data().data.rowData.rowId}`).children('.value-input').addClass('display-none')
                                        } else {
                                            $(`#${container.data().data.rowData.rowId}`).children('.value-input').removeClass('display-none')
                                            $(`#${container.data().data.rowData.rowId}`).children('.field-wrapper-typedInput').addClass('display-none')
                                        }
                                    });
                                dataObj.map = listToggleInputElm.prop('checked')

                            } else {
                                $('<span class="callservice-mapping-direction-arrows">&#x2192;</span>').appendTo(listKey.parent());
                            }

                            dataObj.key = listKey.val();
                            // change value 
                            dataObj.value = listVal.val();
                            dataObj.rowId = rowData.rowId || SRD.nodes.id();
                            dataObj.valid = true
                            $(`#${sectionName}-props-section`).show()
                            container.attr('id', dataObj.rowId).data('data', { rowData: dataObj });
                            $(`#${dataObj.rowId}`).find('.field-wrapper.value-input').css({ width: '90%', 'margin-top': '0.25em' }); //resolved the css issue for input tag on map button toggle
                            $('.property-row .field-floating-placeholder').remove();
                            $('.add-prop-btn-wrp').remove()
                            $('.properties-container .wide-header').width($('.properties-container .field-wrapper').width()).css({
                                'margin-left': 0,
                            });

                        }
                    });
                }
            },
            oneditsave: function (SRD) {
                const flowPickerEle = $('#node-service-picker');
                this.service = flowPickerEle.flowPicker('getSelectedFlowService');
                if (this.service) {
                    this.callService = SRD.utils.getRelativePathFrom(this.z, this.service.id || this.service.serviceId);
                } else {
                    this.callService = null;
                }
                const selectedFlow = flowPickerEle.flowPicker('getSelectedFlow');
                this.flow = { flowId: selectedFlow.id, flowName: selectedFlow.functionName };
                this.startName = this.flow.flowName;
                let inputNodes = []
                let inputParamsArr = [];
                let outputMappingArr = [];

                function getMarVarType(value) {
                    let splitArr = value.split('.')
                    return splitArr[1];
                }
                if (!this.accept_bh) {
                    // to read input variables;
                    $(`#input-properties-content`).editableList('items').each(function (i) {
                        let row = $(this);
                        let inputObj = {};
                        inputObj.key = (row.find('.property-key').val()).substring('bh.input.'.length);
                        inputObj.map = (row).find('#mapping-input').prop('checked');

                        if (row.find(`.field-wrapper-typedInput.display-none`).length) {
                            let value = (row).find('.property-value').val();
                            inputObj.value = value;
                            inputParamsArr.push(value);
                        } else {
                            let valueType = row.find(".node-input-property").typedInput('type');
                            let value = row.find(".node-input-property").typedInput('value');
                            inputObj.valueType = valueType;
                            inputObj.value = value;
                            if (inputObj.value.length > 0) {
                                inputParamsArr.push(`${valueType}.${value}`);
                            } else {
                                inputParamsArr.push(undefined);
                            }
                        }
                        inputNodes.push(inputObj);
                    });
                    $('#output-properties-content').editableList('items').each(function (i) {
                        let row = $(this);
                        outputObj = {}
                        let key = (row).find('.property-key').val()
                        outputObj.mapVarType = getMarVarType(key);
                        outputObj.key = key.substring(`bh.${outputObj.mapVarType}.`.length);
                        outputObj.valueType = row.find(".node-input-property").typedInput('type');
                        outputObj.value = row.find(".node-input-property").typedInput('value');
                        outputObj.mapVarName = outputObj.key
                        if (outputObj.value.length > 0) {
                            outputObj.localVar = `${outputObj.valueType}.${outputObj.value}`;
                        } else {
                            outputObj.localVar = undefined;
                        }
                        //property-mapVarType
                        outputMappingArr.push(outputObj);
                    });
                } else {
                    inputParamsArr = ['bh'];
                }
                this.inputParams = inputParamsArr;
                this.inputVariables = inputNodes;
                this.outputMapping = outputMappingArr;
            },
            oneditresize: function (size) {
                $('.properties-container .wide-header').width($('.properties-container .field-wrapper').width()).css({
                    'margin-left': 0,
                });
            },
            docsLink: 'call-service-node'
        }
    });
</script>