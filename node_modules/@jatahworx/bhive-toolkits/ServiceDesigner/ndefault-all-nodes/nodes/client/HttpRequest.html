<script type="text/x-red" data-template-name="HttpRequest">
<!-- Method -->
    <div class="http-container editor-form-row-margin-bottom-0">
        <label for="node-input-method-select"> <span data-i18n="http-request.label.method"></span></label>
        <div class="http-element-container">
            <select id="node-input-method-select" class="select-method">
            </select>
            <div class="field-wrapper-typedInput display-none" id="node-input-method-map-container">
                <input type="text" id="node-input-method-map" class="node-input-property typed-input-width"
                    style="width: 100% !important" />
                <input type="hidden" id="node-input-outputs" />
            </div>
            <button class="map-button-wrp">
                <image id="node-input-method-button" class="map-button" title="Map" src="assets/serviceDesigner/refresh.svg"></image>
            </button>
        </div>
        <div class="error-msg-container"><span id="invalid-method-mapping-error" class="invalid-select display-none">Invalid Mapping</span></div>
    </div>

    <!-- Url -->
    <div class="http-container editor-form-row-margin-bottom-0">
        <label for="node-input-url"> <span data-i18n="http-request.label.url"></span></label>
        <div class="http-element-container">
            <input type="text" id="node-input-url">
            <div class="field-wrapper-typedInput display-none" id="node-input-url-map-container">
                <input type="text" id="node-input-url-map" class="node-input-property typed-input-width"
                    style="width: 100% !important" />
                <input type="hidden" id="node-input-outputs" />
            </div>
            <button class="map-button-wrp">
                <image id="node-input-url-button" class="map-button" title="Map" src="assets/serviceDesigner/refresh.svg"></image>
            </button>
        </div>
        <div class="error-msg-container">
            <span id="invalid-url-mapping-error" class="invalid-select display-none">Invalid Mapping</span>
        </div>
    </div>

    <!-- ReturnType -->
    <div class="http-container editor-form-row-margin-bottom-0">
        <label for="node-input-returntype-select"> <span data-i18n="http-request.label.returntype"></span></label>
        <div class="http-element-container">
            <select id="node-input-returntype-select" class="select-method">
            </select>
            <div class="field-wrapper-typedInput display-none" id="node-input-returntype-map-container">
                <input type="text" id="node-input-returntype-map" class="node-input-property typed-input-width"
                    style="width: 100% !important" />
                <input type="hidden" id="node-input-outputs" />
            </div>
            <button class="map-button-wrp">
                <image id="node-input-returntype-button" class="map-button" title="Map" src="assets/serviceDesigner/refresh.svg"></image>
            </button>
        </div>
        <div class="error-msg-container"><span id="invalid-returntype-mapping-error" class="invalid-select display-none">Invalid Mapping</span></div>
    </div>

    <!-- Body -->
    <div class="http-container editor-form-row">
        <label for="node-input-body"><span data-i18n="http-request.label.body"></span></label>
        <div class="form-row  field-wrapper-typedInput" id="node-input-body">
            <input type="text" id="node-input-body-map" class="node-input-property typed-input-width"
                style="width: 100% !important" />
            <input type="hidden" id="node-input-outputs" />
        </div>
    </div>

    <!-- Result Mapping -->
    <div class="http-container editor-form-row-margin-bottom-0">
        <label for="node-input-result-mapping" class="editor-form-row-label"><span data-i18n="common.label.result-mapping"></span></label>
        <div class="field-wrapper-typedInput http-element-container" id="node-input-result-mapping">
            <input type="text" id="node-input-result-mapping-map" class="node-input-property typed-input-width"
                style="width: 100% !important" />
            <input type="hidden" id="node-input-outputs" />
        </div>
        <div class="error-msg-container"><span id="invalid-resultmapping-mapping-error" class="invalid-select display-none">Invalid Mapping</span></div>
    </div>
    
    <!-- Headers -->
    <div id="props-section-container" class="http-container editor-form-row-margin-bottom-0">
        <div style="display: flex">
            <label for="headers-props-section">
                <span  data-i18n="common.label.headers-title"></span>
            </label>
            <image style="display:none !important;" id="node-input-headers-button" title="Map"/></image>
        </div>
        <div class="form-row field-wrapper-typedInput display-none" id="node-input-headers-map-container"
        style="margin-bottom: 1em; margin-top: 0.75em;">
            <input type="text" id="node-input-headers-map" class="node-input-property typed-input-width"
                style="width: 100% !important;" />
            <input type="hidden" id="node-input-outputs" />
            <button class="map-button-wrp" style="height: 100%; margin-top: 0.75em;">
                <image class="map-button proxy-map-value-toggle-headers" title="Value" src="assets/serviceDesigner/edit.svg" 
                style="margin-bottom: 0.75em;"></image>
            </button>
        </div>
        <div id="headers-props-section" class="props-section">
            <div class="add-section headers-section">
                <div class="srd-editableList-add-kv-wrp">
                    <input type="text" class="property-key" name="headers-key">
                    <input type="text" class="property-value" name="headers-value">
                </div>
                <button class="map-button-wrp" style="margin-left: 0em;">
                    <image class="map-button proxy-map-value-toggle-headers" title="Map" src="assets/serviceDesigner/refresh.svg"></image>
                </button>
            </div>
            <div class="properties-container" validatesform="true">
                <ol id="headers-properties-content"></ol>
            </div>
            <span class="list-keys-invalid">{{Editable List Invalid Message}}</span>
        </div>
    </div>

    <!-- Params  -->
    <div id="props-section-container" class="http-container editor-form-row-margin-bottom-0">
        <div style="display: flex">
            <label for="params-props-section">
                <span  data-i18n="common.label.params-title"></span>
            </label>
            <image style="display:none !important;" id="node-input-params-button" title="Map"/></image>
        </div>
        <div class="form-row http-element-container field-wrapper-typedInput display-none" id="node-input-params-map-container" 
        style="margin-bottom: 2em; margin-top: 0.75em;">
            <input type="text" id="node-input-params-map" class="node-input-property typed-input-width"
                style="width: 100% !important" />
            <input type="hidden" id="node-input-outputs" />
            <button class="map-button-wrp" style="height: 100%; margin-top: 0.75em;">
                <image class="map-button proxy-map-value-toggle-params" title="Value" src="assets/serviceDesigner/edit.svg"
                style="margin-bottom: 0.75em;"></image>
            </button>
        </div>
            <div id="params-props-section" class="props-section">
                <div class="add-section params-section">
                    <div class="srd-editableList-add-kv-wrp">
                        <input type="text" class="property-key" name="params-key">
                        <input type="text" class="property-value" name="params-value">
                    </div>
                    <button class="map-button-wrp" style="margin-left: 0em;">
                        <image class="map-button proxy-map-value-toggle-params" title="Map" src="assets/serviceDesigner/refresh.svg"></image>
                    </button>
                </div>
                <div class="properties-container" validatesform="true">
                    <ol id="params-properties-content"></ol>
                </div>
                <span class="list-keys-invalid">{{Editable List Invalid Message}}</span>
            </div>
        </div>
    
</script>



<script type="text/javascript">
    registerNode({
        nodeType: 'HttpRequest',
        serviceType: 'client',
        nodeDef: {
            color: "#009975",
            category: 'HTTP',
            defaults: {
                name: { value: "" },
                method: {
                    value: '', validate: function (v) {
                        return this.methodMapping || v;
                    }
                },
                methodMapping: {
                    value: '', validate: function (v) {
                        return this.method || v;
                    }
                },
                methodMappingObj: { value: {} },
                urlValue: {
                    value: '', validate: function (v) {
                        return this.urlMapping || v;
                    }
                },
                urlMapping: {
                    value: '', validate: function (v) {
                        return this.urlValue || v;
                    }
                },
                urlMappingObj: { value: {} },
                ret: {
                    value: '', validate: function (v) {
                        return this.retMapping || v
                    }
                },
                retMapping: {
                    value: '', validate: function (v) {
                        return this.ret || v
                    }
                },
                retMappingObj: { value: {} },
                reqBody: { value: '' },
                reqBodyObj: { value: {} },
                resultMapping: { value: '', required: true },
                resultMappingObj: { value: {} },
                headers: { value: [] },
                headersObj: { value: {} },
                headerMapping: { value: '' },
                headerMappingObj: { value: {} },
                params: { value: [] },
                paramsObj: { value: {} },
                paramMapping: { value: '' },
                paramMappingObj: { value: {} },

            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-all-nodes/http-request-node.svg",
            paletteLabel: function (def) { return 'HTTP Request'; },
            label: function () {
                return this.name || "HTTP Request";
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function (SRD) {
                const node = this; // this refers to the node on which we are changing the properties
                const httpMethods = [
                    { value: 'get', displayValue: 'GET' },
                    { value: 'post', displayValue: 'POST' },
                    { value: 'put', displayValue: 'PUT' },
                    { value: 'delete', displayValue: 'DELETE' },
                    { value: 'patch', displayValue: 'PATCH' },
                ];
                const responseTypes = [
                    { value: 'json', displayValue: 'JSON' },
                    { value: 'text', displayValue: 'STRING' },
                    { value: 'blob', displayValue: 'BLOB' },
                    { value: 'arraybuffer', displayValue: 'ARRAY BUFFER' },
                ]
                const inputTypes = [
                    { value: 'bh', label: 'bh.' },
                    { value: "bh.input", label: 'bh.input.' },
                    { value: "bh.local", label: 'bh.local.' }
                ];
                // isMethodValid = true;
                // isUrlValid = true;
                // isReturnTypeValid = true;
                // isResultMappingValid = true;
                // isTableValid = true;
                // isUrlInputValid = false;
                node.tempVarStore = { headersVariables: [], paramsVariables: [] };

                /* get called when there are any headers or params are present*/
                function populateExistingVariables(sectionName, variablesObjectArr) {
                    if (variablesObjectArr && variablesObjectArr instanceof Array) {
                        for (let row of variablesObjectArr)
                            $(`#${sectionName}-properties-content`).editableList('addItem', { rowData: row, validator: false });
                    }
                }
                /* Creates the headers and params editable list section*/
                function decorateAndPopulatePropsSection(sectionName, dialogForm) {
                    /* Properties add section key-value fields */
                    let startKvWrp = $(`#${sectionName}-props-section .srd-editableList-add-kv-wrp`);
                    let keyField = $(`#${sectionName}-props-section .property-key`).inputField({
                        placeholder: SRD._('common.label.key'),
                        validatorRegexp: /[^\s]+/
                    });
                    let valueField = $(`#${sectionName}-props-section .property-value`).inputField({
                        placeholder: SRD._('common.label.value')
                    });

                    /* Properties List */
                    let propertiesContainer = $(`#${sectionName}-props-section .properties-container`);
                    let invalidListMsg = $(`#${sectionName}-props-section .list-keys-invalid`).css({ 'visibility': 'hidden' });

                    let propertiesHeaderContainer = $(`<div class="properties-header-container"></div>`).prependTo(propertiesContainer);

                    let headers = $(`
                <div class="header">No.</div>
                <div class="wide-header ">Key</div>
                <div class="wide-header wide-header-output">Value</div>
                `).appendTo(propertiesHeaderContainer);

                    let varArrType = sectionName === 'headers' ? 'headersVariables' : 'paramsVariables';

                    function updateTempVarStore(prop, val, currentRowIdArr, setRest) {
                        for (let i in node.tempVarStore[varArrType]) {
                            if (currentRowIdArr.includes(node.tempVarStore[varArrType][i]['rowId'])) {
                                node.tempVarStore[varArrType][i][prop] = val;
                                if (setRest === undefined) {
                                    return i;
                                }
                            } else if (setRest !== undefined) {
                                node.tempVarStore[varArrType][i][prop] = setRest;
                            }
                        }
                    }

                    function validateEditableList() {
                        return SRD.validators.editableList(propertiesContainer, propsContent, {
                            checkUniquenessOn: node.tempVarStore[varArrType].map(x => x.key),
                            checkValidityOn: node.tempVarStore[varArrType],
                            errorMsgContainer: invalidListMsg
                        });
                    }

                    let propsContent = $(`#${sectionName}-properties-content`).data({ valid: true, isUnique: true, isValid: true });
                    propsContent.editableList({
                        addItem: function (container, i, data) {
                            let rowData = data.rowData || {};

                            /* property list's "key" field */
                            let listKey = $(`<input type="text"/>`).appendTo(container).inputField({
                                wrapperAttr: { style: 'width: 40%;' },
                                validatorRegexp: /[^\s]+/,
                                disableDoneIfInvalid: true,
								inputClassList: "property-key",
								noformvalidation: false,
                                value: rowData.key || keyField.val(),
                                updations: function (elemData, inputVal) {
                                    let index = updateTempVarStore('key', inputVal, container.data().data.rowData.rowId);
                                    node.tempVarStore[varArrType][index].valid = elemData.valid;
                                    container.data('data', { rowData: node.tempVarStore[varArrType][index] });
									SRD.defaults.validateForm(validateEditableList());
                                }
                            });

                            /* property list's "defaultValue" field */
                            let listVal = $(`<input type="text"/>`).appendTo(container).inputField({
                                wrapperAttr: { style: 'width: 40%;' },
                                inputClassList: "property-value",
                                value: rowData.defaultValue || valueField.val(),
								noformvalidation: false,
								updations: function () {
                                    let index = updateTempVarStore('defaultValue', $(event.target).val(), container.data().data.rowData.rowId);
                                    container.data('data', { rowData: node.tempVarStore[varArrType][index] });
                                }
                            });

                            let dataObj = {
                                key: listKey.val(),
                                defaultValue: listVal.val(),
                                rowId: rowData.rowId || SRD.nodes.id(),
                                valid: true
                            };

                            node.tempVarStore[varArrType].push(dataObj);
                            propertiesContainer.show();
                            container.attr('id', dataObj.rowId).data('data', { rowData: dataObj });
                            $('.property-row .field-floating-placeholder').remove();
                            /* Clear the "Add" Section input fields */
                            keyField.inputField('reset');
                            valueField.inputField('reset');
                            // outputToggle.find('input').prop('checked', false);
                            $('.srd-delete-icon').addClass('http-delete-icon')
                        },
                        showAddBtnLabel: false,
                        removable: true,
                        scrollOnAdd: true,
                        removeItem: function (data) {
                            node.tempVarStore[varArrType] = node.tempVarStore[varArrType].filter(vObj => vObj['rowId'] !== data.rowData.rowId);
							SRD.defaults.validateForm(validateEditableList());
                            if (node.tempVarStore[varArrType].length === 0) {
                                $(`#${sectionName}-props-section .properties-container`).hide();
                            }
                        },
                        validator: function () {
                            let keyToValidate = keyField.val();
                            if (!keyToValidate.match(keyField.inputField('option', 'validatorRegexp'))) {
                                SRD.dialogService.openSnackBar('Invalid key. It should contain atleast one character.');
                                return false;
                            }
                            if (node.tempVarStore[varArrType].find(vObj => vObj['key'] === keyToValidate)) {
                                SRD.dialogService.openSnackBar('Duplicate key. This key already exists.');
                                return false
                            }
                            return true;
                        }
                    });
                }

                function assignProperIcon(buttonId) {
                    if ($(`#${buttonId}`).attr('title') === 'Map') {
                        $(`#${buttonId}`).attr('src', 'assets/serviceDesigner/refresh.svg');
                    } else {
                        $(`#${buttonId}`).attr('src', 'assets/serviceDesigner/edit.svg');
                    }
                }

                /* Function takes ids and values to compoares. If condition statisfies then it toggle the fields*/
                function toggleFields(id1, id2, actualValue, valueToCompare, buttonId, buttonValue) {
                    if (valueToCompare == actualValue) {
                        $(`#${id1}`).addClass('display-none');
                        $(`#${id2}`).removeClass('display-none');
                        $(`#${buttonId}`).attr('title', buttonValue);
                    } else {
                        $(`#${id2}`).addClass('display-none');
                        $(`#${id1}`).removeClass('display-none');
                        $(`#${buttonId}`).attr('title', actualValue)
                    }					
                }

                /* Function to update the typedInput type and values*/
                function updateTypedInpuTypeAndValue(element, mappingObj, buttonId, id1, id2) {
                    element.typedInput('type', mappingObj['mapVarType']);
                    element.typedInput('value', mappingObj['mapVarValue']);
                    $(`#${buttonId}`).attr('title', 'Value')
                    assignProperIcon(buttonId);
                    $(`#${id1}`).addClass('display-none');
                    $(`#${id2}`).removeClass('display-none');
                }
                /* Validates the typed input and show/hide the error message*/
                function validateTypedInput(value, errorMsgId, buttonId) {
                    let isValueExists = false;
                    if ($(`#${buttonId}`).attr('title') == 'Value' || !buttonId) {
                        if (value) {
                            isValueExists = true;
                            $(`#${errorMsgId}`).addClass('display-none');
                        } else {
                            isValueExists = false;
                            $(`#${errorMsgId}`).removeClass('display-none');
                        }

                    } else {
                        $(`#${errorMsgId}`).addClass('display-none');
                        isValueExists = true
                    }

                    return isValueExists;

                }

                /* Called when there is change in the value of method typedInput */
                function validateMethod(value) {
                    const isMethodValid = validateTypedInput(value, 'invalid-method-mapping-error', 'node-input-method-button');
                    return isMethodValid;
                }

                /* Called when there is change in the value of url typedInput */
                function validateUrl(value) {
                    const isUrlValid = validateTypedInput(value, 'invalid-url-mapping-error', 'node-input-url-button');
                    return isUrlValid;
                }

                /* Called when there is change in the value of return type typedInput */
                function validateReturnType(value) {
                    const isReturnTypeValid = validateTypedInput(value, 'invalid-returntype-mapping-error', 'node-input-returntype-button');
                    return isReturnTypeValid;
                }

                /* Called when there is change in the value of result mapping typedInput */
                function validateResultMapping(value) {
                    const isResultMappingValid = validateTypedInput(value, 'invalid-resultmapping-mapping-error');
                    return isResultMappingValid;
                }

                /* Method */
                /* Creates the select to select the method*/
                const methodSelectEle = $('#node-input-method-select').selectField({
                    optionsData: httpMethods,
                    showError: true,
                    disableDoneIfInvalid: true,
                    validateOnCreate: true,
                    props: {
                        requirmethodTypedInputEleed: true
                    },
                    value: httpMethods[0].value
                })

                const methodTypedInputEle = $('#node-input-method-map').typedInput({
					noformvalidation: false,
                    types: [
                        { value: 'bh', label: 'bh.', validate: validateMethod },
                        { value: "bh.input", label: 'bh.input.', validate: validateMethod },
                        { value: "bh.local", label: 'bh.local.', validate: validateMethod }
                    ]
                });
                $('#node-input-method-button').on('click', function () {
                    let text = $('#node-input-method-button').attr('title');
                    toggleFields('node-input-method-select', 'node-input-method-map-container', 'Map', text, 'node-input-method-button', 'Value');
                    assignProperIcon('node-input-method-button');
					methodTypedInputEle.typedInput('validate');
					SRD.defaults.validateForm(true);
                });

                if (this.methodMappingObj && this.methodMappingObj.hasOwnProperty('mapVarType')) {
                    updateTypedInpuTypeAndValue(methodTypedInputEle, this.methodMappingObj, 'node-input-method-button', 'node-input-method-select', 'node-input-method-map-container');
                    $('#node-input-method-map-container').find('.red-ui-typedInput-input').removeClass('input-error')
                } else {
                    methodSelectEle.val(this.method ? this.method : 'get')
                }

                /* URL */
                /* Creates the select to select the method*/
                const urlInputFieldEle = $('#node-input-url').inputField({
                    wrapperAttr: {
                        "id": "node-input-url-container"
                    },
                    validatorRegexp: /[^\s]+/,
                    validateOnCreate: true,
                    errorText: 'Url Required',
                    errorClassList: 'http-node invalid-url-msg',
                    value: node.urlValue || '',
					noformvalidation: false,
                    inputClassList: "property-url",
                })

                const urlTypedInputEle = $('#node-input-url-map').typedInput({
					noformvalidation: false,
                    types: [
                        { value: 'bh', label: 'bh.', validate: validateUrl },
                        { value: "bh.input", label: 'bh.input.', validate: validateUrl },
                        { value: "bh.local", label: 'bh.local.', validate: validateUrl }
                    ]
                });
                $('#node-input-url-button').on('click', function () {
                    let text = $('#node-input-url-button').attr('title');
                    toggleFields('node-input-url-container', 'node-input-url-map-container', 'Map', text, 'node-input-url-button', 'Value');
                    assignProperIcon('node-input-url-button');
                    if ($('#node-input-url-button').attr('title') == 'Map') {
                        $('#invalid-url-mapping-error').addClass('display-none');
                        urlInputFieldEle.trigger('input');
                    } else {
                        urlTypedInputEle.typedInput('validate');
					}
					SRD.defaults.validateForm(true);
                });

                if (this.urlMappingObj && this.urlMappingObj.hasOwnProperty('mapVarType')) {
                    updateTypedInpuTypeAndValue(urlTypedInputEle, this.urlMappingObj, 'node-input-url-button', 'node-input-url-container', 'node-input-url-map-container');
                    $('#node-input-url-map-container').find('.red-ui-typedInput-input').removeClass('input-error')
                } else {
                    urlInputFieldEle.trigger('input');
                    urlInputFieldEle.blur();
                }

                /* Return Type */
                const returnTypeSelectEle = $('#node-input-returntype-select').selectField({
                    optionsData: responseTypes,
                    showError: true,
                    validateOnCreate: true,
                    props: {
                        required: true
                    },
                    value: 'json',
                });

                const returnTypeTypedInputEle = $('#node-input-returntype-map').typedInput({
					noformvalidation: false,
                    types: [
                        { value: "bh", label: 'bh.', validate: validateReturnType },
                        { value: "bh.input", label: 'bh.input.', validate: validateReturnType },
                        { value: "bh.local", label: 'bh.local.', validate: validateReturnType }
                    ]
                });
                $('#node-input-returntype-button').on('click', function () {
                    let text = $('#node-input-returntype-button').attr('title');
                    toggleFields('node-input-returntype-select', 'node-input-returntype-map-container', 'Map', text, 'node-input-returntype-button', 'Value');
					assignProperIcon('node-input-returntype-button');
					SRD.defaults.validateForm(true);
                });

                if (this.retMappingObj && this.retMappingObj.hasOwnProperty('mapVarType')) {
                    updateTypedInpuTypeAndValue(returnTypeTypedInputEle, this.retMappingObj, 'node-input-returntype-button', 'node-input-returntype-select', 'node-input-returntype-map-container');
                    $('#node-input-returntype-map-container').find('.red-ui-typedInput-input').removeClass('input-error')
                } else {
                    returnTypeSelectEle.val(this.ret ? this.ret : 'json')
                }

                /* Body */
                const body = $('#node-input-body-map').typedInput({ types: inputTypes });
                if (node.reqBodyObj && node.reqBodyObj.hasOwnProperty('mapVarType')) {
                    body.typedInput('type', node.reqBodyObj.mapVarType);
                    body.typedInput('value', node.reqBodyObj.mapVarValue);
                }

                /* Result Mapping */
                const resultMapping = $('#node-input-result-mapping-map').typedInput({
					noformvalidation: false,
                    types: [
                        { value: "bh", label: 'bh.', validate: validateResultMapping },
                        { value: "bh.input", label: 'bh.input.', validate: validateResultMapping },
                        { value: "bh.local", label: 'bh.local.', validate: validateResultMapping }
                    ]
                });
                if (node.resultMappingObj && node.resultMappingObj.hasOwnProperty('mapVarType')) {
                    resultMapping.typedInput('type', node.resultMappingObj.mapVarType);
                    resultMapping.typedInput('value', node.resultMappingObj.mapVarValue);
                    $('#node-input-result-mapping').find('.red-ui-typedInput-input').removeClass('input-error')
                }


                /* Headers TypedInput*/
                const headersTypedInputEle = $('#node-input-headers-map').typedInput({ types: inputTypes });
                $('.proxy-map-value-toggle-headers').click((eventObj) => {
                    let text = $('#node-input-headers-button').attr('title');
					toggleFields('headers-props-section', 'node-input-headers-map-container', 'Map', text, 'node-input-headers-button', 'Value');
					SRD.defaults.validateForm(true);
                });



                /* Params TypedInput*/
                const paramsTypedInputEle = $('#node-input-params-map').typedInput({ types: inputTypes });
                $('.proxy-map-value-toggle-params').click((eventObj) => {
                    let text = $('#node-input-params-button').attr('title');
					toggleFields('params-props-section', 'node-input-params-map-container', 'Map', text, 'node-input-params-button', 'Value');
					SRD.defaults.validateForm(true);
                });
                /* Add input and local properties section */
                decorateAndPopulatePropsSection('headers');
                decorateAndPopulatePropsSection('params');
                $('.add-prop-icon').addClass('add-prop-http-icon');
                $('.add-prop-text').addClass('add-prop-http-text');
                $('.add-prop-btn').addClass('add-button-http');

                /* Hide the properties list by default. It will be displayed whenever 'addItem' runs */
                $('#params-props-section .properties-container').hide();
                $('#headers-props-section .properties-container').hide();

                /* Populate editableList with the variables if already present */
                if (this.headerMappingObj && this.headerMappingObj.hasOwnProperty('mapVarType')) {
                    updateTypedInpuTypeAndValue(headersTypedInputEle, this.headerMappingObj, 'node-input-headers-button', 'headers-props-section', 'node-input-headers-map-container');
                    $('#node-input-result-mapping').find('.red-ui-typedInput-input').removeClass('input-error')

                } else {
                    populateExistingVariables('headers', this.headersObj);
                }

                if (this.paramMappingObj && this.paramMappingObj.hasOwnProperty('mapVarType')) {
                    updateTypedInpuTypeAndValue(paramsTypedInputEle, this.paramMappingObj, 'node-input-params-button', 'params-props-section', 'node-input-params-map-container');
                } else {
                    populateExistingVariables('params', this.paramsObj);
                }


                /* Reposition the "Add" button */
                $('.add-prop-btn-wrp').each(function (i, elem) {
                    $(elem).css('margin-left', '0.5em')
                        .insertBefore($('.add-section .map-button-wrp')[i]);
                });

                $('#dialog-form').attr('novalidate', 'novalidate');

                // Clicking 'Enter' on the map/value divs should mimic their respective 'click' behaviour.
                $('.map-button-wrp').on('keyup', (event) => {
                    if (event.key === 'Enter') {
                        $(event.target).find('img').click();
                    }
                });
            },
            oneditsave: function () {
                let node = this;
                function updateMappingValue(id, mapVar, mapVarObj) {
                    const mapVarType = $(`#${id}`).typedInput('type');
                    const mapVarValue = $(`#${id}`).typedInput('value');
                    if (mapVarValue) {
                        node[mapVar] = `${mapVarType}.${mapVarValue}`;
                    } else {
                        node[mapVar] = undefined;
                    }
                    node[mapVarObj].mapVarType = mapVarType;
                    node[mapVarObj].mapVarValue = mapVarValue;
                }

                /* Method*/
                if ($('#node-input-method-button').attr('title') == 'Map') {
                    this.method = $('#node-input-method-select').val();
                    this.methodMapping = undefined;
                    this.methodMappingObj = {};
                } else {
                    this.method = undefined;
                    updateMappingValue('node-input-method-map', 'methodMapping', 'methodMappingObj');
                }



                /* Url*/
                if ($('#node-input-url-button').attr('title') == 'Map') {
                    this.urlValue = $('#node-input-url').val();
                    this.urlMapping = undefined;
                    this.urlMappingObj = {};
                } else {
                    this.urlValue = undefined;
                    updateMappingValue('node-input-url-map', 'urlMapping', 'urlMappingObj');
                }

                /* ReturnType */
                if ($('#node-input-returntype-button').attr('title') == 'Map') {
                    this.ret = $('#node-input-returntype-select').val();
                    this.retMapping = undefined;
                    this.retMappingObj = {};
                } else {
                    this.ret = undefined;
                    updateMappingValue('node-input-returntype-map', 'retMapping', 'retMappingObj');
                }

                /* Body */
                updateMappingValue('node-input-body-map', 'reqBody', 'reqBodyObj');

                /* Result Mapping */
                updateMappingValue('node-input-result-mapping-map', 'resultMapping', 'resultMappingObj');

                /* Headers */
                if ($('#node-input-headers-button').attr('title') == 'Map') {
                    const headersForCodeGen = {};
                    const headersArr = [];
                    const headersObjArr = [];
                    for (const header of this.tempVarStore.headersVariables) {
                        const key = header.key;
                        const value = header.defaultValue;
                        headersForCodeGen[key] = value;
                        headersObjArr.push({ key: key, defaultValue: value });
                    }
                    this.headers = headersForCodeGen;
                    this.headersObj = headersObjArr;
                    this.headerMapping = undefined;
                    this.headerMappingObj = {};


                } else {
                    updateMappingValue('node-input-headers-map', 'headerMapping', 'headerMappingObj');
                    this.headers = undefined;
                    this.headersObj = undefined;
                }

                /* Params */
                if ($('#node-input-params-button').attr('title') == 'Map') {
                    const paramsArr = [];
                    const paramsObjArr = [];
                    const paramsForCodeGen = {};
                    for (const param of this.tempVarStore.paramsVariables) {
                        const key = param.key;
                        const value = param.defaultValue;
                        paramsForCodeGen[key] = value;
                        paramsObjArr.push({ key: key, defaultValue: value });
                    }
                    this.params = paramsForCodeGen;
                    this.paramsObj = paramsObjArr;
                    this.paramMapping = undefined;
                    this.paramMappingObj = {};

                } else {
                    updateMappingValue('node-input-params-map', 'paramMapping', 'paramMappingObj');
                    this.params = undefined;
                    this.paramsObj = undefined;
                }
                delete this.tempVarStore;
            },
            oneditcancel: function () {
                delete this.tempVarStore;
            },
            oneditresize: function (size) {
                $('.properties-container .wide-header').width($('.properties-container .field-wrapper').width()).css({
                    'margin-left': '1em'
                });
            },
            docsLink: 'http-request-node'
        }
    });
</script>