<script type="text/x-red" data-template-name="Environment">
<div id="env-props-section-container" class="editor-form-row">
        <label for="env-props-section"><span data-i18n="environment.label.map-title"></span></label>
        <div id="env-props-section" class="props-section">
            <div class="add-section">
                <div class="srd-editableList-add-kv-wrp" style="display:block">
                    <input type="text" class="property-key">
                    <select id="env-node-select"></select>
                </div>
                <button title="Get Latest Env Properties" type="button" class="map-button-wrp" id="get-env-properties">
                    <image class="map-button" src="assets/serviceDesigner/fetch.svg"></image>
                </button>
            </div>
            <div class="properties-container">
                <div class="properties-header-container">
                    <div class="editableList-header" style="left: 2%;">No.</div>
                    <div class="editableList-header" style="left: 9%;">Flow Variable</div>
                    <div class="editableList-header" style="left: 51%;">Env Property</div>
                </div>
                <ol id="env-properties-content"></ol>
            </div>
        </div>
    </div>
</script>



<script type="text/javascript">
    registerNode({
        nodeType: 'Environment',
        serviceType: 'client',
        nodeDef: {
            color: "#2c98ac",
            category: 'General',
            defaults: {
                name: { value: "" },
                outputs: { value: 1 },
                envMaps: { value: [] }
            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-all-nodes/environment-node.svg",
            label: function () {
                return this.name || 'Environment'
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function (SRD) {
                let node = this;
                node.envMapsList = [];
                const keyTypes = [
                    { value: 'bh', label: 'bh.', validate: SRD.validators.typedInput('bh', true) },
                    { value: 'bh.input', label: 'bh.input.', validate: SRD.validators.typedInput('bh.input', true) },
                    { value: 'bh.local', label: 'bh.local.', validate: SRD.validators.typedInput('bh.local', true) }
                ];
                const doneBtn = $('#node-dialog-ok');
                let flowVarField = $(`#env-props-section .property-key`).typedInput({
                    types: keyTypes
                });
                let envPropertyField = $(`#env-node-select`).selectField({
                    placeholder: 'Select Env Property',
                    optionsData: []
                });

                let envMapsListContainer = $(`#env-props-section .properties-container`);

                function updateRowPropertyById(prop, val, currentRowId) {
                    const index = (node.envMapsList).findIndex((row) => currentRowId === row['rowId']);
                    node.envMapsList[index][prop] = val;
                    return index;
                }

                function validateEditableList() {
                    SRD.validators.editableList(envMapsListContainer, envMapsList, {
                        checkValidityOn: node.envMapsList
                    });
                }
                let envProperties = [];
                function updateEnvPropertyOptions() {
                    SRD.environmentService.getEnvironmentMetadata(SRD.appName).subscribe(res => {
                        const types = res['data'].TYPE.properties;
                        envProperties = Object.keys(types).filter(p => types[p] === 'client' || types[p] === 'both').map(prop => ({ value: prop, displayValue: prop }));
                        envPropertyField.selectField('updateOptions', envProperties, true, true);
                        $('.list-env-properties').each(function () {
                            $(this).selectField('updateOptions', envProperties, true, true);
                        });
                    });
                }

                let envMapsList = $(`#env-properties-content`).data({ valid: true, isUnique: true, isValid: true });
                envMapsList.editableList({
                    addItem: function (envMapRow, i, data) {
                        let rowData = data.rowData || { flowVar: {} };
                        let dataObj = {
                            flowVar: {
                                type: rowData.flowVar.type || flowVarField.typedInput('type'),
                                value: rowData.flowVar.value || flowVarField.typedInput('value')
                            },
                            envProperty: rowData.envProperty || envPropertyField.val(),
                            rowId: rowData.rowId || SRD.nodes.id(),
                            valid: true
                        };
                        node.envMapsList.push(dataObj);
                        envMapRow.attr('id', dataObj.rowId).css('align-items', 'center').data('data', { rowData: dataObj });

                        function updateRowData(property, value) {
                            let index = updateRowPropertyById(property, value, envMapRow.data('data').rowData.rowId);
                            node.envMapsList[index].valid = envMapVar.typedInput('valid');
                            envMapRow.data('data', { rowData: node.envMapsList[index] });
                        }
                        function changeHandler(evt) {
                            if (envMapVar.data('srdTypedInput')) {
                                const val = {
                                    type: envMapVar.typedInput('type'),
                                    value: envMapVar.typedInput('value'),
                                };
								updateRowData('flowVar', val);
								validateEditableList();
                            }
                        }
                        let v = Object.assign({}, dataObj.flowVar);
                        let envMapVar = $(`<input type="text"/>`).appendTo(envMapRow)
                        envMapVar.typedInput({
                            types: keyTypes,
							default: v.type,
							noformvalidation: false,
                            onvalchanged: changeHandler,
                            change: changeHandler
                        }).typedInput('value', v.value);

                        let envProperty = $(`<select type="text" class="list-env-properties"/>`).appendTo(envMapRow).selectField({
                            optionsData: envProperties,
                            value: dataObj.envProperty || envPropertyField.selectField('selected'),
                            change: function (val) {
                                updateRowData('envProperty', val);
                            }
                        });
                        envMapsListContainer.show();
                        flowVarField.typedInput('value', '');
                    },
                    removable: true,
                    scrollOnAdd: true,
                    removeItem: function (data) {
                        node.envMapsList = node.envMapsList.filter(vObj => vObj['rowId'] !== data.rowData.rowId);
						validateEditableList();
						SRD.defaults.validateForm(true);
                        if (node.envMapsList.length === 0) {
                            envMapsListContainer.hide();
                        }
                    },
                    showAddBtnLabel: false,
                    validator: function () {
                        if (!flowVarField.typedInput('validate')) {
                            SRD.dialogService.openSnackBar('Invalid Value for the Type Selected');
                            return false;
                        }
                        if (envPropertyField.selectField('selected', true).displayValue === envPropertyField.selectField('option', 'placeholder')) {
                            SRD.dialogService.openSnackBar('Select an Environment Property');
                            return false;
                        }
                        return true;
                    }
                });
                $('#env-props-section .properties-container').hide();
                const getEnvProps = $('#get-env-properties').on('click', () => {
                    updateEnvPropertyOptions();
                });
                $('.add-prop-btn-wrp').css({ 'margin-right': '0.5em' }).insertBefore(getEnvProps);
                if (node.envMaps && node.envMaps instanceof Array) {
                    node.envMaps.forEach(row => envMapsList.editableList('addItem', { rowData: row, validator: false }));
                }
                updateEnvPropertyOptions();
            },
            oneditsave: function () {
                const node = this;
                node.envMaps = node.envMapsList.map(x => ({ flowVar: x.flowVar, envProperty: x.envProperty }));
                delete node.envMapsList;
            },
            oneditcancel: function () {
                delete this.envMapsList;
            },
            docsLink: 'environments-node'
        }
    });
</script>
<script type="text/x-red" data-help-name="Environment">
</script>