<script type="text/x-red" data-template-name="SnackBar">
<!-- SnackBar Message -->
<div class="editor-form-row">
    <label for="snackbar-node-typedIp-message"><span data-i18n="snackbar.label.message"></span></label>
    <input type="text" style="width:100%;" class="snackbar-config-field-typedIp" id="snackbar-node-typedIp-message">
</div>
<!-- Action -->
<div class="editor-form-row">
    <label for="snackbar-node-typedIp-action"><span data-i18n="snackbar.label.action"></span></label>
    <input type="text" style="width:100%;" class="snackbar-config-field-typedIp" id="snackbar-node-typedIp-action">
</div>
<!-- Configs -->
<div class="editor-form-row">
    <label for="snackbar-node-typedIp-duration"><span data-i18n="snackbar.label.duration"></span></label>
    <input type="text" style="width:100%;" class="snackbar-config-field-typedIp" id="snackbar-node-typedIp-duration">
</div>

<div class="editor-form-row">
    <label for="snackbar-node-horizontalPosition"><span data-i18n="snackbar.label.horizontalPosition"></span></label>
    <div style="display: flex">
        <div class='flex-row' style="width: 100%;justify-content: space-between;">
            <div style="width: 77%;">
                <select type="text" class="snackbar-config-field-select" id="snackbar-node-horizontalPosition"></select>
                <input type="text" class="snackbar-config-field-typedIp" id="snackbar-node-typedIp-horizontalPositionMap">
            </div>
            <input id="snackbar-node-direction">
        </div>
        <button type="button" class="map-button-wrp">
            <image id="snackbar-map-button-hPos" class="map-button" title="Map" src="assets/serviceDesigner/refresh.svg"></image>
        </button>
    </div>
</div>

<div class="editor-form-row">
    <label for="snackbar-node-verticalPosition"><span data-i18n="snackbar.label.verticalPosition"></span></label>
    <div style="display: flex">
        <div style="width:95%;">
            <select type="text" class="snackbar-config-field-select" id="snackbar-node-verticalPosition"></select>
            <input type="text" class="snackbar-config-field-typedIp" id="snackbar-node-typedIp-verticalPositionMap">
        </div>
        <button type="button" class="map-button-wrp">
            <image id="snackbar-map-button-vPos" class="map-button" title="Map" src="assets/serviceDesigner/refresh.svg"></image>
        </button>
    </div>
</div>

<div class="editor-form-row">
    <label for="snackbar-node-typedIp-panelClass"><span data-i18n="snackbar.label.panelClass"></span></label>
    <input type="text" class="snackbar-config-field-typedIp" id="snackbar-node-typedIp-panelClass">
</div>

</script>

<script type="text/javascript">

    registerNode({
        nodeType: 'SnackBar',
        serviceType: 'client',
        nodeDef: {
            color: "#BA0029",
            category: 'General',
            defaults: {
                name: { value: '' },
                message: { value: { type: 'str', value: '' } },
                action: { value: { type: 'str', value: '' } },
                duration: { value: { type: 'num', value: '' } },
                horizontalPosition: { value: 'center' },
                horizontalPositionMap: { value: '' },
                verticalPosition: { value: 'bottom' },
                verticalPositionMap: { value: '' },
                panelClass: { value: { type: 'str', value: '' } },
                direction: { value: 'ltr' }
            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-all-nodes/snackbar-node.svg",
            paletteLabel: function (def) { return 'Snackbar'; },
            label: function () {
                return this.name || 'Snackbar'
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function (SRD) {
                const node = this;
                const doneBtn = $('button#node-dialog-ok');
                const bhTypes = [
                    { value: 'bh', label: 'bh.', validate: SRD.validators.typedInput('bh') },
                    { value: "bh.input", label: 'bh.input.', validate: SRD.validators.typedInput('bh.input') },
                    { value: "bh.local", label: 'bh.local.', validate: SRD.validators.typedInput('bh.input') }
                ]
                const types = {
                    duration: [...bhTypes, { value: "num", label: 'number', validate: v => !isNaN(v) }],
                    panelClass: [...bhTypes, { value: "str", label: 'string' }],
                    message: [...bhTypes, { value: "str", label: 'string' }],
                    action: [...bhTypes, { value: "str", label: 'string' }],
                    horizontalPositionMap: bhTypes,
                    verticalPositionMap: bhTypes
                }
                const defaults = {
                    duration: node.duration.type || 'num',
                    panelClass: node.panelClass.type || 'str',
                    message: node.message.type || 'str',
                    action: node.action.type || 'str',
                    horizontalPositionMap: node.horizontalPositionMap ? node.horizontalPositionMap.type : 'bh',
                    verticalPositionMap: node.verticalPositionMap ? node.verticalPositionMap.type : 'bh'
                }
                const options = {
                    verticalPosition: [
                        { value: 'top', displayValue: 'Top' },
                        { value: 'bottom', displayValue: 'bottom' }
                    ],
                    horizontalPosition: [
                        { value: 'start', displayValue: 'Start' },
                        { value: 'center', displayValue: 'Center' },
                        { value: 'end', displayValue: 'End' },
                        { value: 'left', displayValue: 'Left' },
                        { value: 'right', displayValue: 'Right' },
                    ]
                }

                function validateForm() {
					SRD.defaults.validateForm(true);
                }

                $('#snackbar-node-direction').toggleButton({
                    label: "Left To Right",
                    states: {
                        on: 'ltr',
                        off: 'rtl'
                    },
                    state: node.direction
                })

                $('.snackbar-config-field-typedIp').each(function (i, elm) {
                    const jqElm = $(elm).css({ 'width': '100%' });
                    const field = jqElm.attr('id').replace('snackbar-node-typedIp-', '');
                    const value = node[field] ? node[field].value : "";
                    jqElm.typedInput({
                        types: types[field],
                        noErrorElement: false,
                        default: defaults[field],
						onvalchanged: validateForm,
						noformvalidation: false,
                        change: validateForm
                    }).typedInput('value', value);
                });
                $('.snackbar-config-field-select').each(function (i, elm) {
                    const jqElm = $(elm).css({ 'width': '100%', 'height': '29px' })
                    const field = jqElm.attr('id').replace('snackbar-node-', '');
                    jqElm.selectField({
                        optionsData: options[field],
                        value: node[field]
                    });
                });

                const fields = {
                    text: {
                        vPos: $('#snackbar-node-verticalPosition'),
                        hPos: $('#snackbar-node-horizontalPosition')
                    },
                    typedIp: {
                        vPos: $('#snackbar-node-typedIp-verticalPositionMap'),
                        hPos: $('#snackbar-node-typedIp-horizontalPositionMap')
                    }
                }

                function switchToMap(button, fieldElm) {
                    fields.text[fieldElm].hide();
                    fields.typedIp[fieldElm].typedInput('show');
                    button.attr('title', 'Value');
                    button.attr('src', 'assets/serviceDesigner/edit.svg');
                    validateForm();
                }
                function switchToValue(button, fieldElm) {
                    fields.text[fieldElm].show();
                    fields.typedIp[fieldElm].typedInput('hide');
                    button.attr('title', 'Map');
                    button.attr('src', 'assets/serviceDesigner/refresh.svg');
                    validateForm();
                }
                $('.map-button').click(function (evt) {
                    const elm = $(this);
                    const switchTo = elm.attr('title');
                    const fieldElm = elm.attr('id').replace('snackbar-map-button-', '');
                    if (switchTo === 'Map') {
                        switchToMap(elm, fieldElm);
                    } else {
                        switchToValue(elm, fieldElm);
                    }
                });

                if (node.horizontalPositionMap) {
                    switchToMap($('#snackbar-map-button-hPos'), 'hPos');
                } else {
                    switchToValue($('#snackbar-map-button-hPos'), 'hPos')
                }

                if (node.verticalPositionMap) {
                    switchToMap($('#snackbar-map-button-vPos'), 'vPos');
                } else {
                    switchToValue($('#snackbar-map-button-vPos'), 'vPos');
                }
            },
            oneditsave: function () {
                const node = this;
                function typedIpEVal(elem) {
                    val = elem.typedInput('value').trim();
                    return ({
                        type: elem.typedInput('type'),
                        value: val
                    });
                }

                node.message = typedIpEVal($('#snackbar-node-typedIp-message'));
                node.action = typedIpEVal($('#snackbar-node-typedIp-action'));
                node.duration = typedIpEVal($('#snackbar-node-typedIp-duration'));

                if ($('#snackbar-map-button-vPos').attr('title') === 'Map') {
                    node.verticalPosition = $('#snackbar-node-verticalPosition').selectField('selected');
                    delete node.verticalPositionMap
                } else {
                    node.verticalPositionMap = typedIpEVal($('#snackbar-node-typedIp-verticalPositionMap'));
                    delete node.verticalPosition;
                }
                if ($('#snackbar-map-button-hPos').attr('title') === 'Map') {
                    node.horizontalPosition = $('#snackbar-node-horizontalPosition').selectField('selected');
                    delete node.horizontalPositionMap;
                } else {
                    node.horizontalPositionMap = typedIpEVal($('#snackbar-node-typedIp-horizontalPositionMap'));
                    delete node.horizontalPosition;
                }

                node.panelClass = typedIpEVal($('#snackbar-node-typedIp-panelClass'));
                node.direction = $('#snackbar-node-direction').toggleButton('state');

            },
            docsLink: 'snackbar-node'
        }
    });
</script>