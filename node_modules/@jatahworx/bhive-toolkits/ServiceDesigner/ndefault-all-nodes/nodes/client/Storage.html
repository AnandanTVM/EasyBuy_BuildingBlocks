<script type="text/x-red" data-template-name="Storage">
<!-- Type of operation -->
<div class="editor-form-row">
    <label for="node-select-storge-operation"><span data-i18n="common.label.operation-type"></span></label>
    <select id="node-select-storge-operation" style="width: 100%;"></select>
</div>

<!-- Type of client storage -->
<div class="editor-form-row">
    <label for="node-select-storge-type"><span data-i18n="storage.label.storage-type"></span></label>
    <select id="node-select-storge-type" style="width: 100%;"></select>
</div>

<!-- key -->
<div id="node-input-storage-key-wrp" class="editor-form-row">
    <label for="node-input-storage-key"><span data-i18n="common.label.key"></span></label>
    <input type="text" id="node-input-storage-key" class="node-input-property" style="width: 100%">
</div>
<!-- value-->
<div id="node-input-storage-value-wrp" class="editor-form-row">
    <label for="node-input-storage-value"><span data-i18n="common.label.value"></span></label>
    <input type="text" id="node-input-storage-value" class="node-input-property" style="width: 100%">
</div>
<!-- resultMapping -->
<div id="node-input-result-mapping-wrp" class="editor-form-row">
    <label for="node-input-result-mapping"><span data-i18n="common.label.result-mapping"></span></label>
    <input type="text" id="node-input-result-mapping" class="node-input-property" style="width: 100%" />
</div>
</script>



<script type="text/javascript">
    registerNode({
        nodeType: 'Storage',
        serviceType: 'client',
        nodeDef: {
            color: "#A64942",
            category: 'Storage',
            defaults: {
                name: { value: '' },
                operationType: { value: 'setItem' },
                storageType: { value: 'localStorage' },
                outputs: { value: 1 },
                key: { value: '', required: true },
                value: { value: { type: 'bh', value: '' } },
                resultMapping: { value: { type: 'bh', value: '' } }
            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-all-nodes/storage-node.svg",
            paletteLabel: function (def) { return 'Storage'; },
            label: function () {
                return this.name || 'Storage'
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function (SRD) {
                const node = this;
                const doneBtn = $('#node-dialog-ok');
                const commonTypes = [
                    { value: 'bh', label: 'bh.', validate: SRD.validators.typedInput('bh', true) },
                    { value: 'bh.input', label: 'bh.input.', validate: SRD.validators.typedInput('bh.input', true) },
                    { value: 'bh.local', label: 'bh.local.', validate: SRD.validators.typedInput('bh.local', true) },
                ]
                const storages = [
                    { value: 'localStorage', displayValue: 'Local Storage' },
                    { value: 'sessionStorage', displayValue: 'Session Storage' }
                ]
                const kvSpecificTypes = [
                    { value: 'str', label: 'string', validate: SRD.validators.typedInput('str', true) }
                ]
                function validateForm() {
					SRD.defaults.validateForm(true);
                }

                /* Select the type of operation. */
                const operationType = $('#node-select-storge-operation').selectField({
                    optionsData: [
                        { value: 'getItem', displayValue: 'Get Item' },
                        { value: 'setItem', displayValue: 'Set Item' },
                        { value: 'removeItem', displayValue: 'Remove Item' },
                        { value: 'clear', displayValue: 'Clear Storage' }
                    ],
                    value: node.operationType,
                    change: (val) => {
                        if (val === 'getItem') {
                            $('#node-input-result-mapping-wrp').show();
                            $('#node-input-storage-key-wrp').show();
                            $('#node-input-storage-value-wrp').hide();
                            storageType.selectField('updateOptions', storages, true, true);
                        } else {
                            storageType.selectField('updateOptions', [
                                ...storages,
                                { value: 'all', displayValue: 'Local and Session Storage' }
                            ], true, true);
                            $('#node-input-result-mapping-wrp').hide();

                            if (val === 'setItem') {
                                $('#node-input-storage-value-wrp').show();
                                $('#node-input-storage-key-wrp').show();
                            }
                            if (val === 'clear') {
                                $('#node-input-storage-value-wrp').hide();
                                $('#node-input-storage-key-wrp').hide();
                            } else if (val === 'removeItem') {
                                $('#node-input-storage-value-wrp').hide();
                                $('#node-input-storage-key-wrp').show();
                            }
                        }
                        validateForm();
                    }
                });

                /* Select the type of client-side browser storage. */
                var storageType = $('#node-select-storge-type').selectField({
                    optionsData: [
                        ...storages,
                        { value: 'all', displayValue: 'Local and Session Storage' }
                    ],
                    value: node.storageType
                });

                /* Key of the store object (can be value or map). */
                const key = $('#node-input-storage-key').typedInput({
                    types: [ ...commonTypes, ...kvSpecificTypes ],
					noformvalidation: false,
                });

                /* Value field */
                const value = $('#node-input-storage-value').typedInput({
                    types: [
                        { value: 'bh', label: 'bh.', validate: SRD.validators.typedInput('bh') },
                        { value: 'bh.input', label: 'bh.input.', validate: SRD.validators.typedInput('bh.input') },
                        { value: 'bh.local', label: 'bh.local.', validate: SRD.validators.typedInput('bh.local') },
                        ...kvSpecificTypes
                    ],
					noformvalidation: false,
                });

                /* Result Mapping field */
                const resultMapping = $('#node-input-result-mapping').typedInput({
                    types: commonTypes,
					noformvalidation: false,
                });

                operationType.selectField('change', node.operationType);

                /* Set values for key and value fields if already exists */
                if (node.key.value) {
                    key.typedInput('type', node.key.type);
                    key.typedInput('value', node.key.value);
                }
                if (node.value.value) {
                    value.typedInput('type', node.value.type);
                    value.typedInput('value', node.value.value);
                }
                if (node.resultMapping.value) {
                    resultMapping.typedInput('type', node.resultMapping.type);
                    resultMapping.typedInput('value', node.resultMapping.value);
                }

                /* Validate on input event for each of the typedInut */
                $('.red-ui-typedInput-input input').on('input', (event) => {
                    validateForm();
                });
            },
            oneditsave: function () {
                const node = this;
                const resMap = $('#node-input-result-mapping');
                const key = $('#node-input-storage-key');
                const value = $('#node-input-storage-value');
                /* node property assignments */
                node.operationType = $('#node-select-storge-operation').val();
                node.storageType = $('#node-select-storge-type').val();

                if (node.operationType === 'getItem') {
                    node.value = {};
                    node.resultMapping = { type: resMap.typedInput('type'), value: resMap.typedInput('value') };
                    node.key = { type: key.typedInput('type'), value: key.typedInput('value').trim() };
                } else if (node.operationType === 'setItem') {
                    node.resultMapping = {};
                    node.key = { type: key.typedInput('type'), value: key.typedInput('value').trim() };
                    node.value = { type: value.typedInput('type'), value: value.typedInput('value') };
                } else if (node.operationType === 'removeItem') {
                    node.value = node.resultMapping = {};
                    node.key = { type: key.typedInput('type'), value: key.typedInput('value').trim() };
                } else if (node.operationType === 'clear') {
                    node.value = {};
                    node.resultMapping = {};
                    node.key = {};
                }
            },
            docsLink: 'storage-node'
        }
    });
</script>