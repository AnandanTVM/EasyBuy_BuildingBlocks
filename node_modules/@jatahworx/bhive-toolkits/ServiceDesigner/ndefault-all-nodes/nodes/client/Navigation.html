<script type="text/x-red" data-template-name="Navigation">
<!-- Paths List -->
<div class="editor-form-row">
    <div for="node-paths" class="editor-form-row-label">
        <span data-i18n="navigation.label.paths"></span>
    </div>
    <div id="node-paths" class="editor-form-row">
        <div id="path-select-wrp">
            <select id="node-select-paths"></select>
            <button type="button" title="Get Latest Routes" class="map-button-wrp">
                <image id="get-latest-routes" class="map-button" src="assets/serviceDesigner/fetch.svg"></image>
            </button>
        </div>
        <div class="field-wrapper-typedInput" id="path-map-wrp">
            <input type="text" id="path-map" class="node-input-property typed-input-width" style="width: 100%; margin: 0em;"/>
        </div>
        <button type="button" class="map-button-wrp">
            <image id="paths-map-button" class="map-button nav-path-to-navigate-edit-icon" title="Map" src="assets/serviceDesigner/refresh.svg"></image>
        </button>
    </div>
</div>
<!-- Path Params -->
<div id="path-params-props-section-container" class="editor-form-row">
    <div class="editor-form-row-label display-flex">
        <span data-i18n="common.label.pathparams-title" style="flex: 1;"></span>
        <button type="button" class="map-button-wrp ">
            <image id="path-params-map-button" class="map-button" title="Map" src="assets/serviceDesigner/refresh.svg" class="vertical-align-top"/>
        </button>
    </div>
    <div id="path-params-section" class="props-section editor-form-row margin-bottom-1">
        <div class="properties-container">
            <ol id="path-params-content"></ol>
        </div>
    </div>
    <div class="field-wrapper-typedInput" id="path-params-map-wrp">
        <input type="text" id="path-params-map" class="node-input-property typed-input-width" style="width: 100%; margin: 0em;"/>
    </div>
</div>

<!-- Query Prams -->
<div id="qparams-props-section-container" class="editor-form-row-margin-bottom-0">
    <div class="display-flex">
        <div class="editor-form-row-label">
            <span data-i18n="common.label.params-title"></span>
        </div>
        <image style="display:none !important;" id="params-button-hidden" title="Map" />
        </image>
    </div>
    <div class="editor-form-row http-element-container field-wrapper-typedInput" id="params-map-wrp" style="width: 100%; margin-top: 1.5em;">
        <input type="text" id="params-map" class="node-input-property typed-input-width" style="width: 100%; margin: 0em;"/>
        <button type="button" class="map-button-wrp height-100" style="margin-top: 0.75em;">
            <image class="map-button proxy-map-value-toggle-params" title="Value" src="assets/serviceDesigner/edit.svg" style="margin-bottom: 0.75em;"></image>
        </button>
    </div>
    <div id="qparams-props-section" class="props-section">
        <div class="add-section params-section">
            <div class="srd-editableList-add-kv-wrp">
                <input type="text" class="property-key">
                <input type="text" class="property-value">
            </div>
            <button type="button" class="map-button-wrp nav-query-params-edit margin-left-0">
                <image class="map-button proxy-map-value-toggle-params" title="Map" src="assets/serviceDesigner/refresh.svg">
                </image>
            </button>
        </div>
        <div class="properties-container" validatesform="true">
            <ol id="qparams-properties-content"></ol>
        </div>
        <span class="list-keys-invalid">{{Editable List Invalid Message}}</span>
    </div>
</div>

<!-- Result Mapping -->
<div class="editor-form-row">
    <div class="editor-form-row-label">
        <span data-i18n="common.label.result-mapping"></span>
    </div>
    <div class="form-row http-element-container field-wrapper-typedInput" id="navigation-result-mapping-map-wrp"
        style="margin-top: 0.75em;width: 100% !important;">
        <input type="text" id="navigation-result-mapping-map" class="node-input-property typed-input-width" style="width: 100% !important" />
    </div>
</script>

<script type="text/javascript">

    function switchToMapping(mapBtn) {
        return mapBtn.attr('title') === 'Value';
    }

    registerNode({
        nodeType: 'Navigation',
        serviceType: 'client',
        nodeDef: {
            color: "#6b778d",
            category: 'General',
            defaults: {
                name: { value: '' },
                /* captures path */
                path: { value: '' },
                pathMap: { value: '' },
                /* captures pathparms */
                pathparams: { value: '' },
                pathparamsMap: { value: '' },
                /* captures query params */
                qparams: { value: '' },
                qparamsMap: { value: '' },
                qparamsArray: { value: '' },
                /* captures rult mapping */
                resultMapping: { value: '' }
            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-all-nodes/navigation-node.svg",
            paletteLabel: function (def) { return 'Navigation'; },
            label: function () {
                return this.name || 'Navigation'
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function (SRD) {
                const node = this;
                const editor = $('form#dialog-form');
                let editPrepareComplete = false;
                function computeAppPathsAndParams(routesConfigObj, parentPath, pathsArr = []) {
                    routesConfigObj.forEach((v) => {
                        const path = parentPath + (v.path === '""' || v.path === '\'\'' ? '/' : '/' + v.path);
                        const matchedParams = (path + '/').match(/(?<=\/\:)[^\/\:]+(?=(\/ |))/g);
                        const pathparams = matchedParams !== null ? matchedParams : [];
                        if (v.children && v.children.length) {
                            computeAppPathsAndParams(v.children, path, pathsArr);
                        } else {
                            pathsArr.push({
                                path: path,
                                pathparams: pathparams
                            });
                        }
                    });
                    return pathsArr;
                }

                function getAllParamsArray(computedPaths) {
                    const allParamsArray = [];
                    computedPaths.forEach(pathAndParams => {
                        pathAndParams.pathparams.forEach(v => {
                            allParamsArray.push({
                                path: pathAndParams.path,
                                paramKey: v,
                                paramValue: {
                                    type: '',
                                    value: ''
                                }
                            });
                        });
                    });
                    return allParamsArray;
                }
                const srcs = {
                    Map: 'assets/serviceDesigner/refresh.svg',
                    Value: 'assets/serviceDesigner/edit.svg'
                }
                let allPaths = computeAppPathsAndParams(SRD.appRoutes, '');
                let computedPaths = [allPaths[allPaths.length - 2], ...allPaths.slice(0, -2)];
                node.allParamsArray = getAllParamsArray(computedPaths);

                const getRoutesBtn = $('#get-latest-routes').click((e) => {
                    /* Store current values in a temp array */
                    const oldParamsArray = JSON.parse(JSON.stringify(node.allParamsArray));
                    const oldPaths = oldParamsArray.map(v => v.path);

                    /* Compute the latest paths and populate allParamsArray based on computedPaths */
                    let allPaths = computeAppPathsAndParams(SRD.appRoutes, '');
                    computedPaths = [allPaths[allPaths.length - 2], ...allPaths.slice(0, -2)];
                    node.allParamsArray = getAllParamsArray(computedPaths);

                    /* Copy the paramValue for matching paths */
                    node.allParamsArray.forEach((pathAndParams, i) => {
                        const index = oldPaths.findIndex(path => path === pathAndParams.path);
                        if (index > -1 && node.allParamsArray[i].paramKey === oldParamsArray[index].paramKey) {
                            node.allParamsArray[i].paramValue = oldParamsArray[index].paramValue;
                            oldPaths[index] = 0;
                        }
                    });

                    pathsDropDown.selectField('updateOptions', computedPaths.map((v) => ({ displayValue: v.path, value: JSON.stringify(v.path) })), true, true);
                    pathsDropDown.selectField('change', pathsDropDown.find('option:selected').val());
                });
                const types = [
                    { value: 'bh', label: 'bh.', validate: /^[^\s]+$/ },
                    { value: 'bh.input', label: 'bh.input.', validate: /^[^\s]+$/ },
                    { value: 'bh.local', label: 'bh.local.', validate: /^[^\s]+$/ }
                ]

                const qparams = $('#qparams-properties-content');

                function validateForm() {
                    if(editPrepareComplete) {
					    SRD.defaults.validateForm(true);
                    }
                }
                /* Path */
                var pathsDropDown = $('#node-select-paths').selectField({
                    optionsData: computedPaths.map((v) => ({ displayValue: v.path, value: JSON.stringify(v.path) })),
                    change: (val) => {
                        pathParamsList.find('li').remove();

                        const pathParamsSection = $('#path-params-section');
                        node.allParamsArray.filter(v => v.path === val).forEach(v => {
                            pathParamsList.editableList('addItem', v);
                        });
                        if (!pathParamsList.editableList('items').length) {
                            $('#path-params-props-section-container').hide();
                        } else {
                            $('#path-params-props-section-container').show();
                            if (!switchToMapping($('#path-params-map-button'))) {
                                $('#path-params-section').show();
                                $('#path-params-map-wrp').hide();
                            } else {
                                $('#path-params-section').hide();
                                $('#path-params-map-wrp').show();
                            }
                        }
                    }
                });
                const pathMap = $('#path-map').typedInput({
                    types: [
                        { value: 'bh', label: 'bh.', validate: SRD.validators.typedInput('bh.input', true) },
                        { value: 'bh.input', label: 'bh.input.', validate: SRD.validators.typedInput('bh.input', true) },
                        { value: 'bh.local', label: 'bh.local.', validate: SRD.validators.typedInput('bh.input', true) },
                        { value: 'str', label: 'string', validate: SRD.validators.typedInput('str', true) }
                    ],
					default: 'bh',
					noformvalidation: false
                });

                /* Path params */
                var pathParamsList = $('#path-params-content').editableList({
                    addItem: function (container, i, data) {

                        /* property list's "key" field */
                        data = data || {};
                        let listKey = $(`<input type="text" class="node-params-key"/>`).appendTo(container).inputField({
                            wrapperAttr: { style: 'width: 15%; margin-right: 5%;' },
                            attrs: {
                                "maxlength": "60"
                            },
                            props: {
                                "readonly": true
                            },
                            inputClassList: "property-key",
                            value: data.paramKey || ''
                        });

                        /* property list's "defaultValue" field */
							let listVal = $(`
						<div class="field-wrapper-typedInput" style="margin-top: 0.70em;">
							<input type="text" class="node-input-property typed-input-width" style="width: 95% !important;" />
						</div>
						`).appendTo(container);

                        const index = node.allParamsArray.findIndex(v => v.paramKey === data.paramKey && v.path === data.path);
                        const type = data.paramValue.type;
                        const value = data.paramValue.value;
                        const paramValTypedIp = listVal.find('input')
                        paramValTypedIp.typedInput({
                            types: [
                                { value: 'bh.input', label: 'bh.input.' },
                                { value: 'bh.local', label: 'bh.local.' },
                                { value: 'str', label: 'string' }
                            ],
                            default: 'str',
                            onvalchanged: function () {
                                if (index > -1)
                                    node.allParamsArray[index].paramValue.value = paramValTypedIp.typedInput('value');
                            },
                            change: function () {
                                if (index > -1)
                                    node.allParamsArray[index].paramValue.type = paramValTypedIp.typedInput('type');
                            }
                        });
                        paramValTypedIp.typedInput('type', type);
                        paramValTypedIp.typedInput('value', value);
                        paramValTypedIp.typedInput('onvalchanged');
                    },
                    scrollOnAdd: false
                });
                const pathparamsMap = $('#path-params-map').typedInput({
                    types: [
                        { value: 'bh', label: 'bh.', validate: SRD.validators.typedInput('bh.input') },
                        { value: 'bh.input', label: 'bh.input.', validate: SRD.validators.typedInput('bh.input') },
                        { value: 'bh.local', label: 'bh.local.', validate: SRD.validators.typedInput('bh.input') },
                    ],
                    noErrorElement: false
                });

                /* Query Params */
                // editable List
                node.tempVarStore = { paramsVariables: [], pathMapParamsVariables: [] };

                /* Creates the qparams editable list section*/
                function decorateAndPopulatePropsSection(sectionName) {
                    /* Properties add section key-value fields */
                    let kvWrp = $(`#${sectionName}-props-section .srd-editableList-add-kv-wrp`);
                    let keyField = $(`#${sectionName}-props-section .property-key`).inputField({
                        placeholder: SRD._('common.label.key'),
                        validatorRegexp: /[^\s]+/
                    });
                    let valueField = $(`#${sectionName}-props-section .property-value`).inputField({
                        placeholder: SRD._('common.label.value')
                    });

                    /* Properties List */
                    let propertiesContainer = $(`#${sectionName}-props-section .properties-container`);
                    let invalidListMsg = $(`#${sectionName}-props-section .list-keys-invalid`).css({ 'visibility': 'hidden' });

                    let propertiesHeaderContainer = $(`<div class="properties-header-container"></div>`).prependTo(propertiesContainer);
                    
                    let headers = $(`
                <div class="header">No.</div>
                <div class="wide-header ">Key</div>
                <div class="wide-header wide-header-output">Value</div>
                `).appendTo(propertiesHeaderContainer);

                    let varArrType = sectionName === 'qparams' ? 'paramsVariables' : '';

                    function updateTempVarStore(prop, val, currentRowIdArr, setRest) {
                        for (let i in node.tempVarStore[varArrType]) {
                            if (currentRowIdArr.includes(node.tempVarStore[varArrType][i]['rowId'])) {
                                node.tempVarStore[varArrType][i][prop] = val;
                                if (setRest === undefined) {
                                    return i;
                                }
                            } else if (setRest !== undefined) {
                                node.tempVarStore[varArrType][i][prop] = setRest;
                            }
                        }
                    }

                    function validateEditableList() {
                        SRD.defaults.validateForm(SRD.validators.editableList(propertiesContainer, propsContent, {
                            checkUniquenessOn: node.tempVarStore[varArrType].map(x => x.key),
                            checkValidityOn: node.tempVarStore[varArrType],
                            errorMsgContainer: invalidListMsg
                        }));
                    }

                    let propsContent = $(`#${sectionName}-properties-content`).data({ valid: true, isUnique: true, isValid: true });
                    propsContent.editableList({
                        addItem: function (container, i, data) {
                            let rowData = data.rowData || {};

                            /* property list's "key" field */
                            let listKey = $(`<input type="text"/>`).appendTo(container).inputField({
                                wrapperAttr: { style: 'width: 40%;' },
                                validatorRegexp: /[^\s]+/,
                                disableDoneIfInvalid: true,
                                inputClassList: "property-key",
                                value: rowData.key || keyField.val(),
                                updations: function (elemData, inputVal) {
                                    let index = updateTempVarStore('key', inputVal, container.data().data.rowData.rowId);
                                    node.tempVarStore[varArrType][index].valid = elemData.valid;
                                    container.data('data', { rowData: node.tempVarStore[varArrType][index] });
                                    validateEditableList();
                                }
                            });

                            /* property list's "defaultValue" field */
                            let listVal = $(`<input type="text"/>`).appendTo(container).inputField({
                                wrapperAttr: { style: 'width: 40%;' },
                                inputClassList: "property-value",
                                value: rowData.defaultValue || valueField.val(),
                                updations: function () {
                                    let index = updateTempVarStore('defaultValue', $(event.target).val(), container.data().data.rowData.rowId);
                                    container.data('data', { rowData: node.tempVarStore[varArrType][index] });

                                }
                            });

                            let dataObj = {
                                key: listKey.val(),
                                defaultValue: listVal.val(),
                                rowId: rowData.rowId || SRD.nodes.id(),
                                valid: true
                            };

                            node.tempVarStore[varArrType].push(dataObj);
                            propertiesContainer.show();
                            container.attr('id', dataObj.rowId).data('data', { rowData: dataObj });
                            $('.property-row .field-floating-placeholder').remove();
                            /* Clear the "Add" Section input fields */
                            keyField.inputField('reset');
                            valueField.inputField('reset');
                            $('.srd-delete-icon').addClass('http-delete-icon')
                        },
                        showAddBtnLabel: false,
                        removable: true,
                        scrollOnAdd: true,
                        removeItem: function (data) {
                            node.tempVarStore[varArrType] = node.tempVarStore[varArrType].filter(vObj => vObj['rowId'] !== data.rowData.rowId);
                            validateEditableList();
                            if (node.tempVarStore[varArrType].length === 0) {
                                $(`#${sectionName}-props-section .properties-container`).hide();
                            }
                        },
                        validator: function () {
                            let keyToValidate = keyField.val();
                            if (!keyToValidate.match(keyField.inputField('option', 'validatorRegexp'))) {
                                SRD.dialogService.openSnackBar('Invalid key. It should contain atleast one character.');
                                return false;
                            }
                            if (node.tempVarStore[varArrType].find(vObj => vObj['key'] === keyToValidate)) {
                                SRD.dialogService.openSnackBar('Duplicate key. This key already exists.');
                                return false
                            }
                            return true;
                        }
                    });
                    $(`#${sectionName}-props-section .add-prop-btn-wrp`).insertAfter(kvWrp);
                }

                $('#qparams-props-section .properties-container').hide();
                decorateAndPopulatePropsSection('qparams');

                const qparamsMap = $('#params-map').typedInput({
                    types: [
                        { value: 'bh', label: 'bh.', validate: SRD.validators.typedInput('bh.input', false) },
                        { value: 'bh.input', label: 'bh.input.', validate: SRD.validators.typedInput('bh.input', false) },
                        { value: 'bh.local', label: 'bh.local.', validate: SRD.validators.typedInput('bh.input', false) },
                    ],
                    onvalchanged: validateForm,
                    change: validateForm,
                    noErrorElement: false
                });

                const resultMapping = $('#navigation-result-mapping-map').typedInput({
                    types: [
                        { value: 'bh', label: 'bh.', validate: SRD.validators.typedInput('bh.input', false) },
                        { value: 'bh.input', label: 'bh.input.', validate: SRD.validators.typedInput('bh.input', false) },
                        { value: 'bh.local', label: 'bh.local.', validate: SRD.validators.typedInput('bh.input', false) },
                    ],
                    onvalchanged: validateForm,
                    change: validateForm,
                    noErrorElement: false
                })

                $('#path-params-section .add-prop-btn-wrp').remove();
                $('.add-prop-btn-wrp').css('margin-left', '0.5em').each(function (i, elem) {
                    $(elem).insertBefore(($(elem).closest($('.srd-editableList-add-kv-wrp'))));
                });
                                                                   
                function toggleBtns(mapBtn) {
                    if (!switchToMapping(mapBtn)) {
                        setTitle(mapBtn, 'Value');
                    } else {
                        setTitle(mapBtn, 'Map');
                    }
                }
                function setTitle(mapBtn, title) {
                    mapBtn.attr('title', title);
                    mapBtn.attr('src', srcs[title]);
                }

                /* Fill in all the existing values and display the corresponding fields */

                const pathToggleBtn = $('#paths-map-button');
                const pathParamsToggleBtn = $('#path-params-map-button');
                const qparamsToggleBtn = $('#params-button-hidden');

                /* Path */
                function setDefaultDropDownPath(path) {
                    if (!path) {
                        if (node.allParamsArray[0] && node.allParamsArray[0].path) {
                            path = node.allParamsArray[0].path;
                        } else {
                            path = computedPaths[0].path;
                        }
                    }
                    pathsDropDown.val(path);
                    pathsDropDown.selectField('change', path);
                }
                if (node.path) {
                    $('#path-map-wrp').hide();
                    pathsDropDown.val(node.path);
                    setTitle(pathToggleBtn, 'Map');

                    /* Path Parameters Section exists only if the path is NOT mapped. */
                    if (node.pathparams && node.pathparams.length) {
                        $('#path-params-map-wrp').hide();
                        setTitle(pathParamsToggleBtn, 'Map');
                        node.pathparams.forEach(v => {
                            pathParamsList.editableList('addItem', { ...v, path: node.path });
                        });
                    } else if (node.pathparamsMap) {
                        setTitle(pathParamsToggleBtn, 'Value');
                        pathparamsMap.typedInput('type', node.pathparamsMap.type);
                        pathparamsMap.typedInput('value', node.pathparamsMap.value);
                        setDefaultDropDownPath(node.path);
                        $('#path-params-section').hide();
                    } else {
                        setDefaultDropDownPath(node.path);
                        if (!pathParamsList.editableList('items').length) {
                            $('#path-params-props-section-container').hide();
                        } else {
                            $('#path-params-props-section-container').show();
                            $('#path-params-map-wrp').hide();
                            $('#path-params-section').show();
                        }
                    }
                } else if (node.pathMap) {
                    setTitle(pathToggleBtn, 'Value');
                    $('#path-select-wrp').hide();

                    pathMap.typedInput('type', node.pathMap.type);
                    pathMap.typedInput('value', node.pathMap.value);

                    setDefaultDropDownPath();
                    switchToMapping(pathParamsToggleBtn) ? $('#path-params-section').hide() : $('#path-params-map-wrp').hide();
                    $('#path-params-props-section-container').hide();

                } else {
                    // Select a default path
                    setTitle(pathToggleBtn, 'Map');
                    $('#path-map-wrp').hide();

                    setTitle(pathParamsToggleBtn, 'Map');
                    setDefaultDropDownPath();
                    $('#path-params-map-wrp').hide();
                    $('#path-params-section').show();
                }

                /* Query params */
                if (node.qparams) {
                    setTitle(qparamsToggleBtn, 'Map');
                    $('#params-map-wrp').hide();
                    if (node.qparamsArray) {
                        node.qparamsArray.forEach(row => {
                            qparams.editableList('addItem', { rowData: row, validator: false })
                        });
                    }
                } else if (node.qparamsMap) {
                    setTitle(qparamsToggleBtn, 'Value');
                    $('#qparams-props-section').hide();
                    qparamsMap.typedInput('type', node.qparamsMap.type);
                    qparamsMap.typedInput('value', node.qparamsMap.value);
                } else {
                    setTitle(qparamsToggleBtn, 'Map');
                    $('#params-map-wrp').hide();
                }

                /* Result Mapping */
                if (node.resultMapping) {
                    resultMapping.typedInput('type', node.resultMapping.type);
                    resultMapping.typedInput('value', node.resultMapping.value);
                }

                /* Attach click event listeners for the map-value toggle buttons */
                pathToggleBtn.click((eventObj) => {
                    toggleBtns(pathToggleBtn);
                    if (switchToMapping(pathToggleBtn)) {
                        $('#path-map-wrp').show();
                        $('#path-select-wrp').hide();
                        $('#path-params-props-section-container').hide();
                    } else {
                        $('#path-map-wrp').hide();
                        $('#path-select-wrp').show();
                        if (pathParamsList.editableList('items').length) {
                            $('#path-params-props-section-container').show();
                        } else {
                            $('#path-params-props-section-container').hide();
                        }
                    }
                    validateForm();
                });
                pathParamsToggleBtn.click((eventObj) => {
                    const pathSelectWrp = $('#path-select-wrp');
                    toggleBtns(pathParamsToggleBtn);
                    if (!switchToMapping(pathParamsToggleBtn)) {
                        $('#path-params-map-wrp').hide();
                        $('#path-params-section').show();
                    } else {
                        $('#path-params-section').hide();
                        $('#path-params-map-wrp').show();
                    }
                    validateForm();
                });
                $('.proxy-map-value-toggle-params').click((eventObj) => {
                    toggleBtns(qparamsToggleBtn);
                    if (switchToMapping(qparamsToggleBtn)) {
                        $('#params-map-wrp').show();
                        $('#qparams-props-section').hide();
                    } else {
                        $('#params-map-wrp').hide();
                        $('#qparams-props-section').show();
                        if (node.tempVarStore.paramsVariables.length !== 0) {
                            $('#qparams-props-section properties-container').show();
                        } else {
                            $('#qparams-props-section properties-container').hide();
                        }
                    }
                    validateForm();
                });
                editPrepareComplete = true;
                validateForm();
            },
            oneditsave: function () {
                const node = this;
                const pathToggleBtn = $('#paths-map-button');
                const pathParamsToggleBtn = $('#path-params-map-button');
                const qparamsToggleBtn = $('#params-button-hidden');
                function mapValFromEditableList(array) {
                    let obj = {};
                    let rmArr = [];
                    array.forEach(kv => {
                        obj[kv['key']] = kv['defaultValue'];
                        rmArr.push({ key: kv.key, defaultValue: kv.defaultValue });
                    });
                    return {
                        obj: Object.keys(obj).length === 0 ? undefined : obj,
                        reverseMapArr: rmArr.length === 0 ? undefined : rmArr
                    }
                }
                function typedIpEVal(elem, type, val) {
                    if (!elem) {
                        return ({
                            type: val ? type : 'str',
                            value: val
                        });
                    } else {
                        val = elem.typedInput('value');
                        return ({
                            type: val ? elem.typedInput('type') : 'str',
                            value: val
                        });
                    }
                }

                if (!switchToMapping(pathToggleBtn)) {
                    delete node.pathMap;
                    node.path = $('#node-select-paths').val();
                    if (!$('#path-params-props-section-container').is(':hidden')) {
                        if (switchToMapping(pathParamsToggleBtn)) {
                            delete node.pathparams;
                            node.pathparamsMap = typedIpEVal($('#path-params-map'))
                        } else if (!switchToMapping(pathParamsToggleBtn)) {
                            delete node.pathparamsMap;
                            node.pathparams = node.allParamsArray.filter(v => v.path === node.path).map(v => ({ paramKey: v.paramKey, paramValue: typedIpEVal(null, v.paramValue.type, v.paramValue.value) }));
                        }
                    } else {
                        delete node.pathparams;
                        delete node.pathparamsMap;
                    }
                } else if (switchToMapping(pathToggleBtn)) {
                    delete node.path;
                    delete node.pathparams;
                    delete node.pathparamsMap;
                    node.pathMap = typedIpEVal($('#path-map'));
                }


                /* Q params */
                if (!switchToMapping(qparamsToggleBtn)) {
                    // get editableList items, assign it to node.qparams
                    delete node.qparamsMap;
                    ({ obj: node.qparams, reverseMapArr: node.qparamsArray } = mapValFromEditableList(node.tempVarStore.paramsVariables));

                } else if (switchToMapping(qparamsToggleBtn)) {
                    delete node.qparams;
                    delete node.qparamsArray;
                    const qparamsMap = $('#params-map');
                    if (qparamsMap.typedInput('value')) {
                        node.qparamsMap = {
                            type: qparamsMap.typedInput('type'),
                            value: qparamsMap.typedInput('value')
                        }
                    } else {
                        delete node.qparamsMap
                    }
                }


                /* Result Mapping */
                const resultMapping = $('#navigation-result-mapping-map');
                if (resultMapping.typedInput('value')) {
                    node.resultMapping = {
                        type: resultMapping.typedInput('type'),
                        value: resultMapping.typedInput('value').trim()
                    }
                } else {
                    delete node.resultMapping
                }
                delete node.tempVarStore;
                delete node.allParamsArray;
            },
            oneditcancel: function () {
                delete this.tempVarStore;
                delete this.allParamsArray;
            },
            docsLink: 'navigation-node'
        }
    });
</script>