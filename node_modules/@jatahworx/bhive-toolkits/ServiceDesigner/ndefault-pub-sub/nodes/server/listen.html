<script
	type="text/x-red"
	data-template-name="Listen"
></script>
<script type="text/javascript">
	registerNode({
		serviceType: 'server',

		nodeType: 'listen',

		nodeDef: {
			color: '#1887b2',
			shape: 'circle',
			category: 'Events',

			defaults: {
				name: { value: '' },
			},
			inputs: 0,
			outputs: 1,

			paletteLabel: 'Listen',

			icon: 'ndefault-pub-sub/listener.svg',

			label: function() {
				return this.name || 'Listen';
			},
			labelStyle: function() {
				return this.name ? 'node_label_italic' : '';
			},
			initdefaults: function(n, S) {
				function handleDependencies(controls, value) {
					if (controls instanceof Array) {
						for (let i = 0; i < controls.length; i++) {
							if (controls[i].action === 'required') {
								if (
									(controls[i].equal &&
										controls[i].equal.to_values.includes(
											value
										)) ||
									(controls[i].notEqual &&
										!controls[
											i
										].notEqual.to_values.includes(value))
								) {
									$('#' + controls[i].id)[controls[i].type](
										'required'
									);
									n._def.defaults[
										controls[i].property
									].required = true;
								} else {
									$('#' + controls[i].id)[controls[i].type](
										'resetRequired'
									);
									n._def.defaults[
										controls[i].property
									].required = false;
								}
							} else if (controls[i].action === 'hidden') {
								if (
									(controls[i].equal &&
										controls[i].equal.to_values.includes(
											value
										)) ||
									(controls[i].notEqual &&
										!controls[
											i
										].notEqual.to_values.includes(value))
								) {
									$('#' + controls[i].id)[controls[i].type](
										'hide'
									);
									$('#' + controls[i].id)
										.closest('.editor-form-row')
										.hide();
									S.defaults.excludeFromValidation(
										n,
										controls[i].property
									);
								} else {
									$('#' + controls[i].id)
										.closest('.editor-form-row')
										.show();
									$('#' + controls[i].id)[controls[i].type](
										'show'
									);
									S.defaults.includeForValidation(
										n,
										controls[i].property
									);
								}
								S.defaults.validateForm(true);
							}
						}
					}
				}
				return Object.assign(this, {
					eventName: {
						attrDef: {
							options: {
								types: [
									{ value: 'str', label: 'string' },
									{
										value: 'process.env',
										label: 'env',
										validate: S.validators.typedInput(
											'env',
											false
										),
									}
								],
								required: true,
							},
							label: 'event Name',
							attrType: 'TYPED_INPUT',
						},
						value: {},
						required: true,
					},
					listenerType: {
						attrDef: {
							options: {
								optionsData: [
									{
										value: 'on',
										displayValue: 'Keep Alive',
										default: true,
									},
									{
										value: 'once',
										displayValue: 'Once',
										default: false,
									},
								],
								required: true,
							},
							label: 'Listener Type',
							attrType: 'SELECT',
						},
						value: 'on',
						required: true,
					},
				});
			},
            docsLink: 'listen'
		},
	});
</script>
