<script type="text/x-red" data-template-name="YML">
    <!-- Source -->
    <div id="node-input-source-in-wrp" class="editor-form-row">
        <label for="node-input-source-in"><span
                data-i18n="common.label.source"></span></label>
        <input type="text" id="node-input-source-in" class="node-input-property" style="width: 100%" />
    </div>
    <!-- Switch -->
    <div class="output-toggle-group padding-top-0">
        <div class="parser-switch-toggle-label">Switch</div>
        <div class="toggle-button">
            <label class="switch">
                <input id="node-input-switch" type="checkbox">
                <span class="slider round"></span>
            </label>
        </div>
    </div>
        
    <!-- resultMapping -->
    <div id="node-input-result-mapping-wrp" class="editor-form-row">
        <label for="node-input-result-mapping"><span
                data-i18n="common.label.result-mapping"></span></label>
        <input type="text" id="node-input-result-mapping" class="node-input-property" style="width: 100%" />
    </div>
   
</script>

<script type="text/javascript">
    registerNode({
        nodeType: 'YML',
        serviceType: 'server',
        nodeDef: {
            color: "#801336",
            category: 'Parser',
            defaults: {
                name: {
                    value: ''
                },
                outputs: {
                    value: 1
                },
                inputMapping: { value: '' , required: true },
                resultMapping: {  },
                switch: { value: ''}
            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-yml/yml-node.svg",
            paletteLabel: function (def) {
                return 'YML';
            },
            label: function () {
                return this.name || 'YML'
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function (SRD) {
                const node = this;
                const doneBtn = $('#node-dialog-ok');
                var commonTypes = [
                    {
                        value: 'bh',
                        label: 'bh.',
                        validate: fieldvalidation, nullable: true, nullableValue: 'undefined'
                    },{
                        value: 'bh.input',
                        label: 'bh.input.',
                        validate: fieldvalidation, nullable: true, nullableValue: 'undefined'
                    },
                    {
                        value: 'bh.local',
                        label: 'bh.local.',
                        validate: fieldvalidation, nullable: true, nullableValue: 'undefined'
                    },
                ]
                const srcTypes = ['bh', 'bh.input', 'bh.local'];

                function fieldvalidation (v) {
                    if (!document.querySelector('input[id="node-input-switch"]').checked) {
                            return /[^\s]+/.test(v);
                        } 
                }
                function validateForm() {
					SRD.defaults.validateForm(true);
                }

                $('#node-input-switch').on('change', function () {
                    if (document.querySelector('input[id="node-input-switch"]').checked) {
                        $('#node-input-result-mapping-wrp').hide();
                    } else {
                        $('#node-input-result-mapping-wrp').show();
                        $('#node-input-result-mapping').typedInput('validate');
                    }
                    validateForm();
                });

                const nodeName = $(`#node-input-name`).inputField();

                const source = $('#node-input-source-in').typedInput({
                    types: srcTypes,
                    noformvalidation: false
                }); 

                /* Result Mapping field */
                const resultMapping = $('#node-input-result-mapping').typedInput({
                    types: commonTypes,
                    noformvalidation: false
                });
                

                /* Set values for key and value fields if already exists */
                if (node.resultMapping) {
                    resultMapping.typedInput('type', node.resultMapping.type);
                    resultMapping.typedInput('value', node.resultMapping.value);
                }
                if (node.inputMapping) {
                    source.typedInput('type', node.inputMapping.type);
                    source.typedInput('value', node.inputMapping.value);
                }
                if (node.switch) {
                    document.getElementById('node-input-switch').checked = true;
                    $('#node-input-result-mapping-wrp').hide();
                }
            },
            oneditsave: function () {
                const node = this;
                const resMap = $('#node-input-result-mapping');
                const src = $('#node-input-source-in');
                node.name = $('#node-input-name').val();
                node.inputMapping = { type: src.typedInput('type'), value: src.typedInput('value') };
                node.switch = document.querySelector('input[id="node-input-switch"]').checked;
                if (node.switch) {
                    node.resultMapping = undefined;
                } else {
                    node.resultMapping = { type: resMap.typedInput('type'), value: resMap.typedInput('value') };
                }

            },
            docsLink: 'yml-node'
        }
    });
</script>