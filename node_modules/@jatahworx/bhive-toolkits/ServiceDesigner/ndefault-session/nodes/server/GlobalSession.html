<script type="text/x-red" data-template-name="GlobalSession">
    <!-- Name of the node -->
    <!-- proxy -->
    <div class="output-toggle-group">
        <div class="output-toggle-label">Proxy</div>
        <div class="toggle-button">
            <label class="switch">
                <input type="checkbox" id="node-input-proxy">
                <span class="slider round"></span>
            </label>
        </div>
    </div>

    <!-- resave -->
    <div class="output-toggle-group">
        <div class="output-toggle-label">Resave</div>
        <div class="toggle-button">
            <label class="switch">
                <input type="checkbox" id="node-input-resave">
                <span class="slider round"></span>
            </label>
        </div> 
    </div>

    <!--rolling-->
    <div class="output-toggle-group">
        <div class="output-toggle-label">Rolling</div>
        <div class="toggle-button">
            <label class="switch">
                <input type="checkbox" id="node-input-rolling">
                <span class="slider round"></span>
            </label>
        </div>
    </div>

    <!--saveUninitialized-->
    <div class="output-toggle-group">
        <div class="output-toggle-label">Save Uninitialized</div>
        <div class="toggle-button">
            <label class="switch">
                <input type="checkbox" id="node-input-saveUninitialized">
                <span class="slider round"></span>
            </label>
        </div>
    </div>

    <!-- secret -->
    <div class="editor-form-row">
        <label for="node-input-typed-secret">Secret</label>
        <input type="text" id="node-input-typed-secret" style="width:100%"/>
    </div>
    <!-- unset -->
    <div class="editor-form-row">
        <label for="node-input-unset-select">Unset</label>
        <div class="http-element-container">
            <select id="node-input-unset" class="select-method">
            </select>
            <div class="editor-form-row field-wrapper-typedInput display-none" id="node-input-unset-map-container">
                <input type="text" id="node-input-unset-map" class="node-input-property typed-input-width"
                    style="width: 100% !important" />
                <input type="hidden" id="node-input-outputs" />
            </div>
        </div>
    </div>
    <!-- Type(Button Toggle) -->
    <div id="store-options" class="editor-form-row">
        <label for="radiogroup">Store Type</label>
        <div class="editor-form-row" id="store-type-radio">
            <input type="text" id="node-input-store" style="display:none;">
            <input type="radio" name="optionType" value="db" id="store-db">
            <label for="store-db">Database store</label>
            <input type="radio" name="optionType" value="memory" id="store-memory">
            <label for="store-memory">Memory Store</label>
        </div>
        <!-- DB store optio -->
        <div id="db-store-option" class="db-option-hidden">
            <input type="text" id="node-input-db">
        </div>
    </div>
    <div class="ssd-edit-dialog-cookie-fields-accordion editor-form-row" style="margin-top: 1em;">
        <h3 class="pallete-category-title cursor-pointer ssd-optional-cookie-header">Cookie Options<img src="assets/pallete_icons/arrow_down.svg"></h3>
        <div class="ssd-cookie-fields-container hide">
            <div class="output-toggle-group no-paddding-top">
                    <div class="fit-label editor-form-row-label">Secure</div>
                    <div class="toggle-button">
                        <label class="switch">
                            <input type="checkbox" id="node-input-cookieSecure">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            
            <div class="editor-form-row cookie-domain-container">
                <input type="text" id="node-input-cookieDomain">
            </div>
            <div class="editor-form-row">
                <input type="text" id="node-input-cookieExpires">
            </div>
            <!--httponly-->
            <div class="output-toggle-group no-paddding-top no-margin-bottom editor-form-row">
                <div class="fit-label editor-form-row-label">Http Only</div>
                <div class="toggle-button">
                    <label class="switch">
                        <input type="checkbox" id="node-input-cookieHttpOnly">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>

            <div class="editor-form-row">
                <input type="text" id="node-input-cookieMaxAge">
            </div>
            <div class="editor-form-row">
                <input type="text" id="node-input-cookiePath">
            </div>
            <div class="editor-form-row">
                <label for="node-input-cookieSameSite">SameSite</label>
                <select id="node-input-cookieSameSite" class="width-100"></select>
            </div>
        </div>
    </div>
</script>
<script type="text/javascript">
    registerNode({
        nodeType: 'GlobalSession',
        serviceType: 'server',
        nodeDef: {
            color: "#9d8221",
            category: 'Global',
            defaults: {
                name: { value: "" },
                cookieDomain: { value: ''},
                cookieSecure: { value: ''},
                cookieExpires: { value: ''},
                cookieHttpOnly: { value: true},
                cookieMaxAge: { value: ''},
                cookiePath: { value: ''},
                cookieSameSite: { value: ''},
                proxy: {
                    value: false
                },
                resave: {
                    value: false
                },
                rolling: {
                    value: false
                },
                saveUninitialized: {
                    value: false
                },
                secret: {
                    value: '',
                    required: true
                },
                dbConnectionName: {
                    value: ''
                },
                unset: {
                    value: 'keep'
                },
                db: { type: "db-config", required: false, options: { type: 'mssql', dbCategory: 'sql' } },
                store: { value: ''}
            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-session/session-node.svg",
            paletteLabel: function (def) {
                return 'RDBMS Session';
            },
            label: function () {
                return this.name || 'RDBMS Session'
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            onpropertiesvalidated: function (SRD) {
				SRD.defaults.validateForm(true);
            },
            oneditprepare: function (SRD) {
                let selectedStore = $('#node-input-store').val();
                let node = this;
                this.storeChangeFn(selectedStore);
                $('#node-input-cookieDomain').inputField({
                    placeholder: 'Domain',
                    value: node.cookieDomain || ''
                });

                $('#node-input-cookieExpires').inputField({
                    placeholder: 'Expires At',
                    value: node.cookieExpires || ''
                });

                $('#node-input-cookieMaxAge').inputField({
                    placeholder: 'Max Age',
                    value: node.cookieMaxAge || ''
                });

                $('#node-input-cookiePath').inputField({
                    placeholder: 'Path',
                    value: node.cookiePath || ''
                });

                $('#db-store-option').find('select').on('change', e => {
                    if ($('#node-input-store').val() === 'db')
                        this.assignDBFn(e.target.value);
                })

                $('#node-input-cookieSameSite').selectField({
                    value: node.cookieSameSite || '',
                    optionsData: [
                        {
                            value: true,
                            displayValue: true,
                            description: '"true" will set the SameSite attribute to Strict for strict same site enforcement.'
                        },
                        {
                            value: false,
                            displayValue: false,
                            description: '"false" will not set the SameSite attribute.',
                        },
                        {
                            value: '&quot;lax&quot;',
                            displayValue: 'lax',
                            description: '"lax" will set the SameSite attribute to Lax for lax same site enforcement.'
                        },
                        {
                            value: '&quot;none&quot;',
                            displayValue: 'none',
                            description: '"none" will set the SameSite attribute to None for an explicit cross-site cookie.'
                        },
                        {
                            value: '&quot;strict&quot;',
                            displayValue: 'strict',
                            description: '"strict" will set the SameSite attribute to Strict for strict same site enforcement.'
                        }
                    ]
                })

            },
            oneditinit: function(SRD) {
                const node = this;
                const unsetList = [
                    { value: 'keep', displayValue: 'Keep' },
                    { value: 'destroy', displayValue: 'Destroy' }
                ];
                const unsetDropDownElement = $('#node-input-unset').selectField({
                    optionsData: unsetList,
                    value: 'keep'
                });

                let dso = $('#db-store-option');
                function hideDBOption() {
                    dso.addClass('db-option-hidden');
                    dso.removeClass('db-option-visible');
                }

                function showDBOption() {
                    dso.removeClass('db-option-hidden');
                    dso.addClass('db-option-visible');
                }

                function toggleDBOption(store) {
                    if (store === 'db') {
                        showDBOption()
                    } else {
                        hideDBOption();
                    }
                }

                this.assignDBFn = function(dbnodeid) {
                    let db = SRD.nodes.node(dbnodeid);
                        if (db && db.dbOption && db.dbOption.name) {
                            node.dbConnectionName = db.dbOption.name;
                        }
                }


                $('#node-input-typed-secret').typedInput({
                    types: [
                    {
                            value: 'str',
                            label: 'string',
                            validate: /[^\s]+/
                        },
                        {
                            value: 'process.env',
                            label: 'env',
                            validate: SRD.validators.typedInput('env', true)
                        }
					],
					noformvalidation: false
                });

                node.storeChangeFn = function storeChange(store) {
                    if (store) {
                        if (store === 'memory') {
                            $('#store-memory').prop('checked', true);
                            node.dbConnectionName = '';
                        } else {
                            $('#store-db').prop('checked', true);
                            this.assignDBFn($('#db-store-option').find('select').val());
                        }
                        toggleDBOption(store);
                        $('#node-input-store').prop('value', store);
                    } else {
                        $('#store-memory').prop('checked', true);
                        $('node-input-store').prop('value', 'memory');
                        node.dbConnectionName = '';
                    }
                }

                $('#store-memory, #store-db').on('change', (e) => {
                    node.storeChangeFn(e.target.value);
                    SRD.defaults.validateForm(true);
                })

                let acc = $('.ssd-edit-dialog-cookie-fields-accordion');
                    acc
                    .accordion({
                        animate: 100,
                        heightStyle: "content",
                        collapsible: true,
                        header: '.pallete-category-title',
                        icons: {
                        header: 'ui-icon-plus',
                        activeHeader: 'ui-icon-minus'
                        },
                        collapsible: true
                    });

                    // Cookie Options
                    let optionalInView = false;
                    $('.ssd-cookie-fields-container').hide();
                    $('.ssd-optional-cookie-header').on('click', () => {
                        if (optionalInView) {                            
                            $('.ssd-cookie-fields-container').hide();
                        } else {
                            $('.ssd-cookie-fields-container').show();
                        }
                        optionalInView = !optionalInView;
                    });


            },
            oneditsave: function (SRD) {
                const node = this;
            },
            docsLink: 'global-session-node'
        }
    });
</script>