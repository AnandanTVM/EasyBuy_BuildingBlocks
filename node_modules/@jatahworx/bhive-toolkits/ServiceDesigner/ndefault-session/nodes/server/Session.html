<script type="text/x-red" data-template-name="Session">
<div class="editor-form-row">
    <label for="node-input-operationType">Operation Type</label>
    <select id="node-input-operationType" style="width:100%"></select>
</div>

<div class="editor-form-row">
    <label for="node-input-typed-resultMapping">Result Mapping</label>
    <input id="node-input-typed-resultMapping" style="width:100%"/>
</div>

<div class="editor-form-row">
    <label for="node-input-typed-dataMapping">Data Mapping</label>
    <input id="node-input-typed-dataMapping" style="width:100%"/>
</div>
</script>
<script type="text/javascript">
    registerNode({
        nodeType: 'Session',
        serviceType: 'server',
        nodeDef: {
            color: "#c36a2d",
            category: 'HTTP',
            tooltip: 'Session options can be configured in Gloal Session node.',
            defaults: {
                name: {
                    value: ''
                },
                operationType: {
                    value: 'get'
                },
                data: {
                    value: ''
                },
                resultMapping: { value: '' },
                dataMapping: { value: '' }
            },
            inputs: 1,
            outputs: 1,
            icon: "ndefault-session/session-node.svg",
            paletteLabel: function (def) {
                return 'Session';
            },
            label: function (SRD) {
                let label = '';
                if (this.operationType === 'get' && !this.resultMapping) {
                    this.valid = false;
                }
                if (this.name) {
                    label = this.name;
                }
                else if (this.operationType === 'get' && this.resultMapping) {
                    label = 'Session: Get[' + SRD.utils.removeENVPlaceholder(this.resultMapping) + ']';
                } else if (this.operationType === 'update' && this.dataMapping) {
                    label = 'Session: Update[' + SRD.utils.removeENVPlaceholder(this.dataMapping) + ']';
                } else if (this.operationType === 'destroy') {
                    label = 'Session: Destroy';
                }
                return label || 'Session'
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditinit: function (SRD) {
                const node = this;
                node.funcs = {};
                node.funcs.validateForm = function () {
					SRD.defaults.validateForm(true);
                }
                node.funcs.resultMapping = $('#node-input-typed-resultMapping').typedInput({
                    types: ['bh', 'bh.input', 'bh.local'],
					noformvalidation: false
                });
                node.funcs.dataMapping = $('#node-input-typed-dataMapping').typedInput({
                    types: ['bh', 'bh.input', 'bh.local'],
					noformvalidation: false
                });
                $('#node-input-operationType').selectField({
                    placeholder: 'Operation Type',
                    optionsData: [{
                        value: 'get',
                        displayValue: 'Get'
                    },
                    {
                        value: 'update',
                        displayValue: 'Update'
                    },
                    {
                        value: 'destroy',
                        displayValue: 'Destroy'
                    }
                    ],
                    change: (val) => {
                        if (val === 'get') {
                            $(`[for="node-input-typed-resultMapping"]`).show();
                            $(node.funcs.resultMapping).typedInput('show');
                            $(`[for="node-input-typed-dataMapping"]`).hide();
                            $(node.funcs.dataMapping).typedInput('hide');
                        } else if (val === 'update') {
                            $(`[for="node-input-typed-dataMapping"]`).show();
                            $(node.funcs.dataMapping).typedInput('show');
                            $(`[for="node-input-typed-resultMapping"]`).hide();
                            $(node.funcs.resultMapping).typedInput('hide');
                        } else {
                            $(node.funcs.resultMapping).typedInput('hide');
                            $(node.funcs.dataMapping).typedInput('hide');
                            $(`[for="node-input-typed-resultMapping"]`).hide();
                            $(`[for="node-input-typed-dataMapping"]`).hide();
                        }
                        node.funcs.validateForm();
                    }
                });
            },
            docsLink: 'session-node'
        }
    });
</script>